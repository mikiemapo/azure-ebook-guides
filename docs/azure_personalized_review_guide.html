<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Personalized Review: Weak Spot Focus (AZ-104)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Cache busting to force updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="last-modified" content="2025-11-15T21:50:00Z" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        /* Theme Colors - Light Mode */
        --bg-primary: #f0f4f8;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f8f9fa;
        --text-primary: #323130;
        --text-secondary: #605e5c;
        --text-muted: #8a8886;
        --border-color: #d1d1d1;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.16);
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 16px;

        /* Azure Colors */
        --azure-blue: #0078d4;
        --azure-blue-dark: #005a9e;
        --azure-bg-light: #f0f4f8;
        --text-dark: #323130;
        --text-light: #ffffff;
        --card-bg: #ffffff;
        --diagram-bg: #f8f9fa;
        --success-color: #107c10;
        --warning-color: #d83b01;
        --info-color: #005a9e;
        --shadow-color: rgba(0, 0, 0, 0.1);

        /* RAG Color System */
        --rag-red: #dc3545;
        --rag-red-bg: #f8d7da;
        --rag-amber: #fd7e14;
        --rag-amber-bg: #fff3cd;
        --rag-green: #28a745;
        --rag-green-bg: #d4edda;

        /* Personalized Review specific colors */
        --review-main-color: #d83b01;
        --snapshot-card-color: #ff9800;
        --flashcard-card-color: #0078d4;
        --lab-card-color: #4caf50;
        --az104-tip-color: #ffc107;
        --flashcard-reveal-bg: #e6f2ff;
        --flashcard-reveal-border: #0078d4;

        /* Confidence Colors */
        --confidence-weak: #dc3545;
        --confidence-medium: #fd7e14;
        --confidence-strong: #28a745;

        /* Next Steps Section Colors */
        --next-step-bg: #fdfaf5;
        --next-step-border: #ffcc80;
        --next-step-title-color: #d83b01;
      }

      /* Dark Mode Theme */
      [data-theme="dark"] {
        --bg-primary: #1a1d21;
        --bg-secondary: #252a30;
        --bg-tertiary: #2d333b;
        --text-primary: #e6e6e6;
        --text-secondary: #b0b0b0;
        --text-muted: #8b949e;
        --border-color: #444c56;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
        --azure-bg-light: #1a1d21;
        --text-dark: #e6e6e6;
        --card-bg: #252a30;
        --diagram-bg: #2d333b;
        --flashcard-reveal-bg: #1e3a5f;
        --next-step-bg: #2d2a25;
        --next-step-border: #8b6914;
      }

      /* RAG Progress Bar Classes */
      .rag-bar {
        height: 8px;
        border-radius: 4px;
        background: var(--border-color);
        overflow: hidden;
        margin: 8px 0;
      }
      .rag-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.4s ease, background-color 0.3s ease;
      }
      .rag-bar-fill.rag-red { background: var(--rag-red); }
      .rag-bar-fill.rag-amber { background: var(--rag-amber); }
      .rag-bar-fill.rag-green { background: var(--rag-green); }

      .rag-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
      }
      .rag-badge.rag-red { background: var(--rag-red-bg); color: var(--rag-red); }
      .rag-badge.rag-amber { background: var(--rag-amber-bg); color: var(--rag-amber); }
      .rag-badge.rag-green { background: var(--rag-green-bg); color: var(--rag-green); }

      /* Theme Toggle Button */
      .theme-toggle {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 1100;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--azure-blue);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
      }
      .theme-toggle:hover {
        background: var(--azure-blue-dark);
        transform: translateY(-1px);
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--text-dark);
        line-height: 1.6;
        background-color: var(--azure-bg-light);
      }
      .main-container {
        max-width: 900px;
        width: 100%;
      }

      h1 {
        color: var(--review-main-color);
        text-align: center;
        border-bottom: 2px solid var(--snapshot-card-color);
        padding-bottom: 15px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      h1 i {
        margin-right: 10px;
        color: var(--snapshot-card-color);
      }

      .back-to-hub-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto 20px auto;
        padding: 0 20px;
        box-sizing: border-box;
      }
      .back-to-hub {
        padding: 10px;
        background-color: #ffe0b2;
        border-radius: 5px;
        text-align: left;
        border: 1px solid var(--snapshot-card-color);
      }
      .back-to-hub a {
        text-decoration: none;
        color: var(--review-main-color);
        font-weight: bold;
        font-size: 1.1em;
      }
      .back-to-hub a i {
        margin-right: 8px;
      }

      .card-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        width: 100%;
      }
      @media (min-width: 768px) {
        .card-container {
          grid-template-columns: repeat(1, 1fr);
        } /* Single column for readability */
      }

      .card {
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 10px var(--shadow-color);
        overflow: hidden;
        border: 1px solid var(--border-color);
        transition: box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
      }
      .card:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }
      .card-toggle {
        display: none;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        color: var(--text-light);
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid;
      }
      .card-header.snapshot-header {
        background-color: var(--snapshot-card-color);
        border-bottom-color: #e08e00;
      }
      .card-header.snapshot-header:hover {
        background-color: #e08e00;
      }
      .card-header.flashcard-header {
        background-color: var(--flashcard-card-color);
        border-bottom-color: #005fbb;
      }
      .card-header.flashcard-header:hover {
        background-color: #005fbb;
      }
      .card-header.lab-header {
        background-color: var(--lab-card-color);
        border-bottom-color: #388e3c;
      }
      .card-header.lab-header:hover {
        background-color: #388e3c;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.3em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .card-header h2 i {
        font-size: 1.1em;
        opacity: 0.9;
      }
      .card-header .toggle-icon {
        font-size: 1.2em;
        transition: transform 0.3s ease;
      }

      .card-content {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        padding: 0 20px;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-in,
          padding 0.4s ease-out, border-top 0.4s ease-out;
        background-color: var(--card-bg);
        border-top: 0px solid var(--border-color);
        flex-grow: 1;
      }
      .card-toggle:checked + .card-header {
        border-bottom-color: transparent;
      }
      .card-toggle:checked + .card-header .toggle-icon {
        transform: rotate(180deg);
      }
      .card-toggle:checked ~ .card-content {
        max-height: 2500px;
        opacity: 1;
        padding: 20px;
        border-top: 1px solid var(--border-color);
        overflow-y: auto;
      }

      .card-content h3 {
        color: var(--azure-blue-dark);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.2em;
        font-weight: 600;
        border-bottom: 1px dashed #eee;
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card-content h3 i {
        font-size: 1em;
        color: var(--azure-blue-dark);
      }
      .card-content p {
        font-size: 0.95em;
        margin-bottom: 12px;
      }
      .card-content ul {
        font-size: 0.95em;
        padding-left: 0;
        margin-top: 5px;
        margin-bottom: 15px;
        list-style: none;
      }

      .review-item-list {
        list-style: none;
        padding: 0;
      }
      /* Styling for the clickable flashcard item itself */
      .review-item-list li.flashcard-item,
      .review-item-list li.lab-item {
        /* Also apply to lab items */
        margin-bottom: 10px; /* More space between items */
        padding: 10px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: #f9f9f9;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        cursor: pointer; /* Make the whole li clickable */
        display: flex;
        align-items: flex-start; /* Align checkbox to top of text */
        flex-wrap: wrap; /* Allow tags to wrap */
      }
      .review-item-list li.flashcard-item:hover,
      .review-item-list li.lab-item:hover {
        background-color: #f0f0f0;
        border-color: #cce4ff; /* Light blue hover border */
      }
      .review-item-list li.flashcard-item.active,
      .review-item-list li.lab-item.active {
        /* When content is revealed */
        border-color: var(--flashcard-reveal-border);
        background-color: var(--flashcard-reveal-bg);
      }
      .review-item-list input[type="checkbox"] {
        margin-right: 12px;
        transform: scale(1.1);
        accent-color: var(--review-main-color);
        flex-shrink: 0; /* Prevent checkbox from shrinking */
      }
      .review-item-list span.item-text {
        flex-grow: 1;
        color: #333;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        /* Makes the topic name look clickable */
      }
      .review-item-list span.item-tag {
        background-color: #e6f2ff;
        color: #005a9e;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        margin-left: 10px;
        white-space: nowrap; /* Prevent tags from breaking */
      }
      /* Confidence level styling */
      .review-item-list select.confidence-select {
        margin-left: 10px;
        padding: 3px 5px;
        border-radius: 3px;
        border: 1px solid #ccc;
        font-size: 0.85em;
        cursor: pointer;
        background-color: #fff;
        flex-shrink: 0; /* Prevent dropdown from shrinking */
        min-width: 120px; /* Give it a decent width */
        text-align: center;
      }
      .review-item-list select.confidence-select.none {
        background-color: #f0f0f0;
        border-color: #ccc;
        color: #606060;
      }
      .review-item-list select.confidence-select.weak {
        background-color: #f8d7da;
        border-color: var(--confidence-weak);
        color: var(--confidence-weak);
      }
      .review-item-list select.confidence-select.medium {
        background-color: #fff3cd;
        border-color: var(--confidence-medium);
        color: #856404;
      }
      .review-item-list select.confidence-select.strong {
        background-color: #d4edda;
        border-color: var(--confidence-strong);
        color: var(--confidence-strong);
      }

      .review-item-list li.reviewed {
        background-color: #e8f5e9;
        border-left: 5px solid var(--success-color);
        opacity: 0.8;
      }
      /* Lab section grouping and highlight for quick navigation */
      .lab-section-header {
        background: #f1f7ee;
        padding: 8px 12px;
        margin: 8px 0 6px 0;
        border-radius: 4px;
        font-weight: 700;
        color: #2e6b2e;
        border: 1px solid #e0efe0;
      }
      .lab-section-list {
        list-style: none;
        padding-left: 8px;
        margin: 6px 0 14px 0;
      }

      /* Accordion System */
      .accordion-section {
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        overflow: hidden;
        background: var(--bg-secondary);
        box-shadow: var(--shadow-sm);
      }
      .accordion-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 18px;
        background: var(--bg-tertiary);
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
        border-bottom: 1px solid transparent;
      }
      .accordion-header:hover {
        background: var(--border-color);
      }
      .accordion-header.open {
        border-bottom: 1px solid var(--border-color);
      }
      .accordion-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 1em;
        color: var(--text-primary);
      }
      .accordion-title i {
        color: var(--azure-blue);
      }
      .accordion-meta {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.85em;
        color: var(--text-secondary);
      }
      .accordion-chevron {
        transition: transform 0.3s ease;
        color: var(--text-muted);
      }
      .accordion-header.open .accordion-chevron {
        transform: rotate(180deg);
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out, padding 0.3s ease;
        padding: 0 18px;
      }

      /* Sticky Jump Menu */
      .sticky-jump-menu {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1200;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        box-shadow: var(--shadow-md);
        padding: 8px 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
        flex-wrap: wrap;
      }
      .sticky-jump-menu.visible {
        transform: translateY(0);
      }
      .sticky-jump-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 6px 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 12px;
        color: var(--text-primary);
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .sticky-jump-btn:hover {
        background: var(--azure-blue);
        color: #fff;
        border-color: var(--azure-blue);
      }
      .sticky-jump-btn i {
        font-size: 11px;
      }
      @media (max-width: 768px) {
        .sticky-jump-menu {
          gap: 4px;
          padding: 6px 10px;
        }
        .sticky-jump-btn {
          padding: 5px 8px;
          font-size: 11px;
        }
        .sticky-jump-btn span {
          display: none;
        }
      }
      .accordion-content.open {
        max-height: 5000px;
        padding: 18px;
        overflow: visible;
      }
      .accordion-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
      }
      .accordion-badge.red { background: var(--rag-red-bg); color: var(--rag-red); }
      .accordion-badge.amber { background: var(--rag-amber-bg); color: var(--rag-amber); }
      .accordion-badge.green { background: var(--rag-green-bg); color: var(--rag-green); }
      .lab-highlight {
        animation: lab-highlight-pulse 2s ease-in-out 0s 2;
        border: 2px solid #ffcc33;
        box-shadow: 0 4px 14px rgba(255, 204, 51, 0.25);
        background-color: #fffbe6 !important;
      }
      @keyframes lab-highlight-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.01); }
        100% { transform: scale(1); }
      }
      /* Brief highlight when a flashcard is revealed via Next Steps */
      .flashcard-open-highlight {
        animation: flashcard-open-pulse 1.2s ease-in-out 0s 1;
        box-shadow: 0 8px 20px rgba(0,122,204,0.12);
        border: 1px solid rgba(0,122,204,0.25) !important;
        background-color: rgba(230,242,255,0.9) !important;
      }
      @keyframes flashcard-open-pulse {
        0% { transform: translateY(0); }
        30% { transform: translateY(-4px); }
        100% { transform: translateY(0); }
      }
      .review-item-list li.reviewed span.item-text {
        text-decoration: line-through;
        color: #606060;
      }

      /* Flashcard Content Area */
      .flashcard-content-area {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-in;
        margin-top: 10px;
        padding: 15px;
        border-top: 1px solid var(--flashcard-reveal-border);
        background-color: var(--flashcard-reveal-bg);
        border-radius: 0 0 4px 4px; /* Rounded bottom corners */
        width: 100%;
        box-sizing: border-box; /* Include padding in width */
      }
      .flashcard-content-area.show {
        max-height: 3000px; /* increased to fully display all domains */
        overflow-y: auto;   /* ensures scroll if needed */
        padding: 20px;
        opacity: 1;
      }
      .az104-tip {
        position: relative;
        z-index: 1; /* prevents covering text */
      }
      .flashcard-content-area h4 {
        color: var(--azure-blue-dark);
        font-size: 1em;
        margin-top: 0;
        margin-bottom: 8px;
        padding-bottom: 3px;
        border-bottom: 1px dotted #a0c3e0; /* Lighter dotted border */
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .flashcard-content-area h4 i {
        color: var(--flashcard-reveal-border);
        font-size: 0.9em;
      }
      .flashcard-content-area ul {
        list-style: disc; /* Regular bullet points */
        padding-left: 20px;
        margin-top: 5px;
        font-size: 0.9em;
      }
      .flashcard-content-area ul li {
        margin-bottom: 5px;
        padding-left: 0; /* Remove extra padding from global li rule */
        position: static; /* Remove absolute positioning from global li rule */
      }
      .flashcard-content-area ul li i.fa-li {
        /* Override fa-li icon if present */
        display: none;
      }
      .flashcard-content-area strong {
        color: var(--flashcard-card-color);
      }
      .flashcard-content-area .mnemonic-internal {
        background-color: #e3f2fd; /* Even lighter blue */
        border-left: 3px solid #0078d4;
        padding: 8px 12px;
        margin: 10px 0;
        font-size: 0.9em;
        font-weight: bold;
        color: #004578;
      }
      .flashcard-content-area .mnemonic-internal i {
        margin-right: 5px;
        color: #0078d4;
      }

      .domain-progress-row {
        display: flex;
        align-items: center;
        margin-top: 10px;
        font-size: 0.9em;
      }
      .domain-progress-row .domain-icon {
        margin-right: 8px;
        font-size: 1.1em;
        width: 20px; /* Fixed width for icons */
        text-align: center;
      }
      .domain-progress-row .progress-meter {
        /* Adjust for inline display */
        flex-grow: 1;
        margin-right: 10px;
        height: 20px; /* Fixed height for progress bar container */
        background-color: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        display: flex;
        align-items: center;
      }
      .domain-progress-row .progress-meter .progress-bar {
        height: 100%;
        background-color: #ccc;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 5px;
        color: var(--text-light);
        font-weight: 600;
        transition: width 0.4s ease-in-out, background-color 0.4s ease-in-out;
        font-size: 0.8em;
        border-radius: 3px;
      }
      /* RAG Color System: Red (0-50%), Amber (51-75%), Green (76-100%) */
      .domain-progress-row .progress-meter .progress-bar.rag-green {
        background-color: var(--rag-green);
      }
      .domain-progress-row .progress-meter .progress-bar.rag-amber {
        background-color: var(--rag-amber);
      }
      .domain-progress-row .progress-meter .progress-bar.rag-red {
        background-color: var(--rag-red);
      }
      /* Legacy classes mapped to RAG */
      .domain-progress-row .progress-meter .progress-bar.strong {
        background-color: var(--rag-green);
      }
      .domain-progress-row .progress-meter .progress-bar.medium {
        background-color: var(--rag-amber);
      }
      .domain-progress-row .progress-meter .progress-bar.weak {
        background-color: var(--rag-red);
      }

      .domain-progress-row .domain-percentage-text {
        /* Textual percentage display */
        width: 40px; /* Fixed width */
        text-align: right;
        font-weight: bold;
        color: var(--azure-blue-dark);
        margin-left: 8px;
      }

      /* Next Steps Tracker Styling */
      .next-steps-tracker {
        background-color: var(--next-step-bg);
        border: 1px solid var(--next-step-border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        text-align: center;
      }
      .next-steps-tracker h3 {
        color: var(--next-step-title-color);
        font-size: 1.3em;
        margin-top: 0;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--next-step-border);
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .next-steps-tracker .tracker-content {
        text-align: left;
        padding: 10px 0;
        font-size: 1em;
      }
      .next-steps-tracker .tracker-section {
        margin-bottom: 10px;
      }
      .next-steps-tracker .tracker-section strong {
        display: block;
        margin-bottom: 5px;
        color: var(--azure-blue-dark);
        font-size: 1.05em;
      }
      .next-steps-tracker .tracker-item {
        background-color: #f0f4f8;
        border: 1px solid #d1d1d1;
        padding: 8px 12px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
      }
      .next-steps-tracker .tracker-item.missing {
        color: #d83b01;
        font-style: italic;
      }
      .next-steps-tracker .tracker-item i {
        font-size: 1.1em;
        color: var(--review-main-color);
      }
      .next-steps-tracker .tracker-item span.title {
        flex-grow: 1;
        font-weight: 500;
      }
      .next-steps-tracker .tracker-item a {
        color: var(--flashcard-card-color);
        text-decoration: none;
        font-weight: bold;
      }
      .next-steps-tracker .tracker-item a:hover {
        text-decoration: underline;
      }

      /* Enhanced Next Steps Hero Section */
      .next-step-hero {
        background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
        color: white;
        border-radius: 12px;
        padding: 20px 24px;
        margin-bottom: 20px;
        text-align: center;
      }
      .next-step-hero .focus-label {
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.85;
        margin-bottom: 6px;
      }
      .next-step-hero .domain-focus {
        font-size: 1.5em;
        font-weight: 700;
        margin-bottom: 4px;
      }
      .next-step-hero .mastery-badge {
        display: inline-block;
        background: rgba(255,255,255,0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        margin-top: 8px;
      }
      .next-step-hero .priority-reason {
        font-size: 0.85em;
        opacity: 0.9;
        margin-top: 10px;
        font-style: italic;
      }
      .next-step-hero.rag-red { background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%); }
      .next-step-hero.rag-amber { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
      .next-step-hero.rag-green { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }

      /* Study Stats Card */
      .study-stats-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
      }
      .study-stats-card h4 {
        margin: 0 0 12px 0;
        font-size: 0.95em;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .study-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }
      .study-stat {
        text-align: center;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
      }
      .study-stat .stat-value {
        font-size: 1.4em;
        font-weight: 700;
        color: var(--azure-blue);
      }
      .study-stat .stat-label {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-top: 4px;
      }
      .study-stat.highlight .stat-value { color: #28a745; }
      .study-stat.warning .stat-value { color: #f59e0b; }
      .study-stat.danger .stat-value { color: #dc3545; }

      /* Exam Readiness Card */
      .exam-readiness-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
      }
      [data-theme="dark"] .exam-readiness-card {
        background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
      }
      .exam-readiness-card .readiness-title {
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        margin-bottom: 10px;
      }
      .exam-readiness-card .target-date {
        font-size: 1.6em;
        font-weight: 700;
        color: var(--azure-blue);
        margin-bottom: 8px;
      }
      .exam-readiness-card .target-note {
        font-size: 0.85em;
        color: var(--text-secondary);
      }
      .exam-readiness-card .progress-summary {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
        font-size: 0.9em;
      }
    </style>
  <script src="api-config.js"></script>
  <script src="shared-navbar.js"></script>
</head>
  <body>
    <!-- Sticky Jump Menu (hidden until scroll) -->
    <nav id="sticky-jump-menu" class="sticky-jump-menu">
      <a href="#priority-dashboard" class="sticky-jump-btn"><i class="fas fa-bullseye" style="color:#d83b01;"></i><span>Top</span></a>
      <a href="#next-steps-section" class="sticky-jump-btn"><i class="fas fa-arrow-circle-right" style="color:#d83b01;"></i><span>Next</span></a>
      <a href="#performance-section" class="sticky-jump-btn"><i class="fas fa-chart-pie" style="color:#ff9800;"></i><span>Stats</span></a>
      <a href="#identities-focused-card" class="sticky-jump-btn"><i class="fas fa-user-shield" style="color:#0078d4;"></i></a>
      <a href="#storage-focused-card" class="sticky-jump-btn"><i class="fas fa-database" style="color:#4caf50;"></i></a>
      <a href="#compute-focused-card" class="sticky-jump-btn"><i class="fas fa-server" style="color:#9c27b0;"></i></a>
      <a href="#networking-focused-card" class="sticky-jump-btn"><i class="fas fa-network-wired" style="color:#00bcd4;"></i></a>
      <a href="#monitoring-focused-card" class="sticky-jump-btn"><i class="fas fa-chart-line" style="color:#ff5722;"></i></a>
    </nav>

    <script>
    (function() {
      const menu = document.getElementById('sticky-jump-menu');
      let ticking = false;
      
      function updateStickyMenu() {
        const scrollY = window.scrollY || window.pageYOffset;
        if (scrollY > 400) {
          menu.classList.add('visible');
          document.body.style.paddingTop = '50px';
        } else {
          menu.classList.remove('visible');
          document.body.style.paddingTop = '0';
        }
        ticking = false;
      }
      
      window.addEventListener('scroll', function() {
        if (!ticking) {
          window.requestAnimationFrame(updateStickyMenu);
          ticking = true;
        }
      });
      
      // Initialize on page load (in case user refreshes mid-scroll)
      updateStickyMenu();
    })();
    </script>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="theme-toggle" title="Toggle dark/light mode">
      <i class="fas fa-moon"></i>
      <span>Dark</span>
    </button>

    <!-- Whizlabs data and merged quiz scores are centralized in the consolidated script below -->
    <div class="back-to-hub-container">
      <div class="back-to-hub">
        <a href="index.html"
          ><i class="fas fa-arrow-left"></i>Back to Study Hub</a
        >
      </div>
    </div>

    <!-- merged quiz scores moved to consolidated script -->
    <div class="main-container">
      <!-- Page Status Banner -->
      <div style="background:#e8f4f8;border:1px solid #b3d9e6;color:#004d66;padding:8px;margin-bottom:15px;border-radius:5px;text-align:center;font-size:13px;">
        ðŸ•’ Page loaded: <span id="load-time"></span> | Auto-refresh disabled
      </div>
      
      <script>
      // Show exact load time to prove page is fresh
      document.getElementById('load-time').textContent = new Date().toLocaleTimeString();
      </script>
      
      <h1>
        <i class="fas fa-bullseye"></i>Personalized Review: Weak Spot Focus
      </h1>

      <!-- SIMPLIFIED PRIORITY DASHBOARD -->
      <div id="priority-dashboard" style="background:linear-gradient(135deg, #d83b01 0%, #ff6f00 100%);border-radius:12px;padding:24px;margin-bottom:25px;box-shadow:0 4px 16px rgba(216,59,1,0.3);color:#fff;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;">
          <div style="flex:1;min-width:200px;">
            <div style="font-size:12px;text-transform:uppercase;letter-spacing:1px;opacity:0.9;margin-bottom:4px;">Your #1 Priority</div>
            <h2 id="priority-domain-name" style="margin:0 0 8px 0;font-size:1.8em;font-weight:700;">
              <i class="fas fa-spinner fa-spin"></i> Loading...
            </h2>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
              <span id="priority-score-badge" style="background:rgba(255,255,255,0.2);padding:6px 14px;border-radius:20px;font-size:1.1em;font-weight:600;">--</span>
              <span id="priority-status" style="font-size:0.95em;opacity:0.9;">Calculating...</span>
            </div>
            <div style="font-size:11px;opacity:0.7;margin-top:6px;">
              <i class="fas fa-sync-alt"></i> Auto-rotates when you update scores
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <a id="priority-study-btn" href="#" style="display:inline-flex;align-items:center;gap:8px;background:#fff;color:#d83b01;padding:12px 24px;border-radius:8px;font-weight:600;text-decoration:none;font-size:1em;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:transform 0.2s, box-shadow 0.2s;">
              <i class="fas fa-book-open"></i> Start Studying
            </a>
            <button id="priority-details-toggle" style="background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:0.9em;transition:background 0.2s;">
              <i class="fas fa-chevron-down"></i> See Details
            </button>
          </div>
        </div>
      </div>

      <!-- EXPANDABLE DETAILS SECTION (hidden by default) -->
      <div id="priority-details-panel" style="display:none;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:20px;margin-bottom:25px;box-shadow:var(--shadow-sm);">
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;">
          <!-- All Domains Overview -->
          <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px;border-left:4px solid var(--azure-blue);">
            <h4 style="margin:0 0 12px 0;color:var(--text-primary);font-size:14px;display:flex;align-items:center;gap:8px;">
              <i class="fas fa-chart-bar" style="color:var(--azure-blue);"></i> Domain Overview
            </h4>
            <div id="details-domain-list" style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
              Loading domain scores...
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div style="background:var(--bg-tertiary);padding:16px;border-radius:8px;border-left:4px solid #9c27b0;">
            <h4 style="margin:0 0 12px 0;color:var(--text-primary);font-size:14px;display:flex;align-items:center;gap:8px;">
              <i class="fas fa-bolt" style="color:#9c27b0;"></i> Quick Actions
            </h4>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <a id="details-weakest-link" href="#" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-secondary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:background 0.2s;">
                <i class="fas fa-exclamation-triangle" style="color:#dc3545;"></i> Study Weakest: <span id="weakest-domain-name">--</span>
              </a>
              <a href="#domain-progress-section" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-secondary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:background 0.2s;">
                <i class="fas fa-list" style="color:var(--azure-blue);"></i> View All Domains
              </a>
              <a href="#study-tools-section" style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-secondary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:background 0.2s;">
                <i class="fas fa-tools" style="color:#28a745;"></i> Study Tools
              </a>
            </div>
          </div>
        </div>
      </div>

      <script>
      // Priority Dashboard Logic
      function initPriorityDashboard() {
        const scores = JSON.parse(localStorage.getItem('mergedQuizScores') || '{}');
        const domainGuides = {
          'Identities': 'azure_identities_governance.html',
          'Storage': 'azure_storage_deep_dive.html',
          'Compute': 'azure_compute_vms_deep_dive.html',
          'Networking': 'azure_networking_deep_dive.html',
          'Monitoring': 'azure_monitor_backup_deep_dive.html',
          'App Service & Containers': 'azure_app_service_containers.html'
        };
        
        // Calculate percentages and find weakest
        let weakest = null;
        let weakestPercent = 101;
        const domainData = [];
        
        for (const [domain, data] of Object.entries(scores)) {
          const percent = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
          domainData.push({ domain, correct: data.correct, total: data.total, percent });
          if (percent < weakestPercent) {
            weakestPercent = percent;
            weakest = domain;
          }
        }
        
        // Sort by percent ascending (weakest first)
        domainData.sort((a, b) => a.percent - b.percent);
        
        // Update priority dashboard
        const nameEl = document.getElementById('priority-domain-name');
        const scoreEl = document.getElementById('priority-score-badge');
        const statusEl = document.getElementById('priority-status');
        const btnEl = document.getElementById('priority-study-btn');
        const weakestLinkEl = document.getElementById('details-weakest-link');
        const weakestNameEl = document.getElementById('weakest-domain-name');
        
        if (weakest && nameEl) {
          const data = scores[weakest];
          const percent = Math.round((data.correct / data.total) * 100);
          nameEl.innerHTML = `<i class="fas fa-crosshairs"></i> ${weakest}`;
          scoreEl.textContent = `${percent}% (${data.correct}/${data.total})`;
          
          if (percent < 50) {
            statusEl.textContent = 'Needs immediate attention';
          } else if (percent < 75) {
            statusEl.textContent = 'Building momentum - keep going!';
          } else {
            statusEl.textContent = 'Strong progress!';
          }
          
          btnEl.href = domainGuides[weakest] || '#';
          weakestLinkEl.href = domainGuides[weakest] || '#';
          weakestNameEl.textContent = weakest;
        }
        
        // Populate domain list in details
        const listEl = document.getElementById('details-domain-list');
        if (listEl && domainData.length > 0) {
          listEl.innerHTML = domainData.map(d => {
            const ragClass = d.percent < 50 ? 'color:#dc3545' : d.percent < 75 ? 'color:#fd7e14' : 'color:#28a745';
            return `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border-color);">
              <span>${d.domain}</span>
              <span style="${ragClass};font-weight:600;">${d.percent}%</span>
            </div>`;
          }).join('');
        }
      }
      
      // Toggle details panel
      document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('priority-details-toggle');
        const panel = document.getElementById('priority-details-panel');
        if (toggleBtn && panel) {
          toggleBtn.addEventListener('click', function() {
            const isHidden = panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            toggleBtn.innerHTML = isHidden 
              ? '<i class="fas fa-chevron-up"></i> Hide Details'
              : '<i class="fas fa-chevron-down"></i> See Details';
          });
        }
        
        // Initialize dashboard after a short delay to ensure localStorage is ready
        setTimeout(initPriorityDashboard, 100);
      });
      </script>

      <!-- STUDY WORKFLOW CHECKLIST -->
      <div id="workflow-checklist" style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px;margin-bottom:25px;box-shadow:var(--shadow-sm);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
          <h3 style="margin:0;font-size:1.2em;color:var(--text-primary);display:flex;align-items:center;gap:10px;">
            <i class="fas fa-tasks" style="color:#9c27b0;"></i> Study Workflow Loop
          </h3>
          <div style="display:flex;gap:8px;align-items:center;">
            <span id="workflow-progress" style="font-size:13px;color:var(--text-secondary);">0/11 completed</span>
            <a href="https://www.canva.com/design/DAG9I5NXsAc/YyLqtxeRar5QXHyVjpoUWg/edit" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:#00c4cc;color:#fff;padding:6px 12px;border-radius:6px;text-decoration:none;font-size:12px;font-weight:500;">
              <i class="fab fa-figma"></i> Edit in Canva
            </a>
            <button id="workflow-reset-btn" title="Reset checklist" style="background:#e74c3c;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;">
              <i class="fas fa-redo"></i>
            </button>
          </div>
        </div>
        <div id="workflow-items" style="display:flex;flex-direction:column;gap:8px;">
          <!-- Items rendered by JS -->
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-muted);">
          <i class="fas fa-sync-alt"></i> Loop: Tough Topic â†’ Dual Quiz â†’ Weak Point Extraction â†’ Critique Audio â†’ Anki MCQ â†’ Rotate â†’ Repeat
        </div>
      </div>
      
      <script>
      // Study Workflow Checklist Logic
      (function() {
        const WORKFLOW_STEPS = [
          { id: 1, text: 'Choose one hard topic and open your NotebookLM notebook for it', icon: 'fa-brain' },
          { id: 2, text: 'Take 2 section quizzes (Whizlabs + Tutorials Dojo)', icon: 'fa-clipboard-check' },
          { id: 3, text: 'Paste results â†’ extract weak concepts & blind spots', icon: 'fa-search' },
          { id: 4, text: 'Create a specific new notebook for the domain', icon: 'fa-folder-plus' },
          { id: 5, text: 'Generate an audio lesson in NotebookLM (critique mode)', icon: 'fa-microphone' },
          { id: 6, text: 'Listen repeatedly until the idea clicks', icon: 'fa-headphones' },
          { id: 7, text: 'Convert audio â†’ text and share for review', icon: 'fa-file-alt' },
          { id: 8, text: 'Create 6 Anki MCQ flashcards from notes', icon: 'fa-layer-group' },
          { id: 9, text: 'Rotate sources (Whizlabs â†” Tutorials Dojo)', icon: 'fa-exchange-alt' },
          { id: 10, text: 'Tag cards with AZ-104 objective IDs', icon: 'fa-tags' },
          { id: 11, text: 'Repeat loop for next topic', icon: 'fa-redo' }
        ];
        
        const STORAGE_KEY = 'studyWorkflowChecklist';
        
        function getCheckedItems() {
          try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
          } catch (e) {
            return [];
          }
        }
        
        function saveCheckedItems(items) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        }
        
        function updateProgress() {
          const checked = getCheckedItems();
          const progressEl = document.getElementById('workflow-progress');
          if (progressEl) {
            progressEl.textContent = `${checked.length}/${WORKFLOW_STEPS.length} completed`;
          }
        }
        
        function renderChecklist() {
          const container = document.getElementById('workflow-items');
          if (!container) return;
          
          const checked = getCheckedItems();
          container.innerHTML = '';
          
          WORKFLOW_STEPS.forEach(step => {
            const isChecked = checked.includes(step.id);
            const item = document.createElement('label');
            item.style.cssText = `display:flex;align-items:center;gap:12px;padding:10px 14px;background:${isChecked ? 'var(--rag-green-bg)' : 'var(--bg-tertiary)'};border-radius:8px;cursor:pointer;transition:all 0.2s;border:1px solid ${isChecked ? 'var(--rag-green)' : 'var(--border-color)'};`;
            
            item.innerHTML = `
              <input type="checkbox" ${isChecked ? 'checked' : ''} data-step-id="${step.id}" style="width:18px;height:18px;accent-color:#28a745;cursor:pointer;">
              <i class="fas ${step.icon}" style="color:${isChecked ? '#28a745' : '#9c27b0'};width:20px;text-align:center;"></i>
              <span style="flex:1;font-size:14px;color:var(--text-primary);${isChecked ? 'text-decoration:line-through;opacity:0.7;' : ''}">${step.text}</span>
              <span style="font-size:11px;color:var(--text-muted);">#${step.id}</span>
            `;
            
            const checkbox = item.querySelector('input');
            checkbox.addEventListener('change', function() {
              const stepId = parseInt(this.dataset.stepId);
              let items = getCheckedItems();
              if (this.checked) {
                if (!items.includes(stepId)) items.push(stepId);
              } else {
                items = items.filter(id => id !== stepId);
              }
              saveCheckedItems(items);
              renderChecklist();
            });
            
            container.appendChild(item);
          });
          
          updateProgress();
        }
        
        // Reset button
        document.addEventListener('DOMContentLoaded', function() {
          const resetBtn = document.getElementById('workflow-reset-btn');
          if (resetBtn) {
            resetBtn.addEventListener('click', function() {
              if (confirm('Reset all checklist items? This starts a fresh loop.')) {
                saveCheckedItems([]);
                renderChecklist();
              }
            });
          }
          renderChecklist();
        });
      })();
      </script>

        <!-- Inline saved merged quiz scores (editable by in-page Save) -->
        <script id="merged-quiz-scores-json" type="application/json">
        {
  "Identities": { "correct": 36, "total": 64 },
  "Storage": { "correct": 29, "total": 60 },
  "Compute": { "correct": 24, "total": 59 },
  "Networking": { "correct": 18, "total": 31 },
  "Monitoring": { "correct": 14, "total": 26 },
  "App Service & Containers": { "correct": 1, "total": 5 }
}
        </script>

        <!-- Redesigned Score Editor: Quick Mode + Advanced Toggle -->
        <div id="score-editor" style="position:fixed;right:12px;bottom:12px;z-index:1200;font-family:inherit">
          <button id="score-editor-toggle" title="Open score editor" style="background:#2c3e50;color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer;font-size:14px;font-weight:500;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
            <i class="fas fa-edit"></i> Scores
          </button>
          <div id="score-editor-panel" style="display:none;background:#fff;border:1px solid #ddd;border-radius:10px;padding:0;box-shadow:0 8px 24px rgba(0,0,0,0.15);width:320px;margin-top:8px;overflow:hidden;">
            
            <!-- QUICK MODE (Always Visible) -->
            <div style="padding:16px;background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;">
              <div style="font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
                <i class="fas fa-plus-circle"></i> Add Quiz Score
              </div>
              <select id="score-editor-domain" style="width:100%;padding:10px;border:0;border-radius:6px;font-size:14px;margin-bottom:10px;background:#fff;color:#333;"></select>
              <div style="display:flex;gap:8px;margin-bottom:12px;">
                <input id="score-editor-add-correct" type="number" placeholder="Correct" style="flex:1;padding:10px;border:0;border-radius:6px;font-size:14px;text-align:center;" />
                <span style="color:#fff;font-size:18px;align-self:center;">/</span>
                <input id="score-editor-add-total" type="number" placeholder="Total" style="width:80px;padding:10px;border:0;border-radius:6px;font-size:14px;text-align:center;" />
              </div>
              <button id="score-editor-apply" style="width:100%;background:#27ae60;color:#fff;border:0;padding:12px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:background 0.2s;">
                <i class="fas fa-check"></i> Apply Score
              </button>
            </div>
            
            <!-- Status Message -->
            <div id="score-editor-msg" style="font-size:12px;color:#666;padding:8px 16px;min-height:20px;background:#f8f9fa;border-bottom:1px solid #eee;"></div>
            
            <!-- Last Updated Info -->
            <div id="score-editor-last-updated" style="font-size:11px;color:#666;padding:8px 16px;background:#f8f9fa;display:none;border-bottom:1px solid #eee;">
              <span id="score-editor-stale-badge" style="display:none;background:#f39c12;color:#fff;padding:2px 6px;border-radius:3px;font-size:10px;margin-right:6px;">STALE</span>
              <i class="fas fa-clock" style="margin-right:4px;"></i>
              <span id="score-editor-last-updated-text">Never updated</span>
            </div>
            
            <!-- ADVANCED TOGGLE -->
            <div style="padding:12px 16px;border-bottom:1px solid #eee;">
              <button id="score-editor-advanced-toggle" style="background:none;border:0;color:#666;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;padding:0;">
                <i class="fas fa-cog"></i> Advanced Options <i class="fas fa-chevron-down" id="advanced-chevron"></i>
              </button>
            </div>
            
            <!-- ADVANCED OPTIONS (Hidden by default) -->
            <div id="score-editor-advanced" style="display:none;padding:12px 16px;background:#fafafa;">
              <!-- Source & Quiz Name -->
              <div style="margin-bottom:10px;">
                <label style="font-size:11px;color:#666;display:block;margin-bottom:4px;">Quiz Source</label>
                <select id="score-editor-source" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
                  <option value="">-- Select Source --</option>
                  <option value="Whizlabs">Whizlabs</option>
                  <option value="Tutorials Dojo">Tutorials Dojo</option>
                  <option value="Microsoft Learn">Microsoft Learn</option>
                  <option value="Udemy">Udemy</option>
                  <option value="Practice Test">Practice Test</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div style="margin-bottom:10px;">
                <label style="font-size:11px;color:#666;display:block;margin-bottom:4px;">Quiz Name (optional)</label>
                <input id="score-editor-quiz-name" type="text" placeholder="e.g., Practice Test #3" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;box-sizing:border-box;" />
              </div>
              
              <!-- Blend Setting -->
              <div style="margin-bottom:10px;">
                <label style="font-size:11px;color:#666;display:block;margin-bottom:4px;">
                  Score Blend <button id="blend-tip-btn" title="What is blend?" style="border:0;background:#e0e0e0;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px;color:#555;margin-left:4px;">?</button>
                </label>
                <select id="score-editor-blend" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
                  <option value="0.6">60% quiz / 40% confidence</option>
                  <option value="0.7">70% quiz / 30% confidence</option>
                  <option value="0.5">50% quiz / 50% confidence</option>
                  <option value="0.4">40% quiz / 60% confidence</option>
                </select>
                <div id="blend-tip" style="display:none;font-size:11px;color:#666;margin-top:6px;line-height:1.4;padding:8px;background:#fff;border-radius:4px;border:1px solid #eee;">
                  Blend controls how much weight is given to quiz scores vs self-rated confidence when calculating mastery.
                </div>
              </div>
              
              <!-- Actions Row -->
              <div style="display:flex;gap:8px;margin-bottom:10px;">
                <button id="score-editor-undo" title="Undo last Apply" disabled style="flex:1;background:#f39c12;color:#fff;border:0;padding:8px;border-radius:4px;cursor:pointer;font-size:12px;opacity:0.5;">
                  <i class="fas fa-undo"></i> Undo
                </button>
                <button id="score-editor-save" style="flex:1;background:#3498db;color:#fff;border:0;padding:8px;border-radius:4px;cursor:pointer;font-size:12px;">
                  <i class="fas fa-save"></i> Save
                </button>
              </div>
              
              <!-- Auto-collapse checkbox -->
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px;">
                <input type="checkbox" id="score-editor-autocollapse" style="margin:0;" />
                <label for="score-editor-autocollapse" style="font-size:11px;color:#666;cursor:pointer;">Auto-collapse domains</label>
              </div>
              
              <!-- Cloud Sync Section -->
              <div style="border-top:1px solid #eee;padding-top:10px;margin-bottom:10px;">
                <button id="cloud-sync-toggle" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:0;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:11px;color:#fff;width:100%;font-weight:600;">
                  <i class="fas fa-cloud"></i> Cloud Sync
                </button>
                <div id="cloud-sync-area" style="display:none;margin-top:8px;padding:10px;background:#fff;border-radius:6px;border:1px solid #e0e0e0;">
                  <div id="sync-not-connected" style="text-align:center;">
                    <p style="font-size:11px;color:#666;margin:0 0 10px 0;">Sync your scores across devices</p>
                    <button id="sync-create-id" style="background:#667eea;color:#fff;border:0;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:12px;width:100%;">
                      <i class="fas fa-plus"></i> Create Sync ID
                    </button>
                    <div style="margin-top:10px;padding-top:10px;border-top:1px solid #eee;">
                      <p style="font-size:10px;color:#888;margin:0 0 6px 0;">Or enter existing ID:</p>
                      <input id="sync-existing-id" type="text" placeholder="user_xxxxxxxx-xxxx-xxxx-xxxx" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:10px;box-sizing:border-box;margin-bottom:6px;font-family:monospace;" />
                      <button id="sync-use-existing" style="background:#28a745;color:#fff;border:0;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;width:100%;">
                        <i class="fas fa-link"></i> Connect
                      </button>
                    </div>
                  </div>
                  <div id="sync-connected" style="display:none;">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
                      <i class="fas fa-check-circle" style="color:#28a745;"></i>
                      <span style="font-size:11px;color:#333;font-weight:600;">Connected</span>
                    </div>
                    <div style="font-size:10px;color:#666;margin-bottom:8px;word-break:break-all;font-family:monospace;background:#f5f5f5;padding:6px;border-radius:4px;">
                      <span id="sync-user-id-display"></span>
                      <button id="sync-copy-id" style="background:#e0e0e0;border:0;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:9px;margin-left:4px;" title="Copy ID">
                        <i class="fas fa-copy"></i>
                      </button>
                    </div>
                    <div style="display:flex;gap:6px;">
                      <button id="sync-push" style="flex:1;background:#3498db;color:#fff;border:0;padding:8px;border-radius:4px;cursor:pointer;font-size:11px;">
                        <i class="fas fa-cloud-upload-alt"></i> Push
                      </button>
                      <button id="sync-pull" style="flex:1;background:#27ae60;color:#fff;border:0;padding:8px;border-radius:4px;cursor:pointer;font-size:11px;">
                        <i class="fas fa-cloud-download-alt"></i> Pull
                      </button>
                    </div>
                    <p id="sync-status" style="font-size:10px;color:#666;margin:8px 0 0 0;text-align:center;"></p>
                    <button id="sync-disconnect" style="background:none;border:0;color:#dc3545;cursor:pointer;font-size:10px;margin-top:8px;width:100%;text-align:center;">
                      <i class="fas fa-unlink"></i> Disconnect
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Debug Toggle -->
              <div style="border-top:1px solid #eee;padding-top:10px;">
                <button id="debug-toggle" style="background:#f0f0f0;border:0;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:11px;color:#666;width:100%;">
                  <i class="fas fa-bug"></i> Debug Panel
                </button>
                <div id="debug-area" style="display:none;margin-top:8px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <strong style="font-size:11px;color:#666;">Debug Info</strong>
                    <button id="debug-refresh" style="background:#3498db;color:#fff;border:0;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;">Refresh</button>
                  </div>
                  <div style="max-height:120px;overflow:auto;font-family:monospace;background:#fff;padding:6px;border-radius:4px;border:1px solid #eee;font-size:10px;" id="debug-panel-body">loading...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <script>
        // Advanced toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
          const advToggle = document.getElementById('score-editor-advanced-toggle');
          const advPanel = document.getElementById('score-editor-advanced');
          const advChevron = document.getElementById('advanced-chevron');
          if (advToggle && advPanel) {
            advToggle.addEventListener('click', function() {
              const isHidden = advPanel.style.display === 'none';
              advPanel.style.display = isHidden ? 'block' : 'none';
              advChevron.className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
            });
          }
        });
        </script>

        <!-- Toast / temporary confirmation -->
        <div id="global-toast" style="position:fixed;right:12px;bottom:84px;z-index:1300;display:none;max-width:320px;background:rgba(0,0,0,0.85);color:#fff;padding:10px 12px;border-radius:6px;box-shadow:0 8px 20px rgba(0,0,0,0.3);font-size:13px"></div>

        <!-- Debug panel moved into the Score Editor panel (collapsed by default) -->

  <!-- SECTION NAVIGATION -->
  <div id="section-nav" class="accordion-section" style="margin-bottom:20px;">
    <div class="accordion-header" onclick="toggleAccordion('section-nav-content', this)">
      <div class="accordion-title">
        <i class="fas fa-compass"></i> Quick Navigation
      </div>
      <i class="fas fa-chevron-down accordion-chevron"></i>
    </div>
    <div id="section-nav-content" class="accordion-content">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:10px;">
        <a href="#next-steps-section" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-arrow-circle-right" style="color:#d83b01;"></i> Next Steps
        </a>
        <a href="#source-rotation-section" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-sync-alt" style="color:#9c27b0;"></i> Source Rotation
        </a>
        <a href="#weak-point-extractor-section" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-search-minus" style="color:#dc3545;"></i> Weak Point Extractor
        </a>
        <a href="#az104-objectives-section" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-tasks" style="color:#0078d4;"></i> Exam Objectives
        </a>
        <a href="#cprs-generator-section" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-brain" style="color:#9c27b0;"></i> CPRS Generator
        </a>
        <a href="#performance-section" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-chart-pie" style="color:#ff9800;"></i> Performance
        </a>
        <a href="#identities-focused-card" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-user-shield" style="color:#0078d4;"></i> Identities
        </a>
        <a href="#storage-focused-card" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-database" style="color:#4caf50;"></i> Storage
        </a>
        <a href="#compute-focused-card" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-server" style="color:#9c27b0;"></i> Compute
        </a>
        <a href="#networking-focused-card" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-network-wired" style="color:#00bcd4;"></i> Networking
        </a>
        <a href="#monitoring-focused-card" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-chart-line" style="color:#ff5722;"></i> Monitoring
        </a>
        <a href="#study-tools-section" style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg-tertiary);border-radius:6px;text-decoration:none;color:var(--text-primary);font-size:13px;border:1px solid var(--border-color);transition:all 0.2s;">
          <i class="fas fa-tools" style="color:#607d8b;"></i> Study Tools
        </a>
      </div>
    </div>
  </div>

  <!-- Next Steps Tracker -->
  <div id="next-steps-section" class="accordion-section">
    <div class="accordion-header open" onclick="toggleAccordion('next-steps-content-wrapper', this)">
      <div class="accordion-title">
        <i class="fas fa-arrow-circle-right" style="color:#d83b01;"></i> Your Next Steps
      </div>
      <div class="accordion-meta">
        <span style="color:#28a745;">Always expanded for quick access</span>
      </div>
      <i class="fas fa-chevron-down accordion-chevron"></i>
    </div>
    <div id="next-steps-content-wrapper" class="accordion-content open">
      <div id="next-steps-content" class="tracker-content">
        <!-- Dynamic content will be rendered here -->
      </div>
      <div class="az104-tip" style="margin-top: 15px">
        <i class="fas fa-info-circle"></i>This section guides you to your next
        priority flashcard and lab. Mark items as 'Strong' to progress!
      </div>
    </div>
  </div>

  <!-- SOURCE ROTATION TRACKER -->
  <div id="source-rotation-section" class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion('source-rotation-content', this)">
      <div class="accordion-title">
        <i class="fas fa-sync-alt" style="color:#9c27b0;"></i> Source Rotation Tracker
      </div>
      <div class="accordion-meta">
        <span id="rotation-summary" style="font-size:12px;color:var(--text-muted);">Track study vs test sources</span>
      </div>
      <i class="fas fa-chevron-down accordion-chevron"></i>
    </div>
    <div id="source-rotation-content" class="accordion-content">
      <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">
        <i class="fas fa-lightbulb" style="color:#ffc107;margin-right:6px;"></i>
        <strong>Rotation Rule:</strong> Study with one source, test with another. This prevents memorizing answers.
      </p>
      <div id="source-rotation-grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:12px;">
        <!-- Dynamic content rendered by script -->
      </div>
      <div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px;border:1px solid var(--border-color);">
        <div style="font-size:12px;font-weight:600;color:var(--text-primary);margin-bottom:8px;">
          <i class="fas fa-clock" style="margin-right:6px;color:var(--azure-blue);"></i>Quick Log Session
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <select id="rotation-log-domain" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;min-width:140px;">
            <option value="">Select Domain</option>
            <option value="Identities">Identities</option>
            <option value="Storage">Storage</option>
            <option value="Compute">Compute</option>
            <option value="Networking">Networking</option>
            <option value="Monitoring">Monitoring</option>
            <option value="App Service & Containers">App Service & Containers</option>
          </select>
          <select id="rotation-log-source" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;min-width:140px;">
            <option value="">Select Source</option>
            <option value="Whizlabs">Whizlabs</option>
            <option value="Tutorials Dojo">Tutorials Dojo</option>
            <option value="Microsoft Learn">Microsoft Learn</option>
            <option value="Udemy">Udemy</option>
          </select>
          <select id="rotation-log-type" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;font-size:13px;min-width:100px;">
            <option value="study">Studied</option>
            <option value="test">Tested</option>
          </select>
          <button id="rotation-log-btn" style="padding:8px 16px;background:var(--azure-blue);color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;">
            <i class="fas fa-plus"></i> Log
          </button>
        </div>
        <div id="rotation-log-msg" style="font-size:11px;color:var(--text-muted);margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    const ROTATION_KEY = 'sourceRotationData';
    const SOURCES = ['Whizlabs', 'Tutorials Dojo', 'Microsoft Learn', 'Udemy'];
    const DOMAINS = ['Identities', 'Storage', 'Compute', 'Networking', 'Monitoring', 'App Service & Containers'];
    
    function getRotationData() {
      try {
        return JSON.parse(localStorage.getItem(ROTATION_KEY) || '{}');
      } catch { return {}; }
    }
    
    function saveRotationData(data) {
      localStorage.setItem(ROTATION_KEY, JSON.stringify(data));
    }
    
    function getSuggestion(lastStudy, lastTest) {
      const ALL_SOURCES = ['Whizlabs', 'Tutorials Dojo', 'Microsoft Learn', 'Udemy'];
      
      function getAltSource(source) {
        if (source === 'Whizlabs') return 'Tutorials Dojo';
        if (source === 'Tutorials Dojo') return 'Whizlabs';
        if (source === 'Microsoft Learn') return 'Whizlabs';
        if (source === 'Udemy') return 'Tutorials Dojo';
        return 'Whizlabs';
      }
      
      if (!lastStudy && !lastTest) {
        return { action: 'study', source: 'Whizlabs', reason: 'Start fresh!' };
      }
      if (lastStudy && !lastTest) {
        const alt = getAltSource(lastStudy);
        return { action: 'test', source: alt, reason: `Test with ${alt}` };
      }
      if (!lastStudy && lastTest) {
        const alt = getAltSource(lastTest);
        return { action: 'study', source: alt, reason: `Study with ${alt}` };
      }
      if (lastStudy === lastTest) {
        const alt = getAltSource(lastStudy);
        return { action: 'test', source: alt, reason: 'Rotate sources!' };
      }
      return { action: 'study', source: lastTest, reason: 'Continue rotation' };
    }
    
    function updateRotationSummary(data) {
      const summary = document.getElementById('rotation-summary');
      if (!summary) return;
      
      const domains = Object.keys(data);
      const tracked = domains.filter(d => data[d].lastStudy || data[d].lastTest).length;
      const ready = domains.filter(d => data[d].lastStudy && data[d].lastTest).length;
      
      if (tracked === 0) {
        summary.textContent = 'No sessions logged yet';
        summary.style.color = 'var(--text-muted)';
      } else {
        summary.innerHTML = `<span style="color:#28a745;">${ready}/6 domains rotated</span> Â· ${tracked} tracked`;
      }
    }
    
    function renderRotationGrid() {
      const grid = document.getElementById('source-rotation-grid');
      if (!grid) return;
      
      const data = getRotationData();
      updateRotationSummary(data);
      let html = '';
      
      DOMAINS.forEach(domain => {
        const d = data[domain] || {};
        const lastStudy = d.lastStudy || null;
        const lastTest = d.lastTest || null;
        const suggestion = getSuggestion(lastStudy, lastTest);
        
        const studyBadge = lastStudy 
          ? `<span style="background:#e8f5e9;color:#2e7d32;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:500;">${lastStudy}</span>`
          : `<span style="background:#f5f5f5;color:#999;padding:3px 8px;border-radius:12px;font-size:11px;">None</span>`;
        
        const testBadge = lastTest
          ? `<span style="background:#e3f2fd;color:#1565c0;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:500;">${lastTest}</span>`
          : `<span style="background:#f5f5f5;color:#999;padding:3px 8px;border-radius:12px;font-size:11px;">None</span>`;
        
        const suggestionColor = suggestion.action === 'test' ? '#1565c0' : '#2e7d32';
        const suggestionIcon = suggestion.action === 'test' ? 'fa-clipboard-check' : 'fa-book-reader';
        
        html += `
          <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:14px;">
            <div style="font-weight:600;color:var(--text-primary);margin-bottom:10px;font-size:14px;">${domain}</div>
            <div style="display:flex;gap:16px;margin-bottom:10px;font-size:12px;">
              <div><span style="color:var(--text-muted);">Last Study:</span> ${studyBadge}</div>
              <div><span style="color:var(--text-muted);">Last Test:</span> ${testBadge}</div>
            </div>
            <div style="background:${suggestionColor}15;border:1px solid ${suggestionColor}40;border-radius:6px;padding:8px 10px;display:flex;align-items:center;gap:8px;">
              <i class="fas ${suggestionIcon}" style="color:${suggestionColor};"></i>
              <span style="font-size:12px;color:${suggestionColor};font-weight:500;">
                ${suggestion.action === 'test' ? 'Test' : 'Study'} with <strong>${suggestion.source}</strong>
              </span>
              <span style="font-size:10px;color:var(--text-muted);margin-left:auto;">${suggestion.reason}</span>
            </div>
          </div>
        `;
      });
      
      grid.innerHTML = html;
    }
    
    function logSession() {
      const domain = document.getElementById('rotation-log-domain').value;
      const source = document.getElementById('rotation-log-source').value;
      const type = document.getElementById('rotation-log-type').value;
      const msg = document.getElementById('rotation-log-msg');
      
      if (!domain || !source) {
        msg.textContent = 'Please select domain and source';
        msg.style.color = '#dc3545';
        return;
      }
      
      const data = getRotationData();
      if (!data[domain]) data[domain] = {};
      
      if (type === 'study') {
        data[domain].lastStudy = source;
        data[domain].lastStudyDate = new Date().toISOString();
      } else {
        data[domain].lastTest = source;
        data[domain].lastTestDate = new Date().toISOString();
      }
      
      saveRotationData(data);
      renderRotationGrid();
      updateRotationSummary(data);
      
      msg.textContent = `Logged: ${type === 'study' ? 'Studied' : 'Tested'} ${domain} with ${source}`;
      msg.style.color = '#28a745';
      
      document.getElementById('rotation-log-domain').value = '';
      document.getElementById('rotation-log-source').value = '';
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      renderRotationGrid();
      const logBtn = document.getElementById('rotation-log-btn');
      if (logBtn) logBtn.addEventListener('click', logSession);
    });
  })();
  </script>

  <!-- WEAK POINT EXTRACTOR -->
  <div id="weak-point-extractor-section" class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion('weak-point-extractor-content', this)">
      <div class="accordion-title">
        <i class="fas fa-search-minus" style="color:#dc3545;"></i> Weak Point Extractor
      </div>
      <div class="accordion-meta">
        <span style="font-size:12px;color:var(--text-muted);">Paste quiz review â†’ Get Focus Brief</span>
      </div>
      <i class="fas fa-chevron-down accordion-chevron"></i>
    </div>
    <div id="weak-point-extractor-content" class="accordion-content">
      <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">
        <i class="fas fa-paste" style="color:#9c27b0;margin-right:6px;"></i>
        Paste your wrong answers from quiz review PDFs. The tool extracts key concepts for your NotebookLM session.
      </p>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px;">Paste Quiz Review Content:</label>
        <textarea id="weak-point-input" placeholder="Paste your wrong answers here...&#10;&#10;Example:&#10;Q: Which Azure service provides managed Kubernetes?&#10;Your Answer: Azure Container Instances&#10;Correct: Azure Kubernetes Service (AKS)&#10;Explanation: AKS is a managed Kubernetes service..." style="width:100%;min-height:150px;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;"></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <button id="extract-concepts-btn" style="padding:10px 20px;background:#dc3545;color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;">
          <i class="fas fa-magic"></i> Quick Extract
        </button>
        <button id="ai-extract-btn" style="padding:10px 20px;background:#0078d4;color:#fff;border:0;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;">
          <i class="fas fa-brain"></i> AI Extract (Azure Facts)
        </button>
        <button id="clear-extractor-btn" style="padding:10px 16px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;cursor:pointer;font-size:13px;">
          <i class="fas fa-eraser"></i> Clear
        </button>
      </div>
      <div id="ai-loading" style="display:none;padding:12px;background:#e3f2fd;border:1px solid #2196f3;border-radius:6px;margin-bottom:12px;">
        <i class="fas fa-spinner fa-spin" style="color:#2196f3;margin-right:8px;"></i>
        <span style="color:#1565c0;">Analyzing with AI... This may take a few seconds.</span>
      </div>
      
      <div id="extraction-stats" style="display:none;font-size:12px;color:var(--text-secondary);padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:12px;border:1px solid var(--border-color);"></div>
      
      <div id="focus-brief-output" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h4 style="margin:0;font-size:14px;color:var(--text-primary);">
            <i class="fas fa-clipboard-list" style="color:#28a745;margin-right:6px;"></i>Focus Brief for NotebookLM
          </h4>
          <button id="copy-focus-brief-btn" style="padding:6px 12px;background:#28a745;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;">
            <i class="fas fa-copy"></i> Copy
          </button>
        </div>
        <div id="focus-brief-content" style="background:#f8fff8;border:1px solid #c8e6c9;border-radius:8px;padding:16px;font-size:13px;line-height:1.6;white-space:pre-wrap;"></div>
        <div style="margin-top:12px;padding:10px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:12px;">
          <i class="fas fa-lightbulb" style="color:#856404;margin-right:6px;"></i>
          <strong>Next:</strong> Copy this brief and paste into NotebookLM to generate a critique audio lesson.
        </div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    const azureKeywords = [
      'Azure', 'VM', 'Virtual Machine', 'Storage', 'Blob', 'Container', 'AKS', 'Kubernetes',
      'VNet', 'Virtual Network', 'NSG', 'Network Security Group', 'Load Balancer', 'App Service',
      'Function', 'Logic App', 'Key Vault', 'Monitor', 'Log Analytics', 'Application Insights',
      'RBAC', 'Role', 'Identity', 'Entra', 'Active Directory', 'AD', 'Subscription', 'Resource Group',
      'ARM', 'Template', 'Policy', 'Blueprint', 'Management Group', 'Tenant', 'SKU', 'Tier',
      'Premium', 'Standard', 'Basic', 'Hot', 'Cool', 'Archive', 'Replication', 'LRS', 'ZRS', 'GRS',
      'Endpoint', 'Private Link', 'Service Endpoint', 'Peering', 'Gateway', 'VPN', 'ExpressRoute',
      'Firewall', 'WAF', 'CDN', 'Front Door', 'Traffic Manager', 'DNS', 'Backup', 'Recovery',
      'Snapshot', 'Disk', 'Managed Disk', 'Scale Set', 'Availability Set', 'Zone', 'Region',
      'ACR', 'Container Registry', 'ACI', 'Container Instance', 'Deployment Slot', 'Auto-swap',
      'Defender', 'Security Center', 'Advisor', 'Cost Management', 'Reservation', 'Hybrid Benefit',
      'Kerberos', 'SMB', 'NFS', 'NTFS', 'File Share', 'Queue', 'Table', 'Data Lake',
      'Immutability', 'Soft Delete', 'Versioning', 'Lifecycle', 'Access Tier', 'SAS', 'Access Key'
    ];
    
    function extractConcepts(text) {
      if (!text.trim()) return { concepts: [], wrongAnswers: [], rawText: text, truncated: false };
      
      const lines = text.split('\n').filter(l => l.trim());
      const concepts = new Set();
      const wrongAnswers = [];
      
      let currentQuestion = '';
      let currentWrong = '';
      let currentCorrect = '';
      let currentExplanation = '';
      
      lines.forEach(line => {
        const l = line.trim();
        
        if (/^(Q:|Question:|\d+\.)/i.test(l)) {
          if (currentQuestion || currentWrong || currentCorrect) {
            wrongAnswers.push({ q: currentQuestion || '(Question text not found)', wrong: currentWrong, correct: currentCorrect, explanation: currentExplanation });
          }
          currentQuestion = l.replace(/^(Q:|Question:|\d+\.)\s*/i, '');
          currentWrong = '';
          currentCorrect = '';
          currentExplanation = '';
        } else if (/^(Your Answer:|You answered:|Selected:|Your response:)/i.test(l)) {
          currentWrong = l.replace(/^(Your Answer:|You answered:|Selected:|Your response:)\s*/i, '');
        } else if (/^(Correct:|Correct Answer:|Answer:|Right Answer:)/i.test(l)) {
          currentCorrect = l.replace(/^(Correct:|Correct Answer:|Answer:|Right Answer:)\s*/i, '');
        } else if (/^(Explanation:|Why:|Reason:|Details:)/i.test(l)) {
          currentExplanation = l.replace(/^(Explanation:|Why:|Reason:|Details:)\s*/i, '');
        } else if (currentExplanation) {
          currentExplanation += ' ' + l;
        } else if (!currentQuestion && l.length > 20) {
          currentQuestion = l;
        }
        
        azureKeywords.forEach(kw => {
          const regex = new RegExp('\\b' + kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
          if (regex.test(l)) {
            concepts.add(kw);
          }
        });
      });
      
      if (currentQuestion || currentWrong || currentCorrect) {
        wrongAnswers.push({ q: currentQuestion || '(Question text not found)', wrong: currentWrong, correct: currentCorrect, explanation: currentExplanation });
      }
      
      const conceptsArray = Array.from(concepts);
      const truncated = conceptsArray.length > 50;
      
      return {
        concepts: conceptsArray.slice(0, 50),
        wrongAnswers: wrongAnswers,
        rawText: text,
        truncated: truncated
      };
    }
    
    function generateFocusBrief(extracted) {
      if (!extracted || (!extracted.concepts.length && !extracted.wrongAnswers.length)) {
        return "Could not extract structured concepts. Try pasting raw text - the tool will scan for Azure keywords.\n\nFor best results, include lines like:\nQ: [question]\nYour Answer: [wrong answer]\nCorrect: [correct answer]\nExplanation: [why]\n\nOr just paste any text containing Azure terms!";
      }
      
      let brief = "=== FOCUS BRIEF FOR NOTEBOOKLM ===\n\n";
      
      if (extracted.truncated) {
        brief += "[NOTE: Large input detected - showing top 50 concepts]\n\n";
      }
      
      brief += "I need help understanding these Azure concepts I got wrong on my AZ-104 practice quiz:\n\n";
      
      if (extracted.wrongAnswers.length > 0) {
        brief += `--- WRONG ANSWERS TO REVIEW (${extracted.wrongAnswers.length} found) ---\n\n`;
        extracted.wrongAnswers.forEach((wa, i) => {
          brief += `${i + 1}. QUESTION: ${wa.q}\n`;
          if (wa.wrong) brief += `   MY WRONG ANSWER: ${wa.wrong}\n`;
          if (wa.correct) brief += `   CORRECT ANSWER: ${wa.correct}\n`;
          if (wa.explanation) brief += `   WHY: ${wa.explanation}\n`;
          brief += '\n';
        });
      }
      
      if (extracted.concepts.length > 0) {
        brief += `--- KEY CONCEPTS TO CLARIFY (${extracted.concepts.length} found) ---\n`;
        brief += extracted.concepts.join(', ') + '\n\n';
      }
      
      brief += "--- REQUEST ---\n";
      brief += "Please explain each concept I got wrong in simple terms.\n";
      brief += "Focus on: WHY the correct answer is right and WHY my answer was wrong.\n";
      brief += "Include any mnemonics or patterns that help remember these distinctions.\n";
      
      return brief;
    }
    
    async function callAIExtract(text) {
      const loadingEl = document.getElementById('ai-loading');
      const statsEl = document.getElementById('extraction-stats');
      const output = document.getElementById('focus-brief-output');
      const content = document.getElementById('focus-brief-content');
      
      if (!text.trim()) {
        statsEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color:#dc3545;margin-right:6px;"></i> Please paste some quiz content first.';
        statsEl.style.display = 'block';
        return;
      }
      
      loadingEl.style.display = 'block';
      statsEl.style.display = 'none';
      output.style.display = 'none';
      
      try {
        const apiBase = (window.AZ104_API_CONFIG && window.AZ104_API_CONFIG.baseUrl) || '';
        const response = await fetch(apiBase + '/api/extract-concepts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text })
        });
        
        const data = await response.json();
        loadingEl.style.display = 'none';
        
        if (data.error && !data.fallback) {
          statsEl.innerHTML = `<i class="fas fa-exclamation-circle" style="color:#dc3545;margin-right:6px;"></i> Error: ${data.error}`;
          statsEl.style.display = 'block';
          return;
        }
        
        let brief = "";
        if (data.fallback) {
          brief = "=== FOCUS BRIEF FOR NOTEBOOKLM (Fallback Mode) ===\n\n";
          brief += "Note: AI analysis unavailable - using keyword extraction instead.\n";
          brief += "To enable AI analysis, check your OpenAI API key has credits.\n\n";
        } else {
          brief = "=== AI-POWERED FOCUS BRIEF FOR NOTEBOOKLM ===\n\n";
          brief += "These Azure facts are verified and accurate for the AZ-104 exam:\n\n";
        }
        
        if (data.concepts && data.concepts.length > 0) {
          brief += `--- CPRS ANALYSIS (${data.concepts.length} concepts) ---\n\n`;
          data.concepts.forEach((c, i) => {
            brief += `${i + 1}. ${c.name.toUpperCase()}\n`;
            if (c.foundation) brief += `   FOUNDATION: ${c.foundation}\n`;
            if (c.definition) brief += `   DEFINITION: ${c.definition}\n`;
            if (c.differentiation) brief += `   DIFFERENTIATION: ${c.differentiation}\n`;
            brief += `   FACT: ${c.correct_fact}\n`;
            if (c.why_wrong) brief += `   WHY YOU WERE WRONG: ${c.why_wrong}\n`;
            if (c.compression) brief += `   MEMORY HOOK: ${c.compression}\n`;
            if (c.objective) brief += `   EXAM OBJECTIVE: ${c.objective}\n`;
            brief += '\n';
          });
        }
        
        if (data.summary) {
          brief += "--- SUMMARY ---\n" + data.summary + "\n\n";
        }
        
        if (data.local_concepts && data.local_concepts.length > 0 && data.fallback) {
          brief += `--- DETECTED CONCEPTS (${data.local_concepts.length} found) ---\n`;
          brief += data.local_concepts.join(', ') + '\n\n';
        }
        
        if (data.guide_references && data.guide_references.length > 0) {
          brief += "--- STUDY GUIDE REFERENCES ---\n";
          data.guide_references.forEach(ref => {
            brief += `â€¢ ${ref.concept}: See ${ref.section} (${ref.guide})\n`;
          });
          brief += "\n";
        }
        
        brief += "--- REQUEST ---\n";
        brief += "Please create a critique audio that:\n";
        brief += "1. Explains WHY each of my answers was wrong\n";
        brief += "2. Uses mnemonics or patterns to help me remember\n";
        brief += "3. Quizzes me at the end to confirm understanding\n";
        
        content.textContent = brief;
        output.style.display = 'block';
        
        const conceptCount = data.concepts ? data.concepts.length : (data.local_concepts ? data.local_concepts.length : 0);
        const refCount = data.guide_references ? data.guide_references.length : 0;
        let statsIcon = data.fallback ? 'fa-search' : 'fa-brain';
        let statsColor = data.fallback ? '#ff9800' : '#0078d4';
        let statsLabel = data.fallback ? 'Fallback mode' : 'AI analyzed';
        statsEl.innerHTML = `<i class="fas ${statsIcon}" style="color:${statsColor};margin-right:6px;"></i> ${statsLabel}: ${conceptCount} concepts, ${refCount} guide references`;
        statsEl.style.display = 'block';
        
      } catch (err) {
        loadingEl.style.display = 'none';
        statsEl.innerHTML = `<i class="fas fa-exclamation-circle" style="color:#dc3545;margin-right:6px;"></i> Connection error. Try Quick Extract instead.`;
        statsEl.style.display = 'block';
      }
    }
    
    function initExtractor() {
      const extractBtn = document.getElementById('extract-concepts-btn');
      const aiExtractBtn = document.getElementById('ai-extract-btn');
      const clearBtn = document.getElementById('clear-extractor-btn');
      const copyBtn = document.getElementById('copy-focus-brief-btn');
      const input = document.getElementById('weak-point-input');
      const output = document.getElementById('focus-brief-output');
      const content = document.getElementById('focus-brief-content');
      
      if (extractBtn) {
        extractBtn.addEventListener('click', function() {
          const text = input.value;
          const extracted = extractConcepts(text);
          const brief = generateFocusBrief(extracted);
          
          content.textContent = brief;
          output.style.display = 'block';
          
          const statsEl = document.getElementById('extraction-stats');
          if (statsEl && extracted) {
            const qCount = extracted.wrongAnswers ? extracted.wrongAnswers.length : 0;
            const cCount = extracted.concepts ? extracted.concepts.length : 0;
            let statsHtml = `<i class="fas fa-chart-bar" style="margin-right:6px;"></i> Quick Extract: ${qCount} Q&A pairs, ${cCount} keywords`;
            if (extracted.truncated) {
              statsHtml += ` <span style="background:#fff3cd;color:#856404;padding:2px 6px;border-radius:4px;font-size:11px;margin-left:8px;">TRUNCATED</span>`;
            }
            statsEl.innerHTML = statsHtml;
            statsEl.style.display = 'block';
          }
        });
      }
      
      if (aiExtractBtn) {
        aiExtractBtn.addEventListener('click', function() {
          callAIExtract(input.value);
        });
      }
      
      if (clearBtn) {
        clearBtn.addEventListener('click', function() {
          input.value = '';
          output.style.display = 'none';
          content.textContent = '';
          const statsEl = document.getElementById('extraction-stats');
          if (statsEl) statsEl.style.display = 'none';
          const loadingEl = document.getElementById('ai-loading');
          if (loadingEl) loadingEl.style.display = 'none';
        });
      }
      
      if (copyBtn) {
        copyBtn.addEventListener('click', function() {
          const text = content.textContent;
          navigator.clipboard.writeText(text).then(() => {
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
              copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            }, 2000);
          });
        });
      }
    }
    
    document.addEventListener('DOMContentLoaded', initExtractor);
  })();
  </script>

  <!-- AZ-104 OBJECTIVE REFERENCE -->
  <div id="az104-objectives-section" class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion('az104-objectives-content', this)">
      <div class="accordion-title">
        <i class="fas fa-tasks" style="color:#0078d4;"></i> AZ-104 Exam Objectives
      </div>
      <div class="accordion-meta">
        <span style="font-size:12px;color:var(--text-muted);">Official exam skill areas</span>
      </div>
      <i class="fas fa-chevron-down accordion-chevron"></i>
    </div>
    <div id="az104-objectives-content" class="accordion-content">
      <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">
        <i class="fas fa-info-circle" style="color:var(--azure-blue);margin-right:6px;"></i>
        Official Microsoft AZ-104 exam objectives mapped to study domains. Use these IDs when tagging Anki cards.
      </p>
      <div id="objectives-grid" style="display:grid;gap:12px;">
        
        <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:14px;border-left:4px solid #0078d4;">
          <div style="font-weight:600;color:var(--text-primary);margin-bottom:8px;">
            <span style="background:#0078d4;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-right:8px;">15-20%</span>
            Manage Azure Identities and Governance
          </div>
          <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">1.1</code> Manage Microsoft Entra users and groups</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">1.2</code> Manage access to Azure resources</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">1.3</code> Manage Azure subscriptions and governance</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Maps to: <strong>Identities</strong> domain</div>
        </div>
        
        <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:14px;border-left:4px solid #4caf50;">
          <div style="font-weight:600;color:var(--text-primary);margin-bottom:8px;">
            <span style="background:#4caf50;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-right:8px;">15-20%</span>
            Implement and Manage Storage
          </div>
          <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">2.1</code> Configure access to storage</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">2.2</code> Configure Azure Files and Azure Blob Storage</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">2.3</code> Configure Azure Storage security</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Maps to: <strong>Storage</strong> domain</div>
        </div>
        
        <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:14px;border-left:4px solid #9c27b0;">
          <div style="font-weight:600;color:var(--text-primary);margin-bottom:8px;">
            <span style="background:#9c27b0;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-right:8px;">20-25%</span>
            Deploy and Manage Azure Compute Resources
          </div>
          <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">3.1</code> Automate deployment by using ARM templates or Bicep</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">3.2</code> Create and configure VMs</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">3.3</code> Provision and manage containers</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">3.4</code> Create and configure Azure App Service</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Maps to: <strong>Compute</strong> + <strong>App Service & Containers</strong> domains</div>
        </div>
        
        <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:14px;border-left:4px solid #00bcd4;">
          <div style="font-weight:600;color:var(--text-primary);margin-bottom:8px;">
            <span style="background:#00bcd4;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-right:8px;">20-25%</span>
            Implement and Manage Virtual Networking
          </div>
          <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">4.1</code> Configure virtual networks and subnets</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">4.2</code> Configure secure access to virtual networks</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">4.3</code> Configure load balancing</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">4.4</code> Monitor virtual networks</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Maps to: <strong>Networking</strong> domain</div>
        </div>
        
        <div style="background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:8px;padding:14px;border-left:4px solid #ff5722;">
          <div style="font-weight:600;color:var(--text-primary);margin-bottom:8px;">
            <span style="background:#ff5722;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-right:8px;">10-15%</span>
            Monitor and Maintain Azure Resources
          </div>
          <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">5.1</code> Monitor resources by using Azure Monitor</div>
            <div><code style="background:#e8f4f8;padding:1px 4px;border-radius:3px;">5.2</code> Implement backup and recovery</div>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Maps to: <strong>Monitoring</strong> domain</div>
        </div>
        
      </div>
      <div class="az104-tip" style="margin-top:16px;">
        <i class="fas fa-tags"></i> Use objective codes (e.g., <code>1.2</code>, <code>3.3</code>) when tagging your Anki cards for precise exam alignment.
      </div>
    </div>
  </div>

  <!-- CPRS QUESTION GENERATOR -->
  <div id="cprs-generator-section" class="accordion-section">
    <div class="accordion-header" onclick="toggleAccordion('cprs-generator-content', this)">
      <div class="accordion-title">
        <i class="fas fa-brain" style="color:#9c27b0;"></i> CPRS Question Generator
      </div>
      <div class="accordion-meta">
        <span style="font-size:12px;color:var(--text-muted);">6-step mastery for any concept</span>
      </div>
      <i class="fas fa-chevron-down accordion-chevron"></i>
    </div>
    <div id="cprs-generator-content" class="accordion-content">
      <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">
        <i class="fas fa-graduation-cap" style="color:#9c27b0;margin-right:6px;"></i>
        Enter any Azure concept to generate a complete CPRS (Concept-Pathway Reinforcement System) question set for exam mastery.
      </p>
      
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <input type="text" id="cprs-concept-input" placeholder="e.g., VNet Peering, Azure Policy, Managed Identity..." style="flex:1;min-width:200px;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;background:var(--bg-secondary);color:var(--text-primary);">
        <button id="cprs-generate-btn" style="padding:12px 20px;background:#9c27b0;color:#fff;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;white-space:nowrap;">
          <i class="fas fa-magic"></i> Generate CPRS
        </button>
        <button id="cprs-clear-btn" style="padding:12px 16px;background:#6c757d;color:#fff;border:0;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;white-space:nowrap;" title="Clear input and output">
          <i class="fas fa-eraser"></i> Clear
        </button>
      </div>
      
      <div id="cprs-loading" style="display:none;padding:12px;background:#f3e5f5;border:1px solid #9c27b0;border-radius:6px;margin-bottom:12px;">
        <i class="fas fa-spinner fa-spin" style="color:#9c27b0;margin-right:8px;"></i>
        <span style="color:#6a1b9a;">Generating 6-step CPRS question set... This may take a moment.</span>
      </div>
      
      <div id="cprs-stats" style="display:none;font-size:12px;color:var(--text-secondary);padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:12px;border:1px solid var(--border-color);"></div>
      
      <div id="cprs-output" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
          <h4 style="margin:0;font-size:14px;color:var(--text-primary);">
            <i class="fas fa-list-ol" style="color:#9c27b0;margin-right:6px;"></i>CPRS Question Set
          </h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="cprs-save-library-btn" style="padding:6px 12px;background:#9c27b0;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;">
              <i class="fas fa-save"></i> Save to Library
            </button>
            <button id="cprs-copy-anki-btn" style="padding:6px 12px;background:#ff9800;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;">
              <i class="fas fa-file-csv"></i> Copy for Anki
            </button>
            <button id="cprs-copy-all-btn" style="padding:6px 12px;background:#28a745;color:#fff;border:0;border-radius:4px;cursor:pointer;font-size:12px;">
              <i class="fas fa-copy"></i> Copy All
            </button>
          </div>
        </div>
        <div id="cprs-content" style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;padding:16px;font-size:13px;line-height:1.6;"></div>
      </div>
    </div>
  </div>
  
  <script>
  (function() {
    async function generateCPRS(concept) {
      const loadingEl = document.getElementById('cprs-loading');
      const statsEl = document.getElementById('cprs-stats');
      const outputEl = document.getElementById('cprs-output');
      const contentEl = document.getElementById('cprs-content');
      
      if (!concept.trim()) {
        statsEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color:#dc3545;margin-right:6px;"></i> Please enter an Azure concept.';
        statsEl.style.display = 'block';
        return;
      }
      
      loadingEl.style.display = 'block';
      statsEl.style.display = 'none';
      outputEl.style.display = 'none';
      
      try {
        const apiBase = (window.AZ104_API_CONFIG && window.AZ104_API_CONFIG.baseUrl) || '';
        const response = await fetch(apiBase + '/api/generate-cprs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ concept: concept })
        });
        
        const data = await response.json();
        loadingEl.style.display = 'none';
        
        if (data.error && !data.fallback) {
          statsEl.innerHTML = `<i class="fas fa-exclamation-circle" style="color:#dc3545;margin-right:6px;"></i> Error: ${data.error}`;
          statsEl.style.display = 'block';
          return;
        }
        
        if (data.fallback || !data.questions || data.questions.length === 0) {
          statsEl.innerHTML = `<i class="fas fa-exclamation-circle" style="color:#ff9800;margin-right:6px;"></i> AI unavailable. Add OpenAI credits to generate CPRS content.`;
          statsEl.style.display = 'block';
          return;
        }
        
        let html = '';
        const typeColors = {
          'Foundation': '#0078d4',
          'Definition': '#4caf50', 
          'Differentiation': '#ff9800',
          'Scenario': '#9c27b0',
          'Anti-Confusion': '#dc3545',
          'Compression': '#00bcd4'
        };
        const typeIcons = {
          'Foundation': 'fa-bullseye',
          'Definition': 'fa-book',
          'Differentiation': 'fa-not-equal',
          'Scenario': 'fa-briefcase',
          'Anti-Confusion': 'fa-exclamation-triangle',
          'Compression': 'fa-compress'
        };
        
        data.questions.forEach((q, i) => {
          const color = typeColors[q.type] || '#666';
          const icon = typeIcons[q.type] || 'fa-question';
          html += `<div style="margin-bottom:16px;padding:14px;background:var(--bg-tertiary);border-radius:8px;border-left:4px solid ${color};">`;
          html += `<div style="font-weight:600;color:${color};margin-bottom:10px;font-size:12px;text-transform:uppercase;">`;
          html += `<i class="fas ${icon}" style="margin-right:6px;"></i>Q${i+1}: ${q.type}</div>`;
          
          html += `<div style="font-weight:500;margin-bottom:10px;color:var(--text-primary);font-size:14px;">${q.question}</div>`;
          
          html += '<div style="margin-top:8px;">';
          Object.entries(q.options).forEach(([key, val]) => {
            const isCorrect = q.correct === key;
            html += `<div style="padding:8px 12px;margin:4px 0;background:${isCorrect ? '#e8f5e9' : 'var(--bg-secondary)'};border-radius:4px;border:1px solid ${isCorrect ? '#4caf50' : 'var(--border-color)'};">`;
            html += `<strong>${key}:</strong> ${val}`;
            if (isCorrect) html += ' <i class="fas fa-check" style="color:#4caf50;margin-left:6px;"></i>';
            html += '</div>';
          });
          html += '</div>';
          
          if (q.explanation) {
            html += `<div style="margin-top:10px;padding:8px 12px;background:#e3f2fd;border-radius:4px;color:#1565c0;font-size:12px;">`;
            html += `<i class="fas fa-lightbulb" style="margin-right:6px;"></i><strong>Explanation:</strong> ${q.explanation}</div>`;
          }
          
          html += '</div>';
        });
        
        if (data.objective) {
          html += `<div style="margin-top:12px;padding:10px;background:#fff3cd;border:1px solid #ffc107;border-radius:6px;font-size:12px;">`;
          html += `<i class="fas fa-tag" style="color:#856404;margin-right:6px;"></i> <strong>Exam Objective:</strong> ${data.objective}`;
          html += '</div>';
        }
        
        if (data.guide_references && data.guide_references.length > 0) {
          html += `<div style="margin-top:8px;font-size:12px;color:var(--text-muted);">`;
          html += `<i class="fas fa-book-open" style="margin-right:6px;"></i> Study Guide: `;
          data.guide_references.forEach(ref => {
            html += `<a href="${ref.guide}" style="color:var(--azure-blue);">${ref.section}</a> `;
          });
          html += '</div>';
        }
        
        contentEl.innerHTML = html;
        contentEl.dataset.rawData = JSON.stringify(data);
        outputEl.style.display = 'block';
        
        statsEl.innerHTML = `<i class="fas fa-brain" style="color:#9c27b0;margin-right:6px;"></i> Generated ${data.questions.length} MCQs for "${data.concept}"`;
        statsEl.style.display = 'block';
        
      } catch (err) {
        loadingEl.style.display = 'none';
        statsEl.innerHTML = `<i class="fas fa-exclamation-circle" style="color:#dc3545;margin-right:6px;"></i> Connection error. Please try again.`;
        statsEl.style.display = 'block';
      }
    }
    
    function formatForAnki(data) {
      if (!data || !data.questions) return '';
      let csv = 'Question,A,B,C,D,Correct,Explanation,Tags\n';
      
      data.questions.forEach(q => {
        if (q.options && q.correct) {
          const question = q.question.replace(/"/g, '""');
          const opts = q.options;
          const exp = (q.explanation || '').replace(/"/g, '""');
          const tag = `${data.objective || 'CPRS'},${q.type}`;
          csv += `"${question}","${(opts.A || '').replace(/"/g, '""')}","${(opts.B || '').replace(/"/g, '""')}","${(opts.C || '').replace(/"/g, '""')}","${(opts.D || '').replace(/"/g, '""')}","${q.correct}","${exp}","${tag}"\n`;
        }
      });
      
      return csv;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const genBtn = document.getElementById('cprs-generate-btn');
      const clearBtn = document.getElementById('cprs-clear-btn');
      const input = document.getElementById('cprs-concept-input');
      const copyAllBtn = document.getElementById('cprs-copy-all-btn');
      const copyAnkiBtn = document.getElementById('cprs-copy-anki-btn');
      const saveLibraryBtn = document.getElementById('cprs-save-library-btn');
      const contentEl = document.getElementById('cprs-content');
      const outputEl = document.getElementById('cprs-output');
      const statsEl = document.getElementById('cprs-stats');
      
      if (genBtn) {
        genBtn.addEventListener('click', () => generateCPRS(input.value));
      }
      
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          input.value = '';
          outputEl.style.display = 'none';
          statsEl.style.display = 'none';
          contentEl.innerHTML = '';
          contentEl.dataset.rawData = '';
          input.focus();
        });
      }
      
      if (input) {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') generateCPRS(input.value);
        });
      }
      
      if (copyAllBtn) {
        copyAllBtn.addEventListener('click', () => {
          const text = contentEl.innerText;
          navigator.clipboard.writeText(text).then(() => {
            copyAllBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => { copyAllBtn.innerHTML = '<i class="fas fa-copy"></i> Copy All'; }, 2000);
          });
        });
      }
      
      if (copyAnkiBtn) {
        copyAnkiBtn.addEventListener('click', () => {
          try {
            const data = JSON.parse(contentEl.dataset.rawData || '{}');
            const csv = formatForAnki(data);
            navigator.clipboard.writeText(csv).then(() => {
              copyAnkiBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
              setTimeout(() => { copyAnkiBtn.innerHTML = '<i class="fas fa-file-csv"></i> Copy for Anki'; }, 2000);
            });
          } catch(e) {
            alert('No Anki-compatible content available.');
          }
        });
      }
      
      if (saveLibraryBtn) {
        saveLibraryBtn.addEventListener('click', () => {
          try {
            const rawData = contentEl.dataset.rawData;
            if (!rawData) {
              alert('No CPRS data to save. Generate a question set first.');
              return;
            }
            const data = JSON.parse(rawData);
            const library = JSON.parse(localStorage.getItem('cprsLibrary') || '[]');
            const deckEntry = {
              id: Date.now(),
              concept: data.concept || input.value,
              objective: data.objective || '',
              questionCount: data.questions ? data.questions.length : 0,
              savedAt: new Date().toISOString(),
              data: data
            };
            library.push(deckEntry);
            localStorage.setItem('cprsLibrary', JSON.stringify(library));
            saveLibraryBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            setTimeout(() => { saveLibraryBtn.innerHTML = '<i class="fas fa-save"></i> Save to Library'; }, 2000);
          } catch(e) {
            alert('Failed to save to library.');
          }
        });
      }
    });
  })();
  </script>

  <script>
  function toggleAccordion(contentId, headerEl) {
    const content = document.getElementById(contentId);
    if (!content) return;
    const isOpen = content.classList.contains('open');
    content.classList.toggle('open');
    headerEl.classList.toggle('open');
  }
  </script>
      <!-- Domain progress rendering moved to consolidated script -->

  <!-- Inline lab-module mapping -->
      <script id="lab-module-map" type="application/json">
      {
        "labs": [
          {
            "labId": "lab-001",
            "title": "Create Users, Groups, Assign Roles",
            "modules": ["identity","rbac","users"],
            "domains": ["Identities"],
            "tags": ["rbac","entra","roles"],
            "difficulty": 0.4,
            "estimatedMinutes": 25,
            "priority": 1,
            "section": "1. Manage Azure subscriptions and governance",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-001b",
            "title": "Guest/B2B Invite Flow Lab",
            "modules": ["identity","b2b","guest"],
            "domains": ["Identities"],
            "tags": ["b2b","guest","invites"],
            "difficulty": 0.45,
            "estimatedMinutes": 20,
            "priority": 2,
            "section": "1. Manage Azure subscriptions and governance",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-002",
            "title": "Configure Azure Files Auth & Recovery",
            "modules": ["storage","files","auth"],
            "domains": ["Storage"],
            "tags": ["azure files","entra ds","smb"],
            "difficulty": 0.5,
            "estimatedMinutes": 30,
            "priority": 1,
            "section": "3. Configure Azure Files and Azure Blob Storage",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-002b",
            "title": "Blob Storage Tiering & Snapshots",
            "modules": ["storage","blob","snapshots"],
            "domains": ["Storage"],
            "tags": ["blob","snapshot","tiering"],
            "difficulty": 0.5,
            "estimatedMinutes": 25,
            "priority": 2,
            "section": "3. Configure Azure Files and Azure Blob Storage",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298",
            "challenge": true,
            "challengeId": 1
          },
          {
            "labId": "lab-003",
            "title": "Deploy VM & App Service",
            "modules": ["compute","vm","appservice"],
            "domains": ["Compute"],
            "tags": ["vm","app service","deployment"],
            "difficulty": 0.5,
            "estimatedMinutes": 35,
            "priority": 2,
            "section": "5. Create and configure VMs",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-003b",
            "title": "VM Migration & Disk Snapshot Lab",
            "modules": ["compute","migration","snapshot"],
            "domains": ["Compute"],
            "tags": ["migration","snapshot","disk"],
            "difficulty": 0.6,
            "estimatedMinutes": 40,
            "priority": 3,
            "section": "5. Create and configure VMs",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-004",
            "title": "Configure VNet, Subnets, NSGs",
            "modules": ["networking","vnet","nsg"],
            "domains": ["Networking"],
            "tags": ["vnet","subnet","nsg","peering"],
            "difficulty": 0.6,
            "estimatedMinutes": 40,
            "priority": 1,
            "section": "8. Configure virtual networks",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-004b",
            "title": "Load Balancer & NAT Rules Lab",
            "modules": ["networking","lb","nat"],
            "domains": ["Networking"],
            "tags": ["lb","nat","routing"],
            "difficulty": 0.6,
            "estimatedMinutes": 30,
            "priority": 2,
            "section": "9. Configure load balancing",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298",
            "challenge": true,
            "challengeId": 2
          },
          {
            "labId": "lab-005",
            "title": "Create Alerts and Workbooks",
            "modules": ["monitoring","alerts","workbooks"],
            "domains": ["Monitoring"],
            "tags": ["alerts","log analytics","kql"],
            "difficulty": 0.4,
            "estimatedMinutes": 30,
            "priority": 2,
            "section": "11. Monitor resources by using Azure Monitor",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-005b",
            "title": "KQL Basics & Log Analytics",
            "modules": ["monitoring","kql","logs"],
            "domains": ["Monitoring"],
            "tags": ["kql","log analytics","queries"],
            "difficulty": 0.45,
            "estimatedMinutes": 25,
            "priority": 1,
            "section": "11. Monitor resources by using Azure Monitor",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          }
        ]
      }
      </script>

  <!-- Consolidated script -->
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          // Centralized data (single source of truth)
          const whizlabsData = {
            labs: [
              { domain: "Identities", title: "Create Users, Groups, Assign Roles", completed: true },
              { domain: "Storage", title: "Configure Azure Files Auth & Recovery", completed: false },
              { domain: "Compute", title: "Deploy VM & App Service", completed: true },
              { domain: "Networking", title: "Configure VNet, Subnets, NSGs", completed: false },
              { domain: "Monitoring", title: "Create Alerts and Workbooks", completed: false }
            ]
          };

          // 5 AZ-104 Domains (App Service & Containers merged into Compute)
          const mergedQuizScores = {
            Identities: { correct: 36, total: 64 },
            Storage: { correct: 29, total: 60 },
            Compute: { correct: 25, total: 64 },
            Networking: { correct: 18, total: 31 },
            Monitoring: { correct: 14, total: 26 }
          };
          
          // Migration: Merge "App Service & Containers" scores into Compute
          (function migrateAppServiceToCompute() {
            try {
              const stored = localStorage.getItem('mergedQuizScores');
              if (!stored) return;
              const scores = JSON.parse(stored);
              if (scores['App Service & Containers']) {
                const appService = scores['App Service & Containers'];
                const compute = scores['Compute'] || { correct: 0, total: 0 };
                compute.correct = (compute.correct || 0) + (appService.correct || 0);
                compute.total = (compute.total || 0) + (appService.total || 0);
                scores['Compute'] = compute;
                delete scores['App Service & Containers'];
                localStorage.setItem('mergedQuizScores', JSON.stringify(scores));
                console.log('Migrated App Service & Containers scores into Compute:', scores);
              }
            } catch (e) {
              console.warn('Migration error:', e);
            }
          })();

          // Score loading priority:
          // 1. localStorage (persisted by Apply/Save) - takes precedence
          // 2. Inline JSON script tag (baseline/initial scores)
          // This ensures that Apply/Save changes survive page reloads
          (function loadMergedQuizScores(){
            try {
              // First, try to load from localStorage (user's applied changes)
              const storedRaw = localStorage.getItem('mergedQuizScores');
              if (storedRaw) {
                try {
                  const stored = JSON.parse(storedRaw);
                  if (stored && typeof stored === 'object' && Object.keys(stored).length > 0) {
                    Object.keys(stored).forEach(k => {
                      if (stored[k] && (typeof stored[k].correct !== 'undefined' || typeof stored[k].total !== 'undefined')) {
                        mergedQuizScores[k] = { correct: stored[k].correct || 0, total: stored[k].total || 0 };
                      }
                    });
                    console.log('Loaded mergedQuizScores from localStorage:', mergedQuizScores);
                    return; // Successfully loaded from localStorage, skip inline JSON
                  }
                } catch (parseErr) {
                  console.warn('Failed to parse localStorage mergedQuizScores, falling back to inline JSON', parseErr);
                }
              }
              
              // Fallback: Load from inline JSON script element (baseline scores)
              const el = document.getElementById('merged-quiz-scores-json');
              if (!el || !el.textContent || !el.textContent.trim()) {
                console.warn('No localStorage data and no inline JSON found, using default scores');
                return;
              }
              const payload = JSON.parse(el.textContent);
              if (payload && typeof payload === 'object') {
                Object.keys(payload).forEach(k => {
                  if (payload[k] && (typeof payload[k].correct !== 'undefined' || typeof payload[k].total !== 'undefined')) {
                    mergedQuizScores[k] = { correct: payload[k].correct || 0, total: payload[k].total || 0 };
                  }
                });
                console.log('Loaded mergedQuizScores from inline JSON:', mergedQuizScores);
                // Also persist to localStorage so future loads use this as baseline
                try {
                  localStorage.setItem('mergedQuizScores', JSON.stringify(mergedQuizScores));
                } catch(e) {}
              }
            } catch (e) {
              console.warn('Failed to load mergedQuizScores', e);
            }
          })();

          // Runtime user confidence store (computed from selects). Values 0..1
          const userConfidence = {};
          const CONFIDENCE_VALUE = { none: null, weak: 0.3, medium: 0.6, strong: 0.9 };

          // Compute average confidence for a domain by inspecting selects inside its card
          function computeDomainConfidence(domainKey) {
            const card = document.getElementById(domainCardIdMap[domainKey]);
            if (!card) return null;
            const selects = Array.from(card.querySelectorAll('select.confidence-select'));
            const vals = selects.map(s => (s.value || 'none')).map(v => CONFIDENCE_VALUE[v]).filter(v => v != null);
            if (!vals.length) return null;
            const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
            userConfidence[domainKey] = avg; // store 0..1
            return avg * 100; // return percent
          }

          // Update mergedQuizScores with an adjusted percent that blends quiz-derived percent and user confidence
          function updateMergedQuizScoresFromConfidence() {
            // read blend ratio from the score editor (quizWeight: 0..1). default 0.6
            let quizWeight = 0.6;
            try {
              const sel = document.getElementById('score-editor-blend');
              if (sel && sel.value) quizWeight = parseFloat(sel.value) || 0.6;
            } catch (e) {}
            const confWeight = Math.max(0, Math.min(1, 1 - quizWeight));
            Object.keys(mergedQuizScores).forEach(domain => {
              const data = mergedQuizScores[domain];
              const origPercent = data.total ? (data.correct / data.total) * 100 : 0;
              const userPercent = computeDomainConfidence(domain);
              if (typeof userPercent === 'number') {
                data.adjustedPercent = Math.round((origPercent * quizWeight) + (userPercent * confWeight));
              } else {
                data.adjustedPercent = Math.round(origPercent);
              }
            });
          }

          // --- Persist adjusted percents (debounced) so Next Steps survive close/reopen ---
          const ADJUSTED_KEY = 'mergedQuizAdjusted';
          let _adjustedSaveTimer = null;
          const ADJUSTED_DEBOUNCE_MS = 1200; // aggregate quick changes

          function persistAdjustedNow(source){
            try{
              const adj = {};
              Object.keys(mergedQuizScores).forEach(k => { adj[k] = { adjustedPercent: mergedQuizScores[k].adjustedPercent || Math.round((mergedQuizScores[k].correct||0) / Math.max(1, mergedQuizScores[k].total||1) * 100) }; });
              try{ localStorage.setItem(ADJUSTED_KEY, JSON.stringify(adj)); }catch(e){}
              // also push a compact snapshot into history (non-blocking)
              try{ pushMergedQuizHistory(source || 'autosave'); }catch(e){}
            }catch(e){}
          }

          function schedulePersistAdjusted(source){
            try{
              if (_adjustedSaveTimer) clearTimeout(_adjustedSaveTimer);
              _adjustedSaveTimer = setTimeout(()=>{ persistAdjustedNow(source); _adjustedSaveTimer = null; }, ADJUSTED_DEBOUNCE_MS);
            }catch(e){}
          }

          // Map names used in page cards
          const domainCardIdMap = {
            Identities: "identities-focused-card",
            Storage: "storage-focused-card",
            Compute: "compute-focused-card",
            Networking: "networking-focused-card",
            Monitoring: "monitoring-focused-card",
            "App Service & Containers": "app-service-containers-focused-card"
          };

          const domainNamesMap = {
            Identities: "Manage Azure Identities",
            Storage: "Implement & Manage Storage",
            Compute: "Deploy & Manage Compute",
            Networking: "Configure Virtual Networking",
            Monitoring: "Monitor Azure Resources"
          };

          const domainDisplayNames = {
            Identities: "Identities & Governance",
            Storage: "Storage",
            Compute: "Compute",
            Networking: "Networking",
            Monitoring: "Monitoring"
          };

          // Simple mapping: recommend an Anki deck name per domain.
          // This is a friendly hint only â€” no live Anki integration is performed.
          const domainAnkiDeckMap = {
            Identities: "AZ-104 - Identities (Anki)",
            Storage: "AZ-104 - Storage (Anki)",
            Compute: "AZ-104 - Compute (Anki)",
            Networking: "AZ-104 - Networking (Anki)",
            Monitoring: "AZ-104 - Monitoring (Anki)"
          };

          function getRecommendedAnkiDeck(domainKey){
            return domainAnkiDeckMap[domainKey] || 'AZ-104 - Core (Anki)';
          }

          const domainIcons = {
            Identities: "fa-user-shield",
            Storage: "fa-database",
            Compute: "fa-server",
            Networking: "fa-network-wired",
            Monitoring: "fa-chart-line"
          };

          // Logical study order for AZ-104 domains (when all above 50%)
          const LOGICAL_DOMAIN_ORDER = ['Identities', 'Storage', 'Compute', 'Networking', 'Monitoring'];
          const EXAM_READY_THRESHOLD = 75; // All domains must be >= 75%
          const CONSOLIDATION_DAYS = 7; // Buffer after reaching threshold for retention
          const STALE_THRESHOLD_DAYS = 14; // Domain considered stale after 14 days
          const ROLLING_WINDOW_DAYS = 60; // Use only recent activity for rate calculation
          const SLUMP_MULTIPLIER = 1.5; // If gap > median * this, user is in a study slump

          // --- Calculate study statistics and exam readiness ---
          function getStudyStats() {
            const meta = getDomainMetadata();
            const history = getQuizHistory();
            const domains = Object.keys(domainCardIdMap);
            const now = Date.now();
            
            // Calculate per-domain percents
            const domainPercents = {};
            domains.forEach(domain => {
              const data = mergedQuizScores[domain] || { correct: 0, total: 0 };
              domainPercents[domain] = data.total ? Math.round((data.correct / data.total) * 100) : 0;
            });
            
            // Count domains at different levels
            const domainsBelow50 = domains.filter(d => domainPercents[d] < 50);
            const domainsAbove75 = domains.filter(d => domainPercents[d] >= EXAM_READY_THRESHOLD);
            const allAbove50 = domainsBelow50.length === 0;
            const allAbove75 = domainsAbove75.length === domains.length;
            
            // Calculate per-domain staleness
            const domainStaleness = {};
            domains.forEach(d => {
              const lastUpdated = meta[d]?.lastUpdated ? new Date(meta[d].lastUpdated).getTime() : null;
              if (!lastUpdated) {
                domainStaleness[d] = { stale: true, daysSince: null, status: 'never' };
              } else {
                const daysSince = Math.floor((now - lastUpdated) / (1000 * 60 * 60 * 24));
                domainStaleness[d] = {
                  stale: daysSince > STALE_THRESHOLD_DAYS,
                  daysSince,
                  status: daysSince > STALE_THRESHOLD_DAYS ? 'stale' : 'active'
                };
              }
            });
            const staleDomains = domains.filter(d => domainStaleness[d]?.stale);
            
            // Calculate quiz-taking rate using ROLLING WINDOW (recent activity only)
            let quizRate = 0;
            let avgDaysBetweenUpdates = null;
            let medianInterval = null;
            let studyStatus = 'inactive'; // inactive, slump, cooling, active
            
            // Use ALL history entries for Study Activity (Score Editor saves = study activity)
            // Consolidate by day to avoid inflated rates from multiple saves on same day
            const historyByDay = {};
            history.forEach(h => {
              if (!h.takenAt) return;
              const day = h.takenAt.split('T')[0];
              historyByDay[day] = new Date(h.takenAt).getTime(); // Last timestamp for each day
            });
            const allHistoryDates = Object.values(historyByDay).sort((a, b) => a - b);
            
            // Filter to rolling window (last 60 days)
            const windowStart = now - (ROLLING_WINDOW_DAYS * 24 * 60 * 60 * 1000);
            const recentDates = allHistoryDates.filter(d => d >= windowStart);
            
            // Calculate intervals between quiz attempts
            const intervals = [];
            for (let i = 1; i < allHistoryDates.length; i++) {
              intervals.push((allHistoryDates[i] - allHistoryDates[i - 1]) / (1000 * 60 * 60 * 24));
            }
            
            // Calculate median interval (more robust than average for irregular patterns)
            if (intervals.length > 0) {
              const sorted = [...intervals].sort((a, b) => a - b);
              medianInterval = sorted.length % 2 === 0 
                ? (sorted[sorted.length / 2 - 1] + sorted[sorted.length / 2]) / 2
                : sorted[Math.floor(sorted.length / 2)];
              medianInterval = Math.round(medianInterval * 10) / 10;
            }
            
            // Calculate rate based on recent activity only
            if (recentDates.length >= 2) {
              const firstRecent = recentDates[0];
              const lastRecent = recentDates[recentDates.length - 1];
              const daySpan = Math.max(1, (lastRecent - firstRecent) / (1000 * 60 * 60 * 24));
              quizRate = Math.round((recentDates.length / daySpan) * 7 * 10) / 10;
              avgDaysBetweenUpdates = Math.round(daySpan / (recentDates.length - 1) * 10) / 10;
            } else if (intervals.length > 0) {
              // Fall back to all-time average if no recent activity
              avgDaysBetweenUpdates = medianInterval;
            }
            
            // Calculate days since last QUIZ (from history, not metadata)
            // Use quiz history as the source of truth for actual study activity
            let daysSinceLastQuiz = null;
            if (allHistoryDates.length > 0) {
              const lastQuizTime = allHistoryDates[allHistoryDates.length - 1];
              daysSinceLastQuiz = Math.floor((now - lastQuizTime) / (1000 * 60 * 60 * 24));
            }
            
            // Fall back to metadata only if no quiz history exists
            const lastUpdateDates = domains.map(d => meta[d]?.lastUpdated ? new Date(meta[d].lastUpdated).getTime() : null).filter(Boolean);
            let mostRecentMetaUpdate = lastUpdateDates.length ? Math.max(...lastUpdateDates) : null;
            
            // Use quiz history as primary, metadata as fallback
            const daysSinceLastUpdate = daysSinceLastQuiz !== null ? daysSinceLastQuiz : 
              (mostRecentMetaUpdate ? Math.floor((now - mostRecentMetaUpdate) / (1000 * 60 * 60 * 24)) : null);
            
            // Determine study status (active, cooling, slump, inactive)
            // More aggressive slump detection: 14+ days = paused
            if (daysSinceLastUpdate === null) {
              studyStatus = 'inactive';
            } else if (daysSinceLastUpdate <= 7) {
              studyStatus = 'active';
            } else if (daysSinceLastUpdate > STALE_THRESHOLD_DAYS) {
              // 14+ days without a quiz = study paused
              studyStatus = 'slump';
            } else if (medianInterval && daysSinceLastUpdate > medianInterval * SLUMP_MULTIPLIER) {
              // Gap much larger than typical = slump
              studyStatus = 'slump';
            } else {
              // 8-14 days = cooling off but still somewhat active
              studyStatus = 'cooling';
            }
            
            // --- REALISTIC EXAM READINESS PREDICTION ---
            let estimatedExamDate = null;
            let daysToReady = null;
            let readinessNote = null;
            
            if (allAbove75) {
              // Already exam ready - add consolidation period from last update
              const consolidationEnd = mostRecentUpdate ? new Date(mostRecentUpdate + CONSOLIDATION_DAYS * 24 * 60 * 60 * 1000) : new Date();
              if (consolidationEnd > now) {
                estimatedExamDate = consolidationEnd;
                daysToReady = Math.ceil((consolidationEnd - now) / (1000 * 60 * 60 * 24));
                readinessNote = 'consolidation';
              } else {
                estimatedExamDate = new Date();
                daysToReady = 0;
                readinessNote = 'ready';
              }
            } else if (studyStatus === 'slump' || studyStatus === 'inactive') {
              // In a study slump - don't show aggressive date, show warning
              readinessNote = 'slump';
              // Still calculate an estimate but mark it as unreliable
              const domainsNeeding75 = domains.filter(d => domainPercents[d] < EXAM_READY_THRESHOLD);
              const avgGapToUse = medianInterval || 7; // Default to weekly if no data
              // Estimate: each domain needs (75 - current) / velocity days
              // Assume ~5-10 points improvement per study session on average
              const pointsPerSession = 7;
              let totalDaysNeeded = 0;
              domainsNeeding75.forEach(d => {
                const gap = EXAM_READY_THRESHOLD - domainPercents[d];
                const sessionsNeeded = Math.ceil(gap / pointsPerSession);
                totalDaysNeeded += sessionsNeeded * avgGapToUse;
              });
              // Add stale domain penalty (need to re-study)
              totalDaysNeeded += staleDomains.length * avgGapToUse * 2;
              totalDaysNeeded += CONSOLIDATION_DAYS;
              estimatedExamDate = new Date(now + totalDaysNeeded * 24 * 60 * 60 * 1000);
              daysToReady = Math.ceil(totalDaysNeeded);
            } else if (avgDaysBetweenUpdates && avgDaysBetweenUpdates > 0) {
              // Active study - calculate realistic estimate
              const domainsNeeding75 = domains.filter(d => domainPercents[d] < EXAM_READY_THRESHOLD);
              // More realistic: each domain needs time based on gap to 75%
              // Assume ~5-10 points improvement per focused study session
              const pointsPerSession = quizRate >= 3 ? 8 : (quizRate >= 1 ? 6 : 5);
              let totalDaysNeeded = 0;
              domainsNeeding75.forEach(d => {
                const gap = EXAM_READY_THRESHOLD - domainPercents[d];
                const sessionsNeeded = Math.ceil(gap / pointsPerSession);
                const daysForDomain = sessionsNeeded * avgDaysBetweenUpdates;
                totalDaysNeeded = Math.max(totalDaysNeeded, daysForDomain); // Parallel study
              });
              // Add stale domain catch-up time
              if (staleDomains.length > 0) {
                totalDaysNeeded += staleDomains.length * avgDaysBetweenUpdates;
              }
              totalDaysNeeded += CONSOLIDATION_DAYS;
              estimatedExamDate = new Date(now + totalDaysNeeded * 24 * 60 * 60 * 1000);
              daysToReady = Math.ceil(totalDaysNeeded);
              readinessNote = 'projected';
            } else {
              readinessNote = 'insufficient';
            }
            
            return {
              domainPercents,
              domainsBelow50,
              domainsAbove75,
              allAbove50,
              allAbove75,
              quizRate,
              avgDaysBetweenUpdates,
              medianInterval,
              daysSinceLastUpdate,
              studyStatus,
              staleDomains,
              domainStaleness,
              estimatedExamDate,
              daysToReady,
              readinessNote,
              totalDomains: domains.length,
              readyCount: domainsAbove75.length
            };
          }

          function getQuizHistory() {
            try {
              const raw = localStorage.getItem('mergedQuizHistory');
              return raw ? JSON.parse(raw) : [];
            } catch(e) { return []; }
          }

          function getDomainMetadata() {
            try {
              const raw = localStorage.getItem('domainScoreMetadata');
              return raw ? JSON.parse(raw) : {};
            } catch(e) { return {}; }
          }

          // Determine priority domains using smart logic - returns ranked array
          // Index 0 = ALWAYS the weakest domain (lowest score)
          // Index 1+ = Next step(s), using logical order if all domains >= 50%
          function getPriorityDomains() {
            const stats = getStudyStats();
            const domains = Object.keys(domainCardIdMap);
            
            // Filter out domains with invalid/NaN percentages
            const validDomains = domains.filter(d => {
              const pct = stats.domainPercents[d];
              return typeof pct === 'number' && !isNaN(pct);
            });
            
            // If no valid domains, return empty
            if (validDomains.length === 0) return [];
            
            // Sort all domains by score ascending (lowest first)
            const sortedByScore = [...validDomains].sort((a, b) => {
              const pctA = stats.domainPercents[a] || 0;
              const pctB = stats.domainPercents[b] || 0;
              return pctA - pctB;
            });
            
            // Index 0 is ALWAYS the weakest domain
            const weakestDomain = sortedByScore[0];
            const weakestPercent = stats.domainPercents[weakestDomain] || 0;
            
            const results = [{
              domain: weakestDomain,
              percent: weakestPercent,
              reason: weakestPercent < 50 ? 'Weakest point - needs immediate attention' : 'Lowest scoring domain',
              priority: weakestPercent < 50 ? 'critical' : (weakestPercent < 75 ? 'moderate' : 'polish'),
              rank: 0
            }];
            
            // For remaining domains (next steps), decide ordering strategy
            const remaining = sortedByScore.slice(1);
            if (remaining.length === 0) return results; // Only one domain
            
            if (stats.allAbove50) {
              // All domains 50%+: order next steps by logical AZ-104 sequence
              remaining.sort((a, b) => {
                const orderA = LOGICAL_DOMAIN_ORDER.indexOf(a);
                const orderB = LOGICAL_DOMAIN_ORDER.indexOf(b);
                if (orderA >= 0 && orderB >= 0) return orderA - orderB;
                if (orderA >= 0) return -1;
                if (orderB >= 0) return 1;
                return (stats.domainPercents[a] || 0) - (stats.domainPercents[b] || 0);
              });
            }
            // Otherwise keep sorted by score (lowest first)
            
            remaining.forEach((domain, index) => {
              const percent = stats.domainPercents[domain] || 0;
              let reason, priority;
              
              if (percent < 50) {
                reason = 'Below 50% threshold';
                priority = 'critical';
              } else if (percent < 75) {
                reason = stats.allAbove50 ? 'Following AZ-104 study path' : 'Working toward exam readiness (75%)';
                priority = 'moderate';
              } else {
                reason = 'Polish and maintain';
                priority = 'polish';
              }
              
              results.push({ domain, percent, reason, priority, rank: index + 1 });
            });
            
            return results;
          }
          
          // Legacy wrapper for backwards compatibility
          function getPriorityDomain() {
            const priorities = getPriorityDomains();
            return priorities[0] || { domain: null, percent: 100, reason: 'All domains complete!', priority: 'complete' };
          }

          // --- Utility: ensure lab items have checkboxes ---
          function ensureLabCheckboxes() {
            document.querySelectorAll(".card").forEach((card) => {
              card.querySelectorAll("ul.review-item-list li.lab-item").forEach((li) => {
                if (!li.querySelector("input[type='checkbox']")) {
                  const firstChild = li.querySelector("span.item-text,strong,b");
                  if (firstChild && (firstChild.tagName === "STRONG" || firstChild.tagName === "B")) {
                    return; // skip headers
                  }
                  const cb = document.createElement("input");
                  cb.type = "checkbox";
                  cb.style.marginRight = "12px";
                  li.insertBefore(cb, li.firstChild);
                }
              });
            });

              // Challenge lab styling (injected here so single-file remains portable)
              (function injectChallengeStyles(){
                const css = `
                .lab-section-header { font-weight:700; margin-top:10px; color:#123; }
                .lab-section-list { margin:6px 0 12px 18px; padding:0; }
                li.lab-item { list-style:none; margin:6px 0; }
                li.lab-item .challenge-badge { display:inline-block; background:#b33; color:#fff; padding:2px 6px; border-radius:12px; font-size:12px; margin-right:8px; }
                li.lab-item.lab-challenge { border-left:3px solid #b33; padding-left:8px; background:rgba(179,51,51,0.03); }
                .next-step-challenge { font-weight:700; color:#b33; }
                `;
                const s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);
              })();
          }

          // --- Render domain progress bars ---
          function renderDomainProgress() {
            const container = document.getElementById("domain-progress-container");
            if (!container) {
              console.error('domain-progress-container not found!');
              return;
            }
            container.innerHTML = "";
            console.log('Rendering domain progress with scores:', mergedQuizScores);
            let totalCorrect = 0, totalQuestions = 0;
            Object.values(mergedQuizScores).forEach(({ correct, total }) => {
              totalCorrect += correct; totalQuestions += total;
            });
            const overall = totalQuestions ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const overallEl = document.getElementById("overall-quiz-score");
            if (overallEl) {
              overallEl.textContent = overall + "%";
              console.log('Updated overall quiz score to:', overall + '%');
            }

            Object.keys(mergedQuizScores).forEach((domain) => {
              const data = mergedQuizScores[domain] || { correct: 0, total: 0 };
              const rawPercent = data.total ? Math.round((data.correct / data.total) * 100) : 0;
              const percent = (typeof data.adjustedPercent === 'number') ? Math.round(data.adjustedPercent) : rawPercent;
              // RAG Color System: Red (0-49%), Amber (50-75%), Green (76-100%)
              let ragClass = "rag-red";
              if (percent >= 76) ragClass = "rag-green";
              else if (percent >= 50) ragClass = "rag-amber";
              
              console.log(`Rendering ${domain}: ${data.correct}/${data.total} = ${percent}% [${ragClass}]`);
              
              const html = `
                <div class="domain-progress-row">
                  <span class="domain-icon"><i class="fas ${domainIcons[domain]}"></i></span>
                  <span class="domain-name">${domainDisplayNames[domain]}</span>
                  <span class="progress-meter">
                    <span class="progress-bar ${ragClass}" style="width: ${Math.max(percent, 5)}%">${percent}%</span>
                  </span>
                  <span class="domain-percentage-text">${data.correct || 0}/${data.total || 0}</span>
                </div>
              `;
              container.insertAdjacentHTML('beforeend', html);
              const statEl = document.getElementById(domain.toLowerCase() + "-quiz-stats");
              if (statEl) statEl.textContent = `(${data.correct || 0}/${data.total || 0} correct, ${percent}%)`;
            });
            console.log('Domain progress rendering complete. Container innerHTML length:', container.innerHTML.length);
            try{ renderRetentionTrends(); }catch(e){}
            try{ updateStrategicPlanScores(); }catch(e){}
          }

          // --- Load inline lab-module map (single-file mode) ---
          let labModuleMap = [];
          function loadInlineLabModuleMap() {
            const el = document.getElementById('lab-module-map');
            if (el && el.textContent && el.textContent.trim()) {
              try {
                const payload = JSON.parse(el.textContent);
                labModuleMap = Array.isArray(payload.labs) ? payload.labs : (payload || []);
              } catch (e) {
                console.warn('Failed to parse inline lab-module map', e);
                labModuleMap = [];
              }
            }
          }

          // --- Recommend labs for a flashcard using the inline map (fallbacks to whizlabsData) ---
          function recommendLabsForFlashcard(domain, flashcardTitle, topN = 3) {
            // Use the curated inline labModuleMap only â€” this avoids recommending
            // labs that aren't actually available on Whizlabs and prevents
            // falling back to a secondary list that may be incomplete.
            const source = (labModuleMap && labModuleMap.length) ? labModuleMap : [];
            const keywords = (flashcardTitle || '').toLowerCase().split(/\s+/).filter(Boolean);
            if (!keywords.length) return [];
            const scored = source.map((lab) => {
              const labDomains = (lab.domains || []).map(s => (s || '').toLowerCase());
              const labModules = (lab.modules || []).map(s => (s || '').toLowerCase());
              const labTags = (lab.tags || []).map(s => (s || '').toLowerCase());
              const title = (lab.title || '').toLowerCase();
              const domainMatch = labDomains.includes((domain || '').toLowerCase()) ? 1 : 0;
              const keywordMatches = keywords.reduce((acc, k) => acc + (title.includes(k) || labModules.includes(k) || labTags.includes(k) ? 1 : 0), 0);
              const moduleScore = keywordMatches / Math.max(1, keywords.length);
              const difficultyBonus = 1 - (lab.difficulty || 0.5);
              const priorityBonus = 1 / (1 + (lab.priority || 1));
              // Base score
              let finalScore = 0.6 * domainMatch + 0.25 * moduleScore + 0.1 * difficultyBonus + 0.05 * priorityBonus;
              // If user has low confidence for the domain, boost labs for that domain
              const uconf = userConfidence[domain]; // 0..1 or undefined
              if (typeof uconf === 'number') {
                // lower confidence -> higher boost. scale: up to +0.2
                finalScore += (1 - uconf) * 0.2;
              }
              return { lab, score: finalScore };
            });
            return scored.sort((a, b) => b.score - a.score).slice(0, topN).map(s => s.lab);
          }

          // --- Get next unchecked flashcard in a card ---
          function getNextFlashcard(domainKey) {
            const card = document.getElementById(domainCardIdMap[domainKey]);
            if (!card) return null;
            const cb = card.querySelector('.flashcard-item input[type="checkbox"]:not(:checked)');
            if (!cb) return null;
            let title = '';
            const textEl = cb.parentElement.querySelector('.item-text');
            if (textEl) title = textEl.textContent.trim();
            else if (cb.nextSibling) title = (cb.nextSibling.textContent || '').trim();
            return { title, element: cb };
          }

          // Open and reveal a flashcard given its checkbox element (or li)
          function openFlashcardForCheckbox(cbOrEl){
            try{
              const cb = (cbOrEl && cbOrEl.tagName === 'INPUT') ? cbOrEl : (cbOrEl && cbOrEl.querySelector ? cbOrEl.querySelector('input[type="checkbox"]') : null);
              if (!cb) return;
              const li = cb.closest('li.flashcard-item');
              if (!li) return;
              const content = li.querySelector('.flashcard-content-area');
              // Optionally collapse other domain cards when opening one (controlled by Score Editor checkbox)
              try{
                const autocollapseEl = document.getElementById('score-editor-autocollapse');
                const autocollapse = autocollapseEl ? !!autocollapseEl.checked : (localStorage.getItem('scoreEditorAutoCollapse') === 'true');
                const parentCard = li.closest('.card');
                if (autocollapse) {
                  document.querySelectorAll('.card').forEach(c => {
                    if (c !== parentCard) {
                      const toggle = c.querySelector('input.card-toggle');
                      if (toggle) try { toggle.checked = false; } catch(e) {}
                      c.querySelectorAll('.flashcard-content-area').forEach(fc=>fc.classList.remove('show'));
                      c.querySelectorAll('.flashcard-item').forEach(it=>it.classList.remove('active'));
                    }
                  });
                } else {
                  // just collapse any open flashcard content globally to avoid multiple open contents
                  document.querySelectorAll('.flashcard-content-area').forEach(c=>c.classList.remove('show'));
                  document.querySelectorAll('.flashcard-item').forEach(it=>it.classList.remove('active'));
                }
              } catch(e) { /* ignore */ }

              if (content) {
                content.classList.add('show');
                li.classList.add('active');
                // scroll into view
                li.scrollIntoView({behavior:'smooth', block:'center'});
                // brief highlight to make revealed flashcard obvious
                try{
                  li.classList.remove('flashcard-open-highlight');
                  void li.offsetWidth;
                  li.classList.add('flashcard-open-highlight');
                  setTimeout(()=>{ try{ li.classList.remove('flashcard-open-highlight'); }catch(e){} }, 1400);
                }catch(e){}
              }
            }catch(e){/* ignore */}
          }

          // --- Update the Next Steps Tracker (renders clickable lab links) ---
          function escapeHtml(str) {
            return String(str)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
          }

          function updateNextStepsTracker() {
            const trackerContent = document.getElementById('next-steps-content');
            if (!trackerContent) return;

            // Get priority domains using smart logic - returns ranked array
            const priorities = getPriorityDomains();
            const stats = getStudyStats();
            const priority = priorities[0] || null; // Weakest point (#1 Priority)
            const nextStep = priorities[1] || null; // Next step (2nd priority)
            const weakestDomain = priority ? priority.domain : null;
            const nextStepDomain = nextStep ? nextStep.domain : null;

            // Handle no data or completion state
            if (!priority || !weakestDomain || priority.priority === 'complete') {
              trackerContent.innerHTML = `
                <div class="next-step-hero rag-green">
                  <div class="focus-label">Congratulations!</div>
                  <div class="domain-focus">All Domains Complete</div>
                  <div class="mastery-badge">100% Mastery Achieved</div>
                </div>
              `;
              return;
            }

            // Use next step domain for flashcard/lab recommendations (the actionable next item)
            const focusDomain = nextStepDomain || weakestDomain;
            const currentFlash = getNextFlashcard(focusDomain);
            const nextFlashTitle = currentFlash && currentFlash.title ? currentFlash.title : 'All flashcards completed!';
            const matchedLabs = currentFlash && currentFlash.title ? recommendLabsForFlashcard(focusDomain, currentFlash.title, 3) : [];

            let nextLabHtml = 'No relevant labs found.';
            if (matchedLabs.length) {
              nextLabHtml = matchedLabs.map(l => {
                const title = escapeHtml(l.title || 'Untitled Lab');
                const mins = l.estimatedMinutes ? ` (${l.estimatedMinutes} min)` : '';
                const challengeBadgeInline = l.challenge ? ` <span class="next-step-challenge">(Challenge #${escapeHtml((l.challengeId||'').toString())})</span>` : '';
                const anchorId = `lab-${(l.labId||l.title||'').toString().replace(/[^a-z0-9-_]/gi, '-').toLowerCase()}`;
                return `<a href="#${anchorId}" data-internal-link="true">${title}</a>${mins}${challengeBadgeInline}`;
              }).join(' <span style="color:#999">â€¢</span> ');
            }

            // Also update per-domain trackers inside each card
            Object.keys(domainCardIdMap).forEach(domainKey => {
              try{
                const card = document.getElementById(domainCardIdMap[domainKey]);
                if (!card) return;
                const tracker = card.querySelector('.next-steps-tracker');
                if (!tracker) return;
                const nextFlash = getNextFlashcard(domainKey);
                const nfTitle = nextFlash && nextFlash.title ? escapeHtml(nextFlash.title) : 'All flashcards completed!';
                const matched = nextFlash && nextFlash.title ? recommendLabsForFlashcard(domainKey, nextFlash.title, 3) : [];
                let labHtml = 'No relevant labs found.';
                if (matched.length){
                  labHtml = matched.map(l => {
                    const t = escapeHtml(l.title || 'Untitled Lab');
                    const mins = l.estimatedMinutes ? ` (${l.estimatedMinutes} min)` : '';
                    const anchorId = `lab-${(l.labId||l.title||'').toString().replace(/[^a-z0-9-_]/gi, '-').toLowerCase()}`;
                    return `<a href="#${anchorId}" data-internal-link="true">${t}</a>${mins}`;
                  }).join(' <span style="color:#999">â€¢</span> ');
                }
                const sections = tracker.querySelectorAll('.tracker-section');
                if (sections && sections.length){
                  const flashSection = sections[0];
                  const flashTitleEl = flashSection.querySelector('.tracker-item .title');
                  if (flashTitleEl) flashTitleEl.innerHTML = nfTitle;
                }
                if (sections && sections.length > 1){
                  const labSection = sections[1];
                  const labTitleEl = labSection.querySelector('.tracker-item .title');
                  if (labTitleEl) labTitleEl.innerHTML = labHtml;
                  try{
                    const deckName = escapeHtml(getRecommendedAnkiDeck(domainKey));
                    let deckItem = labSection.querySelector('.anki-deck-item');
                    const deckInner = `<i class="fas fa-book"></i> <span class="title">Recommended Anki deck: ${deckName}</span>`;
                    if (deckItem) {
                      deckItem.innerHTML = deckInner;
                    } else {
                      labSection.insertAdjacentHTML('beforeend', `<div class="tracker-item anki-deck-item">${deckInner}</div>`);
                    }
                  }catch(e){}
                }
              }catch(e){}
            });
            attachInternalLinkHandlers();

            // Determine RAG color for hero
            let heroRagClass = 'rag-red';
            if (priority.percent >= 76) heroRagClass = 'rag-green';
            else if (priority.percent >= 50) heroRagClass = 'rag-amber';

            // Build study stats section with status indicator
            let statsHtml = '';
            if (stats.quizRate > 0 || stats.daysSinceLastUpdate !== null || stats.studyStatus) {
              const rateClass = stats.quizRate >= 3 ? 'highlight' : (stats.quizRate >= 1 ? '' : 'warning');
              const daysClass = stats.daysSinceLastUpdate === null ? 'danger' : (stats.daysSinceLastUpdate > 14 ? 'danger' : (stats.daysSinceLastUpdate > 7 ? 'warning' : 'highlight'));
              
              // Study status badge
              const statusBadges = {
                active: '<span style="background:#28a745;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:600;"><i class="fas fa-fire"></i> Active</span>',
                cooling: '<span style="background:#6c757d;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:600;"><i class="fas fa-clock"></i> Cooling</span>',
                slump: '<span style="background:#f59e0b;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:600;"><i class="fas fa-pause"></i> Paused</span>',
                inactive: '<span style="background:#dc3545;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:600;"><i class="fas fa-moon"></i> Inactive</span>'
              };
              const statusBadge = statusBadges[stats.studyStatus] || '';
              
              statsHtml = `
                <div class="study-stats-card">
                  <h4><i class="fas fa-chart-bar"></i> Study Activity ${statusBadge} <button onclick="location.reload()" style="margin-left:12px;padding:4px 10px;font-size:0.75em;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;cursor:pointer;" title="Refresh stats"><i class="fas fa-sync-alt"></i></button></h4>
                  <div class="study-stats-grid">
                    <div class="study-stat ${rateClass}">
                      <div class="stat-value">${stats.quizRate > 0 ? stats.quizRate.toFixed(1) : '--'}</div>
                      <div class="stat-label">Quizzes/Week (60d)</div>
                    </div>
                    <div class="study-stat ${daysClass}">
                      <div class="stat-value">${stats.daysSinceLastUpdate !== null ? stats.daysSinceLastUpdate : '--'}</div>
                      <div class="stat-label">Days Since Quiz</div>
                    </div>
                    <div class="study-stat">
                      <div class="stat-value">${stats.readyCount}/${stats.totalDomains}</div>
                      <div class="stat-label">Domains at 75%+</div>
                    </div>
                  </div>
                  ${stats.medianInterval ? `<div style="text-align:center;margin-top:8px;font-size:0.85em;color:var(--text-secondary);">Typical gap: <strong>${stats.medianInterval}</strong> days between quizzes</div>` : ''}
                </div>
              `;
            }

            // Build exam readiness section with realistic messaging
            let examHtml = '';
            const staleCount = stats.staleDomains ? stats.staleDomains.length : 0;
            const staleWarning = staleCount > 0 ? `<div style="margin-top:8px;padding:8px;background:rgba(245,158,11,0.15);border-radius:6px;font-size:0.85em;color:#b45309;"><i class="fas fa-exclamation-triangle"></i> ${staleCount} domain${staleCount > 1 ? 's' : ''} need${staleCount === 1 ? 's' : ''} review (not updated in 14+ days)</div>` : '';
            
            if (stats.readinessNote === 'ready') {
              examHtml = `
                <div class="exam-readiness-card" style="border-color:#28a745;">
                  <div class="readiness-title" style="color:#28a745;"><i class="fas fa-check-circle"></i> Exam Ready!</div>
                  <div class="target-date" style="color:#28a745;">You're prepared</div>
                  <div class="target-note">All domains at 75%+ - consider scheduling your exam</div>
                  <div class="progress-summary">
                    <strong>${stats.readyCount}</strong> of <strong>${stats.totalDomains}</strong> domains exam-ready
                  </div>
                </div>
              `;
            } else if (stats.readinessNote === 'consolidation') {
              const dateStr = stats.estimatedExamDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
              examHtml = `
                <div class="exam-readiness-card" style="border-color:#28a745;">
                  <div class="readiness-title"><i class="fas fa-hourglass-half"></i> Consolidation Period</div>
                  <div class="target-date">${dateStr}</div>
                  <div class="target-note">~${stats.daysToReady} day${stats.daysToReady !== 1 ? 's' : ''} - Review and reinforce before exam</div>
                  <div class="progress-summary">All domains at 75%+ - let knowledge settle</div>
                </div>
              `;
            } else if (stats.readinessNote === 'slump') {
              examHtml = `
                <div class="exam-readiness-card" style="border-color:#f59e0b;background:linear-gradient(135deg,rgba(245,158,11,0.05),rgba(245,158,11,0.1));">
                  <div class="readiness-title" style="color:#b45309;"><i class="fas fa-pause-circle"></i> Study Paused</div>
                  <div class="target-date" style="color:#b45309;">Prediction unavailable</div>
                  <div class="target-note" style="color:#92400e;">
                    <strong>${stats.daysSinceLastUpdate || 0} days</strong> since your last quiz
                  </div>
                  <div class="progress-summary" style="margin-top:12px;">
                    <strong>${stats.readyCount}</strong> of <strong>${stats.totalDomains}</strong> domains at 75%+
                    ${stats.medianInterval ? ` | Your typical pace: <strong>${stats.medianInterval}</strong> days between quizzes` : ''}
                  </div>
                  ${staleWarning}
                  <div style="margin-top:12px;padding:12px;background:rgba(245,158,11,0.2);border-radius:8px;text-align:center;">
                    <div style="font-weight:600;color:#92400e;margin-bottom:4px;"><i class="fas fa-info-circle"></i> Why no date?</div>
                    <div style="font-size:0.85em;color:#78350f;">Your study activity has paused. Resume quizzing regularly (at least 2-3 times per week) to get a realistic exam date prediction.</div>
                  </div>
                </div>
              `;
            } else if (stats.readinessNote === 'projected' && stats.estimatedExamDate) {
              const dateStr = stats.estimatedExamDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
              const daysText = stats.daysToReady === 0 ? 'Ready now!' : 
                              stats.daysToReady === 1 ? '~1 day' : 
                              `~${stats.daysToReady} days`;
              const paceNote = stats.quizRate >= 3 ? 'Great pace!' : 
                              stats.quizRate >= 1 ? 'Steady progress' : 
                              'Consider increasing study frequency';
              examHtml = `
                <div class="exam-readiness-card">
                  <div class="readiness-title"><i class="fas fa-calendar-check"></i> Estimated Exam Readiness</div>
                  <div class="target-date">${dateStr}</div>
                  <div class="target-note">${daysText} at your current pace (${stats.quizRate.toFixed(1)} quizzes/week)</div>
                  <div class="progress-summary">
                    <strong>${stats.readyCount}</strong> of <strong>${stats.totalDomains}</strong> domains at 75%+ | ${paceNote}
                  </div>
                  ${staleWarning}
                </div>
              `;
            } else {
              examHtml = `
                <div class="exam-readiness-card">
                  <div class="readiness-title"><i class="fas fa-calendar-check"></i> Estimated Exam Readiness</div>
                  <div class="target-date" style="color: var(--text-secondary)">Not enough data</div>
                  <div class="target-note">Take at least 2 quizzes to enable prediction</div>
                  <div class="progress-summary">
                    <strong>${stats.readyCount}</strong> of <strong>${stats.totalDomains}</strong> domains at 75%+
                  </div>
                </div>
              `;
            }

            // Build Next Step section (2nd priority - the actionable next domain)
            let nextStepHtml = '';
            if (nextStep && nextStep.domain) {
              const nextRagClass = nextStep.percent >= 76 ? 'rag-green' : (nextStep.percent >= 50 ? 'rag-amber' : 'rag-red');
              nextStepHtml = `
                <div class="next-step-section" style="margin-top:16px;padding:16px;background:var(--card-bg);border-radius:12px;border:2px solid var(--${nextRagClass === 'rag-green' ? 'success' : nextRagClass === 'rag-amber' ? 'warning' : 'danger'}-color, #0078d4);">
                  <div style="font-size:0.85em;color:var(--text-secondary);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">
                    <i class="fas fa-arrow-right"></i> Next Step
                  </div>
                  <div style="font-size:1.3em;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:8px;">
                    <i class="fas ${domainIcons[nextStep.domain] || 'fa-book'}"></i> ${domainDisplayNames[nextStep.domain] || nextStep.domain}
                  </div>
                  <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;align-items:center;">
                    <span style="background:${nextRagClass === 'rag-green' ? '#28a745' : nextRagClass === 'rag-amber' ? '#f59e0b' : '#dc3545'};color:#fff;padding:4px 12px;border-radius:20px;font-size:0.85em;font-weight:600;">
                      ${Math.round(nextStep.percent)}%
                    </span>
                    <span style="color:var(--text-secondary);font-size:0.9em;">${escapeHtml(nextStep.reason)}</span>
                  </div>
                </div>
              `;
            }

            // Render the enhanced global tracker content
            trackerContent.innerHTML = `
              <div class="next-step-hero ${heroRagClass}">
                <div class="focus-label"><i class="fas fa-exclamation-triangle"></i> #1 Priority - Weakest Point</div>
                <div class="domain-focus"><i class="fas ${domainIcons[weakestDomain] || 'fa-book'}"></i> ${domainDisplayNames[weakestDomain] || weakestDomain}</div>
                <div class="mastery-badge">${Math.round(priority.percent)}% Mastery</div>
                <div class="priority-reason">${escapeHtml(priority.reason)}</div>
              </div>

              ${nextStepHtml}

              ${statsHtml}
              ${examHtml}

              <div style="margin:16px 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
                <button id="go-next-step-btn" style="background:#0078d4;color:#fff;border:0;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <i class="fas fa-arrow-right"></i> Go to Next Flashcard
                </button>
                <button id="re-eval-btn" style="background:#6c757d;color:#fff;border:0;padding:10px 16px;border-radius:6px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
                  <i class="fas fa-sync"></i> Refresh
                </button>
              </div>

              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i> Next Flashcard (from ${domainDisplayNames[focusDomain] || focusDomain}):</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">${escapeHtml(nextFlashTitle)}</span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i> Recommended Labs:</strong>
                <div class="tracker-item">
                  <i class="fas fa-vial"></i>
                  <span class="title">${nextLabHtml}</span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-layer-group"></i> Anki Deck:</strong>
                <div class="tracker-item">
                  <i class="fas fa-book"></i>
                  <span class="title">${escapeHtml(getRecommendedAnkiDeck(focusDomain))}</span>
                </div>
              </div>
            `;

            // Attach interactive button handlers
            try{
              const goBtn = trackerContent.querySelector('#go-next-step-btn');
              if (goBtn && currentFlash && currentFlash.element) {
                goBtn.addEventListener('click', (ev)=>{
                  ev.preventDefault();
                  try{
                    try{
                      const domainKey = focusDomain;
                      const cardId = domainCardIdMap[domainKey];
                      const card = document.getElementById(cardId);
                      if (card) {
                        const toggle = card.querySelector('input.card-toggle');
                        if (toggle && !toggle.checked) {
                          try { toggle.checked = true; } catch(e) {}
                          const content = card.querySelector('.card-content');
                          if (content) content.style.display = 'block';
                        }
                      }
                    }catch(e){}
                    openFlashcardForCheckbox(currentFlash.element);
                  }catch(e){}
                });
              }
              const reBtn = trackerContent.querySelector('#re-eval-btn');
              if (reBtn) {
                reBtn.addEventListener('click', (ev)=>{
                  ev.preventDefault();
                  try{
                    updateMergedQuizScoresFromConfidence();
                    renderDomainProgress();
                    updateNextStepsTracker();
                    try{
                      const autosaveEl = document.getElementById('score-editor-reval-autosave');
                      const autosave = autosaveEl ? !!autosaveEl.checked : false;
                      if (autosave) {
                        const adj = {};
                        Object.keys(mergedQuizScores).forEach(k => { adj[k] = { adjustedPercent: mergedQuizScores[k].adjustedPercent }; });
                        try { localStorage.setItem('mergedQuizAdjusted', JSON.stringify(adj)); }catch(e){}
                        try{ pushMergedQuizHistory('reval-autosave'); }catch(e){}
                        showToast('Refreshed recommendations', 3000);
                      } else {
                        showToast('Refreshed recommendations', 0);
                      }
                    }catch(e){ showToast('Refreshed recommendations'); }
                  }catch(e){}
                });
              }
            }catch(e){}
          }

          // --- Prune Lab Tracker lists to mapped/recommended labs (reduces noise) ---
          function pruneLabListsToMapped() {
            if (!labModuleMap || !labModuleMap.length) return;
            Object.keys(domainCardIdMap).forEach(domainKey => {
              const card = document.getElementById(domainCardIdMap[domainKey]);
              if (!card) return;
              const lists = card.querySelectorAll('ul.review-item-list');
              if (!lists || lists.length === 0) return;
              // Usually the last review-item-list in the card is the lab tracker
              const labList = lists[lists.length - 1];
              // Clear existing lab items
              labList.innerHTML = '';
              // Find mapped labs for this domain
              let domainLabs = labModuleMap.filter(l => (l.domains || []).map(d => (d||'').toLowerCase()).includes(domainKey.toLowerCase()));
              // Fallback to whizlabsData if no mapped labs found
              if (!domainLabs.length) {
                domainLabs = (whizlabsData.labs || []).filter(l => (l.domain || '').toLowerCase().includes(domainKey.toLowerCase()));
              }
              // Group labs by first module (treat as section) or by 'section' field when present
              const grouped = {};
              domainLabs.forEach(lab => {
                const section = (lab.section || (lab.modules && lab.modules[0]) || 'General').toString();
                if (!grouped[section]) grouped[section] = [];
                grouped[section].push(lab);
              });
              // Insert grouped lab items with section headers
              Object.keys(grouped).forEach(sectionName => {
                const headerLi = document.createElement('li');
                headerLi.className = 'lab-section-header';
                headerLi.textContent = sectionName;
                labList.appendChild(headerLi);
                const sectionUl = document.createElement('ul');
                sectionUl.className = 'lab-section-list';
                grouped[sectionName].forEach(lab => {
                  const li = document.createElement('li');
                  li.className = 'lab-item';
                  if (lab.challenge) li.classList.add('lab-challenge');
                  // create a stable in-page id for the lab
                  const safeIdBase = (lab.labId || lab.title || '').toString().replace(/[^a-z0-9-_]/gi, '-').toLowerCase();
                  const anchorId = `lab-${safeIdBase}`;
                  li.id = anchorId;
                  const title = escapeHtml(lab.title || 'Untitled Lab');
                  const mins = lab.estimatedMinutes ? ` <span style="color:#666">(${lab.estimatedMinutes} min)</span>` : '';
                  // build optional challenge badge
                  const challengeBadge = lab.challenge ? `<span class="challenge-badge">Challenge #${escapeHtml((lab.challengeId||'').toString())}</span>` : '';
                  // Prefer same-page anchors so you stay inside the review page
                  li.innerHTML = `${challengeBadge}<a href="#${anchorId}" data-internal-link="true">${title}</a>${mins}`;
                  sectionUl.appendChild(li);
                });
                labList.appendChild(sectionUl);
              });
              // ensure internal links inside lab lists have handlers
              attachInternalLinkHandlers();
            });
          }

          // --- Attach checkbox/listener handling ---
          function attachListeners() {
            // Update Next Steps only when flashcards change (not when labs change)
            document.querySelectorAll('.flashcard-item input[type="checkbox"]').forEach(cb => {
              cb.removeEventListener('change', updateNextStepsTracker); // idempotent reattach
              cb.addEventListener('change', updateNextStepsTracker);
            });
            // Do not attach Next Steps updates to lab checkbox changes to avoid noisy updates
            // Lab checkboxes keep their own UI behavior but won't change the prioritization
            // Toggle flashcard content area when clicking item-text
            document.querySelectorAll('.flashcard-item .item-text').forEach(el => {
              el.addEventListener('click', (e) => {
                const li = el.closest('li.flashcard-item');
                if (!li) return;
                const content = li.querySelector('.flashcard-content-area');
                if (!content) return;
                const isShown = content.classList.contains('show');
                document.querySelectorAll('.flashcard-content-area').forEach(c=>c.classList.remove('show'));
                document.querySelectorAll('.flashcard-item').forEach(it=>it.classList.remove('active'));
                if (!isShown) { content.classList.add('show'); li.classList.add('active'); }
                // Also update next steps when the user actively opens a flashcard
                updateNextStepsTracker();
              });
            });
            // Intercept internal lab anchor clicks to smooth-scroll and highlight
            document.querySelectorAll('a[data-internal-link="true"]').forEach(a => {
              a.addEventListener('click', (ev) => {
                // Only handle same-page anchors
                const href = a.getAttribute('href') || '';
                if (!href.startsWith('#')) return;
                ev.preventDefault();
                const id = href.slice(1);
                const target = document.getElementById(id);
                if (!target) return;
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // briefly highlight
                target.classList.remove('lab-highlight');
                void target.offsetWidth; // force reflow
                target.classList.add('lab-highlight');
                // remove highlight after a delay
                setTimeout(() => target.classList.remove('lab-highlight'), 2500);
              });
            });
          }

          // Re-attach internal anchor handlers for dynamically-inserted links
          function attachInternalLinkHandlers() {
            document.querySelectorAll('a[data-internal-link="true"]').forEach(a => {
              // avoid double-binding
              if (a.__internalHandlerBound) return;
              const handler = (ev) => {
                const href = a.getAttribute('href') || '';
                if (!href.startsWith('#')) return;
                ev.preventDefault();
                const id = href.slice(1);
                const target = document.getElementById(id);
                if (!target) return;
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.classList.remove('lab-highlight');
                void target.offsetWidth;
                target.classList.add('lab-highlight');
                setTimeout(() => target.classList.remove('lab-highlight'), 2500);
              };
              a.addEventListener('click', handler);
              a.__internalHandlerBound = true;
            });
          }

          // --- Initialize ---
          loadInlineLabModuleMap();
          pruneLabListsToMapped();
          ensureLabCheckboxes();
          // compute initial confidence-adjusted scores and render
          // If an adjusted-percents snapshot exists from previous session, load it
          try{
            const rawAdj = localStorage.getItem('mergedQuizAdjusted');
            if (rawAdj) {
              try{
                const adj = JSON.parse(rawAdj);
                Object.keys(adj).forEach(k => { if (mergedQuizScores[k]) mergedQuizScores[k].adjustedPercent = adj[k] && typeof adj[k].adjustedPercent === 'number' ? adj[k].adjustedPercent : mergedQuizScores[k].adjustedPercent; });
              }catch(e){}
            }
          }catch(e){}
          updateMergedQuizScoresFromConfidence();
          renderDomainProgress();
          attachListeners();
          updateNextStepsTracker();
          
          // Log final scores for debugging
          console.log('Final mergedQuizScores after initialization:', mergedQuizScores);
          
          // Force a secondary render to ensure UI updates
          setTimeout(() => {
            renderDomainProgress();
            updateStrategicPlanScores();
            console.log('Forced secondary render complete');
          }, 100);
          
          // Function to update live scores in strategic plan
          function updateStrategicPlanScores() {
            const computeScoreEl = document.getElementById('compute-live-score');
            if (computeScoreEl && mergedQuizScores.Compute) {
              const data = mergedQuizScores.Compute;
              const percent = data.total ? Math.round((data.correct / data.total) * 100) : 0;
              computeScoreEl.textContent = `${data.correct}/${data.total} (${percent}%)`;
              console.log('Updated strategic plan live score:', computeScoreEl.textContent);
            }
          }
          
          // Simple one-time cache check (no infinite loop)
          const hasTimestamp = window.location.search.includes('t=');
          if (hasTimestamp) {
            console.log('Page loaded fresh with timestamp');
            // Add visual confirmation the page loaded fresh (one time only)
            document.body.style.border = '2px solid #28a745';
            setTimeout(() => {
              if (document.body.style.border) document.body.style.border = '';
            }, 3000);
          }

          // Wire up confidence select handlers so changes affect recommendations
          function attachConfidenceSelectHandlers() {
            // Attach handlers that persist confidence selections locally.
            // We intentionally DO NOT auto-recompute adjusted scores here to
            // avoid noisy changes while the user is editing many selects.
            document.querySelectorAll('select.confidence-select').forEach(sel => {
              sel.removeEventListener('change', sel.__confBoundHandler);
              const h = () => {
                try { saveFlashcardState(); } catch(e) {}
                // visual class updates
                ['none','weak','medium','strong'].forEach(c=>sel.classList.remove(c));
                if (sel.value) sel.classList.add(sel.value);
                // Recompute adjusted percent for the domain containing this select so
                // Next Steps and progress update immediately in constrained hosts
                try{
                  // find domainKey by locating the parent card id
                  const card = sel.closest('.card');
                  let domainKey = null;
                  if (card && card.id) {
                    domainKey = Object.keys(domainCardIdMap).find(k => domainCardIdMap[k] === card.id);
                  }
                  // compute and set adjustedPercent for this domain only
                  if (domainKey) {
                    const userPct = computeDomainConfidence(domainKey); // returns 0..100 or null
                    // read blend ratio
                    let quizWeight = 0.6;
                    try { const s = document.getElementById('score-editor-blend'); if (s && s.value) quizWeight = parseFloat(s.value) || 0.6; } catch(e){}
                    const confWeight = Math.max(0, Math.min(1, 1 - quizWeight));
                    const data = mergedQuizScores[domainKey] || { correct:0, total:0 };
                    const origPercent = data.total ? (data.correct / data.total) * 100 : 0;
                    if (typeof userPct === 'number') {
                      data.adjustedPercent = Math.round((origPercent * quizWeight) + (userPct * confWeight));
                    } else {
                      data.adjustedPercent = Math.round(origPercent);
                    }
                  }
                }catch(e){}
                // immediate visual feedback: update domain progress bars and next steps
                try{ renderDomainProgress(); }catch(e){}
                try{ updateNextStepsTracker(); }catch(e){}
                // schedule a debounced persist of adjusted percents so they are available after a reload/close
                try{ schedulePersistAdjusted('confidence-change'); }catch(e){}
              };
              sel.addEventListener('change', h);
              sel.__confBoundHandler = h;
            });
          }
          attachConfidenceSelectHandlers();

          // --- Compact Score Editor logic ---
          (function wireScoreEditor(){
            const domains = Object.keys(domainCardIdMap);
            const select = document.getElementById('score-editor-domain');
            domains.forEach(d => {
              const opt = document.createElement('option'); opt.value = d; opt.textContent = domainDisplayNames[d] || d; select.appendChild(opt);
            });
            const panel = document.getElementById('score-editor-panel');
            const toggle = document.getElementById('score-editor-toggle');
            toggle.addEventListener('click', () => { 
              panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
              if (panel.style.display === 'block') {
                try { updateScoreEditorLastUpdated(select.value); } catch(e) {}
              }
            });

            // Update last updated display when domain changes
            select.addEventListener('change', () => {
              try { updateScoreEditorLastUpdated(select.value); } catch(e) {}
            });

            // Initial update for first domain
            try { updateScoreEditorLastUpdated(select.value); } catch(e) {}

            // Toast + Undo + Debug helpers (scoped to the score editor wiring)
            const toastEl = document.getElementById('global-toast');
            function showToast(text, timeout = 3000){
              try{
                if (!toastEl) return;
                toastEl.textContent = text;
                toastEl.style.display = 'block';
                toastEl.style.opacity = '1';
                clearTimeout(showToast._t);
                // If timeout is > 0, auto-hide after that many ms. If timeout <= 0, keep persistent until next toast.
                if (typeof timeout === 'number' && timeout > 0) {
                  showToast._t = setTimeout(()=>{ try{ toastEl.style.opacity='0'; toastEl.style.display='none'; }catch(e){} }, timeout);
                }
              }catch(e){}
            }

            const undoBtnEl = document.getElementById('score-editor-undo');
            function enableUndo(){ if (undoBtnEl) undoBtnEl.disabled = false; }
            function disableUndo(){ if (undoBtnEl) undoBtnEl.disabled = true; try{ localStorage.removeItem('lastScoreEditorSnapshot'); }catch(e){} }

            function updateDebugPanel(){
              try{
                const body = document.getElementById('debug-panel-body');
                if (!body) return;
                const keys = ['mergedQuizScores','quizFlashcardState','scoreEditorBlend','scoreEditorAutoCollapse','lastScoreEditorSnapshot'];
                const out = {};
                keys.forEach(k => { try{ out[k] = JSON.parse(localStorage.getItem(k)); }catch(e){ out[k] = localStorage.getItem(k); } });
                body.textContent = JSON.stringify(out, null, 2);
              }catch(e){}
            }

            // Small merged-quiz debug badge (floating) to surface effective values
            function updateDebugBadge(){
              try{
                let badge = document.getElementById('merged-quiz-debug-badge');
                if (!badge) {
                  badge = document.createElement('div');
                  badge.id = 'merged-quiz-debug-badge';
                  badge.style.position = 'fixed';
                  badge.style.left = '12px';
                  badge.style.bottom = '12px';
                  badge.style.zIndex = '1400';
                  badge.style.background = 'rgba(0,0,0,0.75)';
                  badge.style.color = '#fff';
                  badge.style.padding = '8px 10px';
                  badge.style.borderRadius = '6px';
                  badge.style.fontSize = '12px';
                  badge.style.maxWidth = '320px';
                  badge.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
                  badge.style.fontFamily = 'Segoe UI, sans-serif';
                  document.body.appendChild(badge);
                }
                // Build content from mergedQuizScores
                const keys = Object.keys(mergedQuizScores || {});
                if (!keys.length) { badge.innerHTML = '<strong>No mergedQuizScores</strong>'; return; }
                const overallParts = keys.map(k => {
                  const d = mergedQuizScores[k] || { correct:0, total:0 };
                  const pct = d.total ? Math.round((d.correct/d.total)*100) : (typeof d.adjustedPercent === 'number' ? Math.round(d.adjustedPercent) : 0);
                  return `${k}: ${pct}% (${d.correct||0}/${d.total||0})`;
                });

                // sync indicator (optional): compare localStorage mergedQuizScores vs inline JSON
                function computeSyncStatus(){
                  try{
                    const rawLS = localStorage.getItem('mergedQuizScores');
                    const fromLS = rawLS ? JSON.parse(rawLS) : null;
                    const el = document.getElementById('merged-quiz-scores-json');
                    const fromInline = (el && el.textContent) ? JSON.parse(el.textContent) : null;
                    if (!fromLS || !fromInline) return { ok: !!fromLS && !!fromInline, equal: !!fromLS && !!fromInline && JSON.stringify(Object.keys(fromLS).sort().reduce((acc,k)=>{acc[k]={correct: fromLS[k].correct||0, total: fromLS[k].total||0}; return acc;},{}) ) === JSON.stringify(Object.keys(fromInline).sort().reduce((acc,k)=>{acc[k]={correct: fromInline[k].correct||0, total: fromInline[k].total||0}; return acc;},{}) ), fromLS, fromInline };
                    // Normalize shapes and compare per-domain correct/total
                    const norm = (obj) => {
                      const out = {};
                      Object.keys(obj).sort().forEach(k => { out[k] = { correct: (obj[k] && obj[k].correct) ? obj[k].correct : 0, total: (obj[k] && obj[k].total) ? obj[k].total : 0 }; });
                      return out;
                    };
                    const nLS = norm(fromLS);
                    const nIn = norm(fromInline);
                    const equal = JSON.stringify(nLS) === JSON.stringify(nIn);
                    return { ok: true, equal, fromLS: nLS, fromInline: nIn };
                  }catch(e){ return { ok:false, equal:false }; }
                }

                const syncPref = (function(){ try{ return localStorage.getItem('scoreEditorShowSyncIndicator') === 'true'; }catch(e){ return false; } })();
                const sync = syncPref ? computeSyncStatus() : null;
                let syncHtml = '';
                if (syncPref) {
                  if (!sync || !sync.ok) {
                    syncHtml = `<div style="margin-top:6px;color:#ffcc00;font-size:11px">Sync: unknown</div>`;
                  } else if (sync.equal) {
                    syncHtml = `<div style="margin-top:6px;color:#8bc34a;font-size:11px">Sync: Local = File</div>`;
                  } else {
                    syncHtml = `<div style="margin-top:6px;color:#ff7043;font-size:11px">Sync: Local differs</div>`;
                  }
                }

                badge.innerHTML = `<strong>Merged Scores</strong><div style="margin-top:6px;line-height:1.25">${overallParts.join('<br/>')}</div>${syncHtml}`;
              }catch(e){}
            }

            document.getElementById('debug-refresh') && document.getElementById('debug-refresh').addEventListener('click', updateDebugPanel);
            // debug toggle inside score editor
            const debugToggleBtn = document.getElementById('debug-toggle');
            const debugArea = document.getElementById('debug-area');
            if (debugToggleBtn && debugArea) debugToggleBtn.addEventListener('click', () => { debugArea.style.display = debugArea.style.display === 'none' ? 'block' : 'none'; updateDebugPanel(); });

            // Add optional Autosave toggle for Re-evaluate (persist adjustedPercent snapshot)
            try{
              const autosaveContainer = document.createElement('div');
              autosaveContainer.style.display = 'flex';
              autosaveContainer.style.alignItems = 'center';
              autosaveContainer.style.gap = '8px';
              autosaveContainer.style.marginTop = '8px';
              const autosaveCheckbox = document.createElement('input');
              autosaveCheckbox.type = 'checkbox';
              autosaveCheckbox.id = 'score-editor-reval-autosave';
              autosaveCheckbox.style.transform = 'scale(1.05)';
              const autosaveLabel = document.createElement('label');
              autosaveLabel.htmlFor = 'score-editor-reval-autosave';
              autosaveLabel.style.fontSize = '12px';
              autosaveLabel.style.color = '#333';
              autosaveLabel.textContent = 'Autosave re-evaluate adjusted percents';
              autosaveContainer.appendChild(autosaveCheckbox);
              autosaveContainer.appendChild(autosaveLabel);
              panel.appendChild(autosaveContainer);
              // Load persisted state
              try{ const raw = localStorage.getItem('scoreEditorRevalAutosave'); if (raw) autosaveCheckbox.checked = (raw === 'true'); }catch(e){}
              autosaveCheckbox.addEventListener('change', ()=>{ try{ localStorage.setItem('scoreEditorRevalAutosave', autosaveCheckbox.checked ? 'true' : 'false'); updateDebugPanel(); }catch(e){} });
              
              // --- Debug helpers: reload / clear mergedQuizScores ---
              // small debug control container (also hosts the optional sync indicator toggle)
              const dbgContainer = document.createElement('div'); dbgContainer.style.display='flex'; dbgContainer.style.gap='8px'; dbgContainer.style.marginTop='8px'; dbgContainer.style.justifyContent='space-between';
              const reloadBtn = document.createElement('button'); reloadBtn.textContent = 'Reload from inline JSON'; reloadBtn.style.flex='1'; reloadBtn.style.padding='6px'; reloadBtn.style.fontSize='12px'; reloadBtn.style.cursor='pointer';
              const clearBtn = document.createElement('button'); clearBtn.textContent = 'Clear mergedQuizScores LS'; clearBtn.style.flex='1'; clearBtn.style.padding='6px'; clearBtn.style.fontSize='12px'; clearBtn.style.cursor='pointer'; clearBtn.style.background='#b33'; clearBtn.style.color='#fff';
              // Optional sync indicator toggle (hidden by default, opt-in)
              const syncToggleContainer = document.createElement('div'); syncToggleContainer.style.display = 'flex'; syncToggleContainer.style.alignItems = 'center'; syncToggleContainer.style.gap = '6px';
              const syncToggle = document.createElement('input'); syncToggle.type = 'checkbox'; syncToggle.id = 'score-editor-show-sync-indicator';
              const syncLabel = document.createElement('label'); syncLabel.htmlFor = 'score-editor-show-sync-indicator'; syncLabel.style.fontSize = '12px'; syncLabel.style.color = '#333'; syncLabel.textContent = 'Show local vs file sync';
              syncToggleContainer.appendChild(syncToggle); syncToggleContainer.appendChild(syncLabel);
              // place toggle to the left of the buttons
              const leftGroup = document.createElement('div'); leftGroup.style.display='flex'; leftGroup.style.gap='8px'; leftGroup.style.flex='1'; leftGroup.appendChild(syncToggleContainer);
              const rightGroup = document.createElement('div'); rightGroup.style.display='flex'; rightGroup.style.gap='8px'; rightGroup.style.flex='2'; rightGroup.appendChild(reloadBtn); rightGroup.appendChild(clearBtn);
              dbgContainer.appendChild(leftGroup); dbgContainer.appendChild(rightGroup); panel.appendChild(dbgContainer);
              // Load persisted toggle state
              try{ const raw = localStorage.getItem('scoreEditorShowSyncIndicator'); if (raw) syncToggle.checked = (raw === 'true'); }catch(e){}
              // Badge no longer shows by default - only during Apply confirmation
              syncToggle.addEventListener('change', ()=>{ try{ localStorage.setItem('scoreEditorShowSyncIndicator', syncToggle.checked ? 'true' : 'false'); updateDebugPanel(); }catch(e){} });
              // Handlers
              reloadBtn.addEventListener('click', ()=>{
                try{
                  // read inline JSON block and overwrite mergedQuizScores and LS
                  const el = document.getElementById('merged-quiz-scores-json');
                  if (!el) { showToast('Inline JSON block not found',3000); return; }
                  const payload = JSON.parse(el.textContent || '{}');
                  Object.keys(payload).forEach(k=>{ mergedQuizScores[k] = { correct: payload[k].correct||0, total: payload[k].total||0 }; });
                  const payloadToStore = {};
                  Object.keys(mergedQuizScores).forEach(k=>{ payloadToStore[k] = { correct: mergedQuizScores[k].correct||0, total: mergedQuizScores[k].total||0 }; });
                  try{ localStorage.setItem('mergedQuizScores', JSON.stringify(payloadToStore)); }catch(e){}
                  try{ window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payloadToStore })); }catch(e){}
                  updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker(); updateDebugPanel(); showToast('Reloaded mergedQuizScores from inline JSON',3000);
                }catch(e){ showToast('Reload failed'); }
              });
              clearBtn.addEventListener('click', ()=>{
                try{ localStorage.removeItem('mergedQuizScores'); showToast('Cleared mergedQuizScores from localStorage',3000); updateDebugPanel(); // reload from inline
                  try{ loadMergedQuizScoresFromJson(); updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker(); }catch(e){}
                }catch(e){ showToast('Clear failed'); }
              });
            }catch(e){}

            // undo handler: restore last snapshot saved by Apply (one-step undo)
            if (undoBtnEl) {
              undoBtnEl.addEventListener('click', () => {
                try{
                  const raw = localStorage.getItem('lastScoreEditorSnapshot');
                  if (!raw) { showToast('Nothing to undo'); return; }
                  const prev = JSON.parse(raw);
                  // restore values into mergedQuizScores
                  Object.keys(prev).forEach(k => { mergedQuizScores[k] = { correct: prev[k].correct || 0, total: prev[k].total || 0 }; });
                  const payload = {};
                  Object.keys(mergedQuizScores).forEach(k => { payload[k] = { correct: mergedQuizScores[k].correct || 0, total: mergedQuizScores[k].total || 0 }; });
                  const el = document.getElementById('merged-quiz-scores-json'); if (el) el.textContent = JSON.stringify(payload, null, 2);
                  try { localStorage.setItem('mergedQuizScores', JSON.stringify(payload)); } catch(e){}
                  try { window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payload })); } catch(e){}
                  updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker();
                  showToast('Undo: restored previous merged scores');
                  disableUndo();
                  updateDebugPanel();
                }catch(e){ showToast('Undo failed'); }
              });
            }

            const applyBtn = document.getElementById('score-editor-apply');
            const saveBtn = document.getElementById('score-editor-save');
            const inCorrect = document.getElementById('score-editor-add-correct');
            const inTotal = document.getElementById('score-editor-add-total');
            const inSource = document.getElementById('score-editor-source');
            const inQuizName = document.getElementById('score-editor-quiz-name');
            const msg = document.getElementById('score-editor-msg');

            // Store pending apply data for confirmation modal
            let pendingApply = null;

            applyBtn.addEventListener('click', () => {
              const domain = select.value;
              const deltaC = parseInt(inCorrect.value || 0, 10);
              const deltaT = parseInt(inTotal.value || 0, 10);
              if (!domain || (deltaC === 0 && deltaT === 0)) { msg.textContent = 'Enter numbers to add or subtract.'; return; }
              const data = mergedQuizScores[domain];
              if (!data) { msg.textContent = 'Unknown domain.'; return; }

              // Calculate preview values
              const newCorrect = Math.max(0, Math.round((data.correct || 0) + (isNaN(deltaC) ? 0 : deltaC)));
              const newTotal = Math.max(0, Math.round((data.total || 0) + (isNaN(deltaT) ? 0 : deltaT)));
              const finalCorrect = Math.min(newCorrect, newTotal);
              const currentPct = data.total ? Math.round((data.correct / data.total) * 100) : 0;
              const newPct = newTotal ? Math.round((finalCorrect / newTotal) * 100) : 0;

              // Check for destructive changes (resetting or large reductions)
              const isDestructive = newTotal === 0 || (deltaT < -10 && newTotal < (data.total || 0) / 2);
              const isReset = newTotal === 0 && newCorrect === 0;

              // Build preview HTML showing current merged scores + proposed change
              const previewEl = document.getElementById('apply-score-preview');
              if (previewEl) {
                let html = `<div style="margin-bottom:10px;"><strong style="color:#0078d4;">${domain}</strong></div>`;
                html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;">`;
                html += `<div style="padding:8px;background:#fff;border-radius:4px;border:1px solid #ddd;">
                  <div style="color:#666;font-size:11px;">Current</div>
                  <div style="font-weight:600;color:#333;">${data.correct || 0}/${data.total || 0} (${currentPct}%)</div>
                </div>`;
                const afterBg = isDestructive ? '#fff3cd' : '#e8f5e9';
                const afterBorder = isDestructive ? '#ff9800' : '#4caf50';
                const afterColor = isDestructive ? '#e65100' : '#2e7d32';
                html += `<div style="padding:8px;background:${afterBg};border-radius:4px;border:1px solid ${afterBorder};">
                  <div style="color:${afterColor};font-size:11px;">After Update</div>
                  <div style="font-weight:600;color:${afterColor};">${finalCorrect}/${newTotal} (${newPct}%)</div>
                </div>`;
                html += `</div>`;
                html += `<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e0e0e0;font-size:12px;color:#666;">`;
                html += `Change: <strong>${deltaC >= 0 ? '+' + deltaC : deltaC}</strong> correct, <strong>${deltaT >= 0 ? '+' + deltaT : deltaT}</strong> total`;
                html += `</div>`;
                if (isReset) {
                  html += `<div style="margin-top:10px;padding:10px;background:#ffebee;border-radius:4px;border:1px solid #f44336;color:#c62828;font-size:12px;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> This will reset all scores to zero. You can undo this action.
                  </div>`;
                } else if (isDestructive) {
                  html += `<div style="margin-top:10px;padding:10px;background:#fff3cd;border-radius:4px;border:1px solid #ff9800;color:#e65100;font-size:12px;">
                    <i class="fas fa-exclamation-circle"></i> <strong>Note:</strong> This is a large reduction. You can undo this action.
                  </div>`;
                }
                previewEl.innerHTML = html;
              }

              // Store pending apply for confirmation
              pendingApply = { domain, deltaC, deltaT, source: inSource ? inSource.value : '', quizName: inQuizName ? inQuizName.value : '' };

              // Show confirmation modal
              const applyModal = document.getElementById('apply-score-modal');
              if (applyModal) applyModal.style.display = 'flex';
            });

            // Apply confirmation modal handlers
            const applyModal = document.getElementById('apply-score-modal');
            if (applyModal) {
              const cancelBtn = document.getElementById('apply-score-cancel');
              const confirmBtn = document.getElementById('apply-score-confirm');
              
              cancelBtn && cancelBtn.addEventListener('click', () => {
                applyModal.style.display = 'none';
                pendingApply = null;
              });

              confirmBtn && confirmBtn.addEventListener('click', () => {
                if (!pendingApply) { applyModal.style.display = 'none'; return; }
                
                const { domain, deltaC, deltaT, source, quizName } = pendingApply;
                const data = mergedQuizScores[domain];

                // Capture a snapshot for one-step undo (persist to localStorage)
                try{
                  const prev = JSON.stringify(mergedQuizScores);
                  localStorage.setItem('lastScoreEditorSnapshot', prev);
                  enableUndo();
                }catch(e){}

                // apply deltas (allow negative values for subtraction)
                data.correct = (data.correct || 0) + (isNaN(deltaC) ? 0 : deltaC);
                data.total = (data.total || 0) + (isNaN(deltaT) ? 0 : deltaT);
                // Normalize values: totals and corrects cannot be negative; correct cannot exceed total
                data.total = Math.max(0, Math.round(data.total));
                data.correct = Math.max(0, Math.round(data.correct));
                if (data.correct > data.total) data.correct = data.total;

                // Persist current selections and blend, and persist mergedQuizScores to localStorage and inline JSON
                try{ saveFlashcardState(); saveScoreEditorBlend(); }catch(e){}
                try {
                  const payload = {};
                  Object.keys(mergedQuizScores).forEach(k => { payload[k] = { correct: mergedQuizScores[k].correct || 0, total: mergedQuizScores[k].total || 0 }; });
                  // update inline script block so Save later matches current state
                  const el = document.getElementById('merged-quiz-scores-json');
                  if (el) el.textContent = JSON.stringify(payload, null, 2);
                  try { localStorage.setItem('mergedQuizScores', JSON.stringify(payload)); } catch(e){}
                  try { window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payload })); } catch(e){}
                } catch(e){}

                // re-run adjusted/confidence and UI
                updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker();
                msg.textContent = `Applied ${deltaC >= 0 ? '+'+deltaC : deltaC} correct, ${deltaT >= 0 ? '+'+deltaT : deltaT} total to ${domain}. New: ${data.correct}/${data.total}.`;
                inCorrect.value = ''; inTotal.value = '';

                // Save domain metadata (source, quiz name, timestamp)
                try {
                  saveDomainMetadata(domain, source, quizName);
                  updateScoreEditorLastUpdated(domain);
                } catch(e) {}

                // UI helpers
                showToast(`Applied changes to ${domain}`);
                try{ pushMergedQuizHistory('apply'); }catch(e){}
                updateDebugPanel();

                // Close modal and clear pending
                applyModal.style.display = 'none';
                pendingApply = null;
              });
            }

            // blend tip toggle
            const blendTipBtn = document.getElementById('blend-tip-btn');
            const blendTip = document.getElementById('blend-tip');
            if (blendTipBtn && blendTip) blendTipBtn.addEventListener('click', () => { blendTip.style.display = blendTip.style.display === 'none' ? 'block' : 'none'; });

            // --- Cloud Sync Functionality ---
            const SYNC_USER_KEY = 'az104SyncUserId';
            const apiBase = (window.AZ104_API_CONFIG && window.AZ104_API_CONFIG.baseUrl) || '';
            
            function getSyncUserId() {
              return localStorage.getItem(SYNC_USER_KEY);
            }
            
            function setSyncUserId(userId) {
              localStorage.setItem(SYNC_USER_KEY, userId);
            }
            
            function clearSyncUserId() {
              localStorage.removeItem(SYNC_USER_KEY);
            }
            
            function updateSyncUI() {
              const userId = getSyncUserId();
              const notConnected = document.getElementById('sync-not-connected');
              const connected = document.getElementById('sync-connected');
              const userIdDisplay = document.getElementById('sync-user-id-display');
              
              if (userId) {
                if (notConnected) notConnected.style.display = 'none';
                if (connected) connected.style.display = 'block';
                if (userIdDisplay) userIdDisplay.textContent = userId;
              } else {
                if (notConnected) notConnected.style.display = 'block';
                if (connected) connected.style.display = 'none';
              }
            }
            
            function setSyncStatus(message, isError = false) {
              const statusEl = document.getElementById('sync-status');
              if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = isError ? '#dc3545' : '#28a745';
              }
            }
            
            // Toggle cloud sync panel
            const cloudSyncToggle = document.getElementById('cloud-sync-toggle');
            const cloudSyncArea = document.getElementById('cloud-sync-area');
            if (cloudSyncToggle && cloudSyncArea) {
              cloudSyncToggle.addEventListener('click', () => {
                cloudSyncArea.style.display = cloudSyncArea.style.display === 'none' ? 'block' : 'none';
                updateSyncUI();
              });
            }
            
            // Create new sync ID
            const createIdBtn = document.getElementById('sync-create-id');
            if (createIdBtn) {
              createIdBtn.addEventListener('click', async () => {
                try {
                  createIdBtn.disabled = true;
                  createIdBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                  
                  const response = await fetch(apiBase + '/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                  });
                  
                  const data = await response.json();
                  if (data.userId) {
                    setSyncUserId(data.userId);
                    updateSyncUI();
                    showToast('Sync ID created! Save this ID to sync on other devices.');
                  } else {
                    throw new Error(data.error || 'Failed to create ID');
                  }
                } catch (e) {
                  showToast('Failed to create sync ID: ' + e.message);
                } finally {
                  createIdBtn.disabled = false;
                  createIdBtn.innerHTML = '<i class="fas fa-plus"></i> Create Sync ID';
                }
              });
            }
            
            // Use existing sync ID
            const useExistingBtn = document.getElementById('sync-use-existing');
            const existingIdInput = document.getElementById('sync-existing-id');
            if (useExistingBtn && existingIdInput) {
              useExistingBtn.addEventListener('click', () => {
                const userId = existingIdInput.value.trim();
                if (!userId) {
                  showToast('Please enter a sync ID');
                  return;
                }
                if (!userId.startsWith('user_')) {
                  showToast('Invalid sync ID format');
                  return;
                }
                setSyncUserId(userId);
                updateSyncUI();
                showToast('Connected to sync ID');
              });
            }
            
            // Copy sync ID
            const copyIdBtn = document.getElementById('sync-copy-id');
            if (copyIdBtn) {
              copyIdBtn.addEventListener('click', () => {
                const userId = getSyncUserId();
                if (userId) {
                  navigator.clipboard.writeText(userId).then(() => {
                    showToast('Sync ID copied to clipboard');
                  }).catch(() => {
                    showToast('Failed to copy');
                  });
                }
              });
            }
            
            // Push scores to cloud
            const pushBtn = document.getElementById('sync-push');
            if (pushBtn) {
              pushBtn.addEventListener('click', async () => {
                const userId = getSyncUserId();
                if (!userId) return;
                
                try {
                  pushBtn.disabled = true;
                  pushBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                  
                  const syncData = {
                    mergedQuizScores: JSON.parse(localStorage.getItem('mergedQuizScores') || '{}'),
                    domainScoreMetadata: JSON.parse(localStorage.getItem('domainScoreMetadata') || '{}'),
                    mergedQuizHistory: JSON.parse(localStorage.getItem('mergedQuizHistory') || '[]'),
                    sourceRotationData: JSON.parse(localStorage.getItem('sourceRotationData') || '{}')
                  };
                  
                  const response = await fetch(apiBase + '/api/sync', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, data: syncData })
                  });
                  
                  const result = await response.json();
                  if (result.success) {
                    setSyncStatus('Pushed at ' + new Date().toLocaleTimeString());
                    showToast('Scores pushed to cloud');
                  } else {
                    throw new Error(result.error || 'Push failed');
                  }
                } catch (e) {
                  setSyncStatus('Push failed: ' + e.message, true);
                  showToast('Failed to push: ' + e.message);
                } finally {
                  pushBtn.disabled = false;
                  pushBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Push';
                }
              });
            }
            
            // Pull scores from cloud
            const pullBtn = document.getElementById('sync-pull');
            if (pullBtn) {
              pullBtn.addEventListener('click', async () => {
                const userId = getSyncUserId();
                if (!userId) return;
                
                try {
                  pullBtn.disabled = true;
                  pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                  
                  const response = await fetch(apiBase + '/api/sync?userId=' + encodeURIComponent(userId));
                  const result = await response.json();
                  
                  if (!result.found) {
                    setSyncStatus('No data found in cloud', true);
                    showToast('No cloud data found - push first');
                    return;
                  }
                  
                  let cloudData = result.data;
                  
                  // Handle case where data might be double-stringified
                  if (typeof cloudData === 'string') {
                    try { cloudData = JSON.parse(cloudData); } catch(e) {}
                  }
                  
                  if (cloudData && typeof cloudData.mergedQuizScores === 'object' && cloudData.mergedQuizScores !== null) {
                    localStorage.setItem('mergedQuizScores', JSON.stringify(cloudData.mergedQuizScores));
                    Object.keys(cloudData.mergedQuizScores).forEach(k => {
                      if (typeof cloudData.mergedQuizScores[k] === 'object') {
                        mergedQuizScores[k] = cloudData.mergedQuizScores[k];
                      }
                    });
                  }
                  if (cloudData && typeof cloudData.domainScoreMetadata === 'object') {
                    localStorage.setItem('domainScoreMetadata', JSON.stringify(cloudData.domainScoreMetadata));
                  }
                  if (cloudData && Array.isArray(cloudData.mergedQuizHistory)) {
                    localStorage.setItem('mergedQuizHistory', JSON.stringify(cloudData.mergedQuizHistory));
                  }
                  if (cloudData && typeof cloudData.sourceRotationData === 'object') {
                    localStorage.setItem('sourceRotationData', JSON.stringify(cloudData.sourceRotationData));
                  }
                  
                  renderDomainProgress();
                  updateNextStepsTracker();
                  setSyncStatus('Pulled at ' + new Date().toLocaleTimeString());
                  showToast('Scores pulled from cloud');
                  
                } catch (e) {
                  setSyncStatus('Pull failed: ' + e.message, true);
                  showToast('Failed to pull: ' + e.message);
                } finally {
                  pullBtn.disabled = false;
                  pullBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Pull';
                }
              });
            }
            
            // Disconnect
            const disconnectBtn = document.getElementById('sync-disconnect');
            if (disconnectBtn) {
              disconnectBtn.addEventListener('click', () => {
                if (confirm('Disconnect from cloud sync? Your local data will remain.')) {
                  clearSyncUserId();
                  updateSyncUI();
                  showToast('Disconnected from cloud sync');
                }
              });
            }
            
            // Initialize sync UI on load
            updateSyncUI();

            // Save: open confirmation modal; actual save happens on confirm
            saveBtn.addEventListener('click', () => {
              const modal = document.getElementById('score-save-modal');
              if (modal) modal.style.display = 'flex';
            });
            // Modal handlers
            const modal = document.getElementById('score-save-modal');
            if (modal) {
              const cancel = document.getElementById('score-save-cancel');
              const confirm = document.getElementById('score-save-confirm');
              cancel && cancel.addEventListener('click', () => { modal.style.display = 'none'; });
              confirm && confirm.addEventListener('click', () => {
                // perform save same as before
                try {
                  // write the current mergedQuizScores into the inline JSON script
                  const el = document.getElementById('merged-quiz-scores-json');
                  if (!el) { msg.textContent = 'Save failed: internal element not found.'; modal.style.display='none'; return; }
                  const payload = {};
                  Object.keys(mergedQuizScores).forEach(k => { payload[k] = { correct: mergedQuizScores[k].correct || 0, total: mergedQuizScores[k].total || 0 }; });
                  el.textContent = JSON.stringify(payload, null, 2);
                  try { localStorage.setItem('mergedQuizScores', JSON.stringify(payload)); } catch (e) { /* ignore storage failures */ }
                  // dispatch a storage-like event for same-window listeners
                  try { window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payload })); } catch(e){}
                  msg.textContent = 'Saved changes in-page and to localStorage. To persist to disk, choose "Save Page As..." in your browser and overwrite the file.';
                  showToast('Saved changes to merged quiz scores');
                  try{ pushMergedQuizHistory('save'); }catch(e){}
                  updateDebugPanel();
                } catch (e) { msg.textContent = 'Save failed: ' + (e && e.message); }
                modal.style.display = 'none';
              });
            }

            function buildMergedQuizScoresBlock(){
              // Build a string: const mergedQuizScores = { ... };
              const parts = Object.keys(mergedQuizScores).map(k => {
                const v = mergedQuizScores[k] || { correct:0, total:0 };
                return `  ${k}: { correct: ${v.correct || 0}, total: ${v.total || 0} }`;
              });
              return 'const mergedQuizScores = {\n' + parts.join(',\n') + '\n};';
            }

            // --- Persistence helpers: flashcard state (checkbox + confidence) and blend ---
            const FLASHCARD_STATE_KEY = 'quizFlashcardState';
            const SCORE_BLEND_KEY = 'scoreEditorBlend';
            const AUTO_COLLAPSE_KEY = 'scoreEditorAutoCollapse';

            function loadFlashcardState(){
              try{
                const raw = localStorage.getItem(FLASHCARD_STATE_KEY);
                if (!raw) return;
                const state = JSON.parse(raw);
                Object.keys(state).forEach(itemId => {
                  try{
                    const cb = document.getElementById(itemId);
                    if (cb && typeof state[itemId].checked !== 'undefined'){
                      cb.checked = !!state[itemId].checked;
                      const li = cb.closest('li.flashcard-item');
                      if (li) {
                        if (cb.checked) li.classList.add('reviewed'); else li.classList.remove('reviewed');
                      }
                    }
                    const sel = document.querySelector(`select.confidence-select[data-item-id="${itemId}"]`);
                    if (sel && state[itemId].confidence){
                      sel.value = state[itemId].confidence;
                      ['none','weak','medium','strong'].forEach(c=>sel.classList.remove(c));
                      if (state[itemId].confidence) sel.classList.add(state[itemId].confidence);
                    }
                  }catch(e){}
                });
              }catch(e){}
            }

            function saveFlashcardState(){
              try{
                const state = {};
                document.querySelectorAll('.flashcard-item').forEach(li => {
                  const cb = li.querySelector('input[type="checkbox"]');
                  if (!cb || !cb.id) return;
                  const sel = li.querySelector('select.confidence-select');
                  state[cb.id] = { checked: !!cb.checked, confidence: sel ? (sel.value || 'none') : 'none' };
                });
                localStorage.setItem(FLASHCARD_STATE_KEY, JSON.stringify(state));
              }catch(e){}
            }

            function loadScoreEditorBlend(){
              try{
                const v = localStorage.getItem(SCORE_BLEND_KEY);
                const sel = document.getElementById('score-editor-blend');
                if (sel && v) sel.value = v;
              }catch(e){}
            }

            function saveScoreEditorBlend(){
              try{
                const sel = document.getElementById('score-editor-blend');
                if (sel) localStorage.setItem(SCORE_BLEND_KEY, sel.value);
              }catch(e){}
            }

            function loadScoreEditorAutoCollapse(){
              try{
                const v = localStorage.getItem(AUTO_COLLAPSE_KEY);
                const el = document.getElementById('score-editor-autocollapse');
                if (el) {
                  if (v === null) {
                    // default: enabled (true) for a cleaner single-card focus
                    el.checked = true;
                  } else {
                    el.checked = (v === 'true');
                  }
                }
              }catch(e){}
            }

            function saveScoreEditorAutoCollapse(){
              try{
                const el = document.getElementById('score-editor-autocollapse');
                if (!el) return;
                localStorage.setItem(AUTO_COLLAPSE_KEY, el.checked ? 'true' : 'false');
              }catch(e){}
            }

            function loadScoreEditorRevalAutosave(){
              try{
                const v = localStorage.getItem('scoreEditorRevalAutosave');
                const el = document.getElementById('score-editor-reval-autosave');
                if (el) {
                  el.checked = (v === 'true');
                }
              }catch(e){}
            }

              // --- Domain Metadata (last updated, source, quiz name) ---
              const DOMAIN_META_KEY = 'domainScoreMetadata';
              const STALE_DAYS_THRESHOLD = 14;

              function getDomainMetadata() {
                try {
                  const raw = localStorage.getItem(DOMAIN_META_KEY);
                  return raw ? JSON.parse(raw) : {};
                } catch(e) { return {}; }
              }

              function saveDomainMetadata(domain, source, quizName) {
                try {
                  const meta = getDomainMetadata();
                  meta[domain] = {
                    lastUpdated: new Date().toISOString(),
                    source: source || '',
                    quizName: quizName || ''
                  };
                  localStorage.setItem(DOMAIN_META_KEY, JSON.stringify(meta));
                } catch(e) {}
              }

              function getDaysAgo(isoDate) {
                if (!isoDate) return null;
                const then = new Date(isoDate);
                const now = new Date();
                const diff = Math.floor((now - then) / (1000 * 60 * 60 * 24));
                return diff;
              }

              function formatLastUpdated(isoDate) {
                if (!isoDate) return 'Never updated';
                const d = new Date(isoDate);
                const days = getDaysAgo(isoDate);
                const dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                if (days === 0) return `Today (${dateStr})`;
                if (days === 1) return `Yesterday (${dateStr})`;
                return `${days} days ago (${dateStr})`;
              }

              function updateScoreEditorLastUpdated(domain) {
                const container = document.getElementById('score-editor-last-updated');
                const textEl = document.getElementById('score-editor-last-updated-text');
                const staleBadge = document.getElementById('score-editor-stale-badge');
                const sourceSelect = document.getElementById('score-editor-source');
                const quizNameInput = document.getElementById('score-editor-quiz-name');
                if (!container || !textEl) return;

                const meta = getDomainMetadata();
                const domainMeta = meta[domain] || {};

                // Hydrate source and quiz name fields with saved values
                if (sourceSelect) {
                  sourceSelect.value = domainMeta.source || '';
                }
                if (quizNameInput) {
                  quizNameInput.value = domainMeta.quizName || '';
                }

                if (!domainMeta.lastUpdated) {
                  container.style.display = 'block';
                  textEl.innerHTML = '<strong style="color:#e74c3c">Never updated</strong> - Enter quiz scores above';
                  staleBadge.style.display = 'inline';
                  staleBadge.textContent = 'NEW';
                  staleBadge.style.background = '#e74c3c';
                  return;
                }

                const days = getDaysAgo(domainMeta.lastUpdated);
                const isStale = days >= STALE_DAYS_THRESHOLD;
                container.style.display = 'block';

                let info = formatLastUpdated(domainMeta.lastUpdated);
                if (domainMeta.source) info += ` | ${domainMeta.source}`;
                if (domainMeta.quizName) info += `: ${domainMeta.quizName}`;
                textEl.textContent = info;

                if (isStale) {
                  staleBadge.style.display = 'inline';
                  staleBadge.textContent = 'STALE';
                  staleBadge.style.background = '#f39c12';
                } else {
                  staleBadge.style.display = 'none';
                }
              }

              // --- Retention history (trend scope) helpers ---
              const HISTORY_KEY = 'mergedQuizHistory';
              const HISTORY_MAX_KEY = 'mergedQuizHistoryMax';
              const HISTORY_VERSION = 2;

              function normalizeHistorySnapshot(snap) {
                if (snap.version === 2 && snap.merged) return snap;
                if (snap.domainPercents) {
                  const merged = {};
                  Object.keys(snap.domainPercents).forEach(k => {
                    merged[k] = { correct: 0, total: 0, percent: snap.domainPercents[k] };
                  });
                  return { version: 2, takenAt: snap.t, source: snap.source || 'migrated', merged };
                }
                return snap;
              }

              function pushMergedQuizHistory(source){
                try{
                  const raw = localStorage.getItem(HISTORY_KEY);
                  let arr = raw ? JSON.parse(raw) : [];
                  arr = arr.map(normalizeHistorySnapshot);
                  const merged = {};
                  let totalCorrect = 0, totalQuestions = 0;
                  Object.keys(mergedQuizScores).forEach(k => {
                    const d = mergedQuizScores[k] || { correct: 0, total: 0 };
                    const pct = d.total ? Math.round((d.correct / d.total) * 100) : 0;
                    merged[k] = { correct: d.correct, total: d.total, percent: pct };
                    totalCorrect += d.correct;
                    totalQuestions += d.total;
                  });
                  const overallPct = totalQuestions ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
                  arr.push({
                    version: HISTORY_VERSION,
                    takenAt: (new Date()).toISOString(),
                    source: source || 'manual',
                    merged: merged,
                    summary: { totalCorrect, totalQuestions, overallPercent: overallPct }
                  });
                  const max = parseInt(localStorage.getItem(HISTORY_MAX_KEY)) || 30;
                  while(arr.length > max) arr.shift();
                  try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }catch(e){}
                }catch(e){}
              }

              function getPercentFromSnapshot(snap, domain) {
                if (snap.merged && snap.merged[domain]) {
                  const d = snap.merged[domain];
                  return typeof d.percent === 'number' ? d.percent : (d.total ? Math.round((d.correct / d.total) * 100) : 0);
                }
                if (snap.domainPercents && typeof snap.domainPercents[domain] === 'number') {
                  return snap.domainPercents[domain];
                }
                return null;
              }

              // Consolidate history entries by day to avoid spikes from multiple saves
              // Takes the LAST entry per day (final score after all corrections)
              function consolidateHistoryByDay(history) {
                const byDay = {};
                history.forEach(snap => {
                  if (!snap.takenAt) return;
                  const day = snap.takenAt.split('T')[0]; // Get just the date part
                  byDay[day] = snap; // Last entry for each day wins
                });
                return Object.values(byDay).sort((a, b) => 
                  new Date(a.takenAt).getTime() - new Date(b.takenAt).getTime()
                );
              }
              
              function computeTrendMetrics(domain){
                try{
                  const raw = localStorage.getItem(HISTORY_KEY);
                  if (!raw) return null;
                  const history = JSON.parse(raw);
                  // Consolidate by day to avoid spikes from add/subtract corrections
                  const consolidatedHistory = consolidateHistoryByDay(history);
                  const arr = consolidatedHistory.map(s => getPercentFromSnapshot(s, domain)).filter(v => v != null);
                  if (!arr.length) return null;
                  const first = arr[0];
                  const last = arr[arr.length - 1];
                  const delta = last - first;
                  const slope = arr.length > 1 ? delta / (arr.length - 1) : 0;
                  const maWindow = 3;
                  const windowVals = arr.slice(-maWindow);
                  const ma = Math.round(windowVals.reduce((a,b)=>a+b,0) / windowVals.length);
                  return { first, last, delta, slope, samples: arr, ma };
                }catch(e){ return null; }
              }

              function renderRetentionTrends(){
                try{
                  const containerId = 'retention-trends-container';
                  let container = document.getElementById(containerId);
                  if (!container){
                    // create a simple card and insert near the top of the card-container
                    const cardContainer = document.querySelector('.card-container');
                    if (!cardContainer) return;
                    const card = document.createElement('div'); card.className='card'; card.id='retention-trends-card';
                    card.innerHTML = `
                      <input type="checkbox" id="retention-trends-toggle" class="card-toggle" checked />
                      <label for="retention-trends-toggle" class="card-header lab-header"><h2><i class="fas fa-history"></i>Retention Trends</h2><i class="fas fa-chevron-down toggle-icon"></i></label>
                      <div class="card-content"><div id="${containerId}">Loading...</div></div>
                    `;
                    cardContainer.insertBefore(card, cardContainer.firstChild);
                    container = document.getElementById(containerId);
                  }
                  // build content - consolidate by day to show net progress
                  const raw = localStorage.getItem(HISTORY_KEY);
                  const history = raw ? JSON.parse(raw) : [];
                  const consolidatedHistory = consolidateHistoryByDay(history);
                  if (!consolidatedHistory.length) { container.innerHTML = '<p style="color:#666">No study history yet â€” trends will appear when you save scores.</p>'; return; }
                  const domains = Object.keys(mergedQuizScores);
                  const rows = domains.map(domain => {
                    const m = computeTrendMetrics(domain);
                    if (!m) return '';
                    const trendClass = m.delta > 0 ? 'trend-up' : (m.delta < 0 ? 'trend-down' : 'trend-flat');
                    // sparkline simple polyline
                    const samples = m.samples;
                    const w = 120, h = 28, pad = 2;
                    const min = Math.min(...samples), max = Math.max(...samples);
                    const range = Math.max(1, max - min);
                    const points = samples.map((v,i)=>{
                      const x = pad + (i * (w - pad*2) / Math.max(1, samples.length-1));
                      const y = h - pad - ((v - min) * (h - pad*2) / range);
                      return x + ',' + y;
                    }).join(' ');
                    const spark = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg"><polyline fill="none" stroke="#0078d4" stroke-width="2" points="${points}" stroke-linejoin="round" stroke-linecap="round" /></svg>`;
                    const deltaSign = m.delta > 0 ? 'â–²' : (m.delta < 0 ? 'â–¼' : 'â†’');
                    return `
                      <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0f0f0">
                        <div style="flex:1;min-width:160px"><strong>${domainDisplayNames[domain] || domain}</strong><div style="font-size:12px;color:#666">last: ${m.last}% Â· Î” ${deltaSign}${Math.abs(m.delta)}</div></div>
                        <div style="width:140px;text-align:right">${spark}</div>
                      </div>
                    `;
                  }).join('\n');
                  container.innerHTML = rows;
                }catch(e){/* ignore */}
              }

            // Hook into UI elements to persist state idempotently
            function hookPersistenceHandlers(){
              // checkboxes
              document.querySelectorAll('.flashcard-item input[type="checkbox"]').forEach(cb => {
                if (cb.__persistHook) cb.removeEventListener('change', cb.__persistHook);
                const h = () => { try{ saveFlashcardState(); updateNextStepsTracker(); }catch(e){} };
                cb.addEventListener('change', h);
                cb.__persistHook = h;
              });
              // confidence selects: persist selection but do not auto-recompute
              document.querySelectorAll('select.confidence-select').forEach(sel => {
                if (sel.__persistHook) sel.removeEventListener('change', sel.__persistHook);
                const h = () => { try{ saveFlashcardState(); ['none','weak','medium','strong'].forEach(c=>sel.classList.remove(c)); if (sel.value) sel.classList.add(sel.value); }catch(e){} };
                sel.addEventListener('change', h);
                sel.__persistHook = h;
              });
              // blend select
              const blend = document.getElementById('score-editor-blend');
              if (blend){
                if (blend.__persistHook) blend.removeEventListener('change', blend.__persistHook);
                const bh = () => { try{ saveScoreEditorBlend(); }catch(e){} };
                blend.addEventListener('change', bh);
                blend.__persistHook = bh;
              }
              // auto-collapse checkbox persistence
              const ac = document.getElementById('score-editor-autocollapse');
              if (ac) {
                if (ac.__persistHook) ac.removeEventListener('change', ac.__persistHook);
                const ah = () => { try{ saveScoreEditorAutoCollapse(); }catch(e){} };
                ac.addEventListener('change', ah);
                ac.__persistHook = ah;
              }
            }

            // Initialize persisted UI state after the rest of the script sets up the DOM
            try{
              loadScoreEditorBlend();
              loadScoreEditorAutoCollapse();
              try{ loadScoreEditorRevalAutosave(); }catch(e){}
              loadFlashcardState();
              hookPersistenceHandlers();
              // initial debug panel render
              try{ updateDebugPanel(); }catch(e){}
              try{ if (localStorage.getItem('lastScoreEditorSnapshot')) enableUndo(); else disableUndo(); }catch(e){}
            }catch(e){}

          })();

        });
      </script>
  <!-- End consolidated script -->

      <div class="card-container">
        <!-- Card 1: Current Performance Snapshot -->
        <div class="card" id="performance-section">
          <input
            type="checkbox"
            id="performance-snapshot-toggle"
            class="card-toggle"
            checked
          />
          <label
            for="performance-snapshot-toggle"
            class="card-header snapshot-header"
          >
            <h2>
              <i class="fas fa-chart-pie"></i>Current Performance Snapshot
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <h3><i class="fas fa-signal"></i>Your AZ-104 Study Breakdown</h3>
            <p class="snapshot-text">
              <strong>Overall Quiz Score:</strong>
              <span id="overall-quiz-score">Loading...</span><br /><br />
              <strong>Domain Mastery:</strong> (Based on your confidence ratings
              below)
            </p>

            <div id="domain-progress-container">
              <!-- Domain progress bars will be rendered here by JS -->
            </div>
            <div class="flashcard-content-area show" id="personalized-review-essay">
              <h4><i class="fas fa-lightbulb"></i>Personalized Review: Weak Spot Focus</h4>

              <!-- Link to Entra ID Quick Reference (moved to dedicated guide) -->
              <div style="background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;margin:15px 0;border-radius:4px;">
                <h4 style="color:#1976d2;margin:0 0 10px 0;">
                  <i class="fas fa-graduation-cap"></i> Microsoft Entra ID Quick Reference
                </h4>
                <p style="margin:0 0 10px 0;color:#333;">
                  The comprehensive Entra ID cheat sheet (Tutorials Dojo) has been moved to the dedicated guide for easier access.
                </p>
                <a href="microsoft_entra_id_concepts_guide.html#entra-quick-reference" class="domain-action-btn primary" style="display:inline-flex;align-items:center;gap:6px;background:#1976d2;color:#fff;padding:10px 16px;border-radius:6px;text-decoration:none;font-weight:600;">
                  <i class="fas fa-external-link-alt"></i> Open Entra ID Quick Reference
                </a>
              </div>

              <p><strong>Identities & Governance (57% Accuracy) ðŸŸ  Next Focus</strong></p>
              <p><strong>Observation:</strong> Moderate performance with gaps around RBAC vs Entra DS, group-based licensing, B2B guest invites, self-service password reset (SSPR) configurations per group, CLI vs Microsoft Graph commands, and Entra portal navigation.</p>
              <p><strong>Action:</strong> Target flashcards and labs on role assignments, guest/B2B invitations, group licensing, SSPR, and portal navigation. Focus on flashcards marked ðŸŸ .</p>
              <p><strong>Next Steps:</strong> Practice creating users, groups, and roles in labs. Confirm understanding of RBAC vs directory permissions. Recommended labs: Create Users, Groups, Assign Roles, Guest/B2B Invite Flow Lab (link + 20â€“25 min).</p>

              <p><strong>Storage (43% Accuracy) âš  Major Weak Spot</strong></p>
              <p><strong>Observation:</strong> Weaknesses identified in Azure Files authentication, immutability policies, soft delete retention, replication tiers, SMB port/firewall configuration, endpoint selection for secure SMB access, and RBAC vs NTFS alignment.</p>
              <p><strong>Action:</strong> Prioritize flashcards and labs covering RBAC vs NTFS, Entra DS authentication, soft delete, immutable policies, replication, endpoints, firewall/SAS, and backup workflows.</p>
              <p><strong>Next Steps:</strong> Run labs on file recovery, replication, backup, and authentication. Review all Storage flashcards marked âš . Recommended labs: Configure Azure Files Auth & Recovery, Blob Storage Tiering & Snapshots (link + 25â€“30 min).</p>

              <p><strong>Compute (37% Accuracy) âš  Weak Spot</strong></p>
              <p><strong>Observation:</strong> Minor gaps in App Service runtimes, Azure Container Instances (ACI) scaling limitations, VM creation vs migration steps, and Bicep vs portal deployment differences.</p>
              <p><strong>Action:</strong> Review flashcards/labs on VM creation, migration, App Service deployment, and ACI scaling scenarios.</p>
              <p><strong>Next Steps:</strong> Run at least one VM/App Service lab; compare Bicep vs Portal deployment. Recommended labs: Deploy VM & App Service, VM Migration & Disk Snapshot Lab (link + 35â€“40 min).</p>

              <p><strong>Networking (58% Accuracy) âš  Weak Spot</strong></p>
              <p><strong>Observation:</strong> Solid foundational understanding, but review Load Balancer SKU differences, inbound NAT vs LB rules, subnet models (3â€‘tier architecture), NSG/UDR troubleshooting, and Azure DNS Private Zones for internal name resolution.</p>
              <p><strong>Action:</strong> Light review of flashcards and labs on virtual network configuration, routing, NSGs, peering, and load balancing.</p>
              <p><strong>Next Steps:</strong> Practice VNet and routing labs; reinforce IP forwarding and custom route scenarios. Recommended labs: Configure VNet, Subnets, NSGs, Load Balancer & NAT Rules Lab (link + 30â€“40 min).</p>

              <p><strong>Monitoring (54% Accuracy) âš  Minor Weak Spot</strong></p>
              <p><strong>Observation:</strong> Strong domain overall. Minor misses on metrics configuration, Log Analytics queries (KQL), and dashboards/alerts setup.</p>
              <p><strong>Action:</strong> Light review of metrics, logs, and workbooks flashcards; practice using Azure Monitor and Log Analytics queries.</p>
              <p><strong>Next Steps:</strong> Run labs on creating alerts, dashboards, and KQL queries; refresh understanding of monitoring configuration. Recommended labs: Create Alerts and Workbooks, KQL Basics & Log Analytics (link + 25â€“30 min).</p>

              <p><strong>Summary & Recommendations:</strong> Focus on Storage first (major weak spot), reinforce Identities next (ðŸŸ ), then review Compute and Networking. Monitoring is solid; light refresher only. Use the confidence dropdowns to track mastery before the AZâ€‘104 exam.</p>
            </div>

            <div class="az104-tip">
              <i class="fas fa-star"></i>Focus on the "Storage" domain first, as
              it's identified as your major weak spot. Use the flashcards and
              labs below! Mark your confidence level for each item.
            </div>
          </div>
        </div>

        <!-- Apply Score Confirmation Modal -->
        <div id="apply-score-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1500;align-items:flex-start;justify-content:flex-start;padding:20px;">
          <div style="background:#fff;padding:20px;border-radius:10px;max-width:400px;width:100%;box-shadow:0 12px 40px rgba(0,0,0,0.3);margin-left:10px;margin-top:60px;">
            <h3 style="margin-top:0;display:flex;align-items:center;gap:8px;color:#1a1a1a;">
              <i class="fas fa-check-circle" style="color:#27ae60;"></i> Confirm Score Update
            </h3>
            <div id="apply-score-preview" style="background:#f8f9fa;border-radius:8px;padding:14px;margin:12px 0;border:1px solid #e0e0e0;">
              <!-- Preview will be populated dynamically -->
            </div>
            <p style="color:#666;font-size:13px;margin:0 0 16px 0;">This will update your merged quiz scores. You can undo this action.</p>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
              <button id="apply-score-cancel" style="background:#e0e0e0;color:#333;border:0;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:14px;">Cancel</button>
              <button id="apply-score-confirm" style="background:#27ae60;color:#fff;border:0;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;">
                <i class="fas fa-check"></i> Apply Changes
              </button>
            </div>
          </div>
        </div>

        <!-- Confirmation modal (hidden) -->
        <div id="score-save-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:1500;align-items:center;justify-content:center">
          <div style="background:#fff;padding:18px;border-radius:8px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,0.25);">
            <h3 style="margin-top:0">Confirm save</h3>
            <p style="color:#333">Save will produce a downloadable HTML file with the current quiz scores embedded. Proceed?</p>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="score-save-cancel" style="background:#ccc;border:0;padding:8px 10px;border-radius:6px;cursor:pointer">Cancel</button>
              <button id="score-save-confirm" style="background:#27ae60;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer">Confirm & Save</button>
            </div>
          </div>
        </div>

  <!-- Flashcards/Labs Section -->
        <!-- Domain 1: Manage Azure Identities and Governance (Self-contained Focused Card) -->
        <div class="card" id="identities-focused-card">
          <input type="checkbox" id="domain1-toggle" class="card-toggle" />
          <label for="domain1-toggle" class="card-header snapshot-header">
            <h2>
              <i class="fas fa-user-shield"></i>Domain 1: Manage Azure
              Identities and Governance
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Tutorials Dojo Section-Based Assessment - Manage Azure Identities and Governance completed on Nov 14, 2025. Topics covered: Resource group policy inheritance, Azure AD authentication methods, RBAC role assignments, Group-based licensing & roles, Guest/B2B invites and external-to-internal conversion, SSPR methods per group, Entra portal navigation awareness, and Hybrid AD DS authentication.<br />
              <span id="identities-quiz-stats" class="domain-quiz-stats" style="color:#e67e22;font-weight:bold;">âš ï¸ Latest: 10/17 (58.82%) | Cumulative: 35/61 (57.38%)</span>
            </div>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus (Updated Nov 29, 2025):</strong> After scoring 58.82% on Tutorials Dojo Section-Based quiz, priority areas are: Resource group policy inheritance and effects on moved resources, Azure Policy assignment scopes, Group-based licensing & roles, Guest/B2B invites & conversions, Self-service password reset (methods & per-group targeting), Entra portal navigation, RBAC vs Entra DS distinctions, and Azure AD authentication methods for hybrid scenarios.
              <br />
              <strong>Action:</strong> Review Policy inheritance rules (resources retain their region when moved to new RG, but inherit the target RG's policies). Drill into the following flashcards and labs to reinforce these topics. Target 75%+ on next attempt.
            </p>
            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Identities)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#idgov-flash-1" data-highlight-id="idgov-flash-1"
                      >RBAC vs Entra ID/DS Permissions</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#idgov-lab-1" data-highlight-id="idgov-lab-1"
                      >Lab: Create Users, Groups, Assign Roles</a
                    >
                  </span>
                </div>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="idgov-flash-1-li">
                <input type="checkbox" id="idgov-flash-1" />
                <span class="item-text">RBAC vs Entra ID/DS Permissions</span>
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-1">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-user-shield"></i>RBAC vs Entra DS Permissions</h4>
                  <p><strong>Observation:</strong> RBAC controls access to Azure resources at subscription, resource group, or resource level. Entra DS controls OS/app-level identity and authentication (e.g., NTFS, LDAP/Kerberos for Azure Files).</p>
                  <p class="mnemonic-internal"><i class="fas fa-lightbulb"></i>Mnemonic: â€œRBAC = Azure Gatekeeper, Entra DS = Identity Librarianâ€</p>
                  <p><strong>Tip:</strong> Distinguish between resource-level access (RBAC) and file-level access (Entra DS).</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Commonly confused on quizzes â€” review scenarios carefully.</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-2-li">
                <input type="checkbox" id="idgov-flash-2" />
                <span class="item-text">Role Assignment CLI vs Portal</span>
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-2">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-terminal"></i>Role Assignment CLI vs Portal</h4>
                  <p><strong>Observation:</strong> Portal is GUI-based, suited for individual role assignments. CLI allows automation, bulk assignments, and integration into pipelines.</p>
                  <p><strong>Tip:</strong> Use CLI for repeatable scripts; Portal for quick manual assignments.</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-3-li">
                <input type="checkbox" id="idgov-flash-3" />
                <span class="item-text"
                  >RBAC vs Entra DS (AD DS) Deep Dive</span
                >
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-3">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-user-shield"></i>RBAC vs Entra DS (AD DS) Deep Dive</h4>
                  <p><strong>Observation:</strong> RBAC is stateless (ARM-managed) and focuses on who can manage Azure resources. Entra DS is stateful and controls identity/authentication at the OS/file level (e.g., NTFS permissions, Kerberos).</p>
                  <p><strong>Mnemonic:</strong> â€œRBAC = Azure Gatekeeper, Entra DS = Identity Librarianâ€</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Confusing resource-level vs file-level permissions â€” review example scenarios.</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-4-li">
                <input type="checkbox" id="idgov-flash-4" />
                <span class="item-text">CLI vs Microsoft Graph</span>
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-4">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-terminal"></i>CLI vs Microsoft Graph</h4>
                  <p><strong>Observation:</strong> CLI is procedural for Azure tasks; Microsoft Graph is the REST API for Microsoft 365/Entra ID automation.</p>
                  <p><strong>Mnemonic:</strong> â€œCLI = hammer, Graph = blueprintâ€</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-5-li">
                <input type="checkbox" id="idgov-flash-5" />
                <span class="item-text"
                  >RBAC Scope Levels (Sub, RG, Resource)</span
                >
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-5">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-sitemap"></i>RBAC Scope Levels (Sub, RG, Resource)</h4>
                  <p><strong>Observation:</strong> Role assignments apply at subscription, resource group, or resource level and are inherited down the scope. Assign least privilege at the lowest necessary scope.</p>
                  <p class="mnemonic-internal"><i class="fas fa-lightbulb"></i>Mnemonic: â€œScope = Sub â†’ Group â†’ Resource (SGR)â€</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-6-li">
                <input type="checkbox" id="idgov-flash-6" />
                <span class="item-text"
                  >Azure Files with Entra DS Authentication</span
                >
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-6">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-key"></i>Azure Files with Entra DS Authentication</h4>
                  <p><strong>Observation:</strong> Combine Azure RBAC and NTFS permissions for secure access. Configure Kerberos for SMB and ensure users are domain members with appropriate permissions.</p>
                  <p class="mnemonic-internal"><i class="fas fa-lightbulb"></i>Mnemonic: â€œAzure Files Auth = Domain + Double Permissionsâ€</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Frequently missed on quizzes â€” review the authentication setup steps.</p>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 2: Implement and Manage Storage (Self-contained Focused Card) -->
        <div class="card" id="storage-focused-card">
          <input type="checkbox" id="domain2-toggle" class="card-toggle" />
          <label for="domain2-toggle" class="card-header flashcard-header">
            <h2>
              <i class="fas fa-database"></i>Domain 2: Implement and Manage
              Storage
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Azure Files identity-based
              access, Soft Delete retention (365 days), Snapshots before
              deletion, Blob Versioning, Object replication prefix filters,
              Private Endpoints, TLS supported versions (1.0â€“1.2), SAS for
              temporary access, Customer-managed keys, Firewall restrictions
              with VNets, endpoint selection for secure SMB access<br />
              <span id="storage-quiz-stats" class="domain-quiz-stats"></span>
            </div>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> Azure Files auth, immutability,
              soft delete, replication tiers, SMB ports.<br />
              <strong>Action:</strong> Use the flashcards and labs below to
              reinforce your storage skills.
            </p>
            <h3><i class="fas fa-dumbbell"></i>Weak Spot Reinforcement</h3>
            <div style="background: #fff8e1; border: 1px solid #ffcc02; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
              <div style="margin-bottom: 15px; padding: 10px; border-left: 4px solid #ff6b35; background: #ffffff;">
                <div style="font-weight: bold; color: #b71c1c; margin-bottom: 5px;">ðŸš¨ Alert: Azure Files identity-based authentication failure</div>
                <div style="margin-bottom: 8px; color: #424242;">
                  â€¢ Verify Entra DS domain join status for the storage account<br />
                  â€¢ Check RBAC assignment: "Storage File Data SMB Share Contributor" role<br />
                  â€¢ Validate NTFS permissions alignment on the share<br />
                  â€¢ Test Kerberos authentication: <code>net use \\storageaccount.file.core.windows.net\share</code><br />
                  â€¢ Review firewall rules and private endpoint configuration
                </div>
                <div style="font-size: 0.9em; color: #6b6b6b; font-style: italic;">
                  <strong>AZ-104 Concept:</strong> Azure Files identity-based auth requires both Azure RBAC (cloud-level) and NTFS permissions (file-level) - this dual-layer security model is frequently tested.
                </div>
              </div>
              
              <div style="margin-bottom: 15px; padding: 10px; border-left: 4px solid #ff6b35; background: #ffffff;">
                <div style="font-weight: bold; color: #b71c1c; margin-bottom: 5px;">ðŸ”„ Alert: Critical file accidentally deleted from Azure Files share</div>
                <div style="margin-bottom: 8px; color: #424242;">
                  â€¢ Check soft delete retention policy status (enabled/disabled)<br />
                  â€¢ Locate deleted file in Azure portal under "Deleted files" section<br />
                  â€¢ Restore from soft delete if within retention period<br />
                  â€¢ If soft delete expired, check available share snapshots<br />
                  â€¢ Implement automated snapshot policy before future changes
                </div>
                <div style="font-size: 0.9em; color: #6b6b6b; font-style: italic;">
                  <strong>AZ-104 Concept:</strong> Soft delete provides time-based protection (up to 365 days) while snapshots offer point-in-time recovery - understanding both mechanisms and their configuration is essential.
                </div>
              </div>
              
              <div style="margin-bottom: 0; padding: 10px; border-left: 4px solid #ff6b35; background: #ffffff;">
                <div style="font-weight: bold; color: #b71c1c; margin-bottom: 5px;">ðŸ’¾ Alert: Storage replication strategy insufficient for disaster recovery</div>
                <div style="margin-bottom: 8px; color: #424242;">
                  â€¢ Assess current RTO/RPO requirements vs. existing replication tier<br />
                  â€¢ Choose LRS for single datacenter, ZRS for zone redundancy within region<br />
                  â€¢ Select GRS for cross-region protection, RA-GRS for read access to secondary<br />
                  â€¢ Consider cost vs. durability trade-offs (LRS: 99.999999999%, GRS: 99.99999999999999%)<br />
                  â€¢ Plan replication tier change during maintenance window if switching
                </div>
                <div style="font-size: 0.9em; color: #6b6b6b; font-style: italic;">
                  <strong>AZ-104 Concept:</strong> Each replication tier serves specific business continuity needs - exam scenarios often test appropriate tier selection based on RTO/RPO and budget constraints.
                </div>
              </div>
            </div>

            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Storage)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#storage-flash-1"
                      data-highlight-id="storage-flash-1"
                      >RBAC vs NTFS Permissions on Azure Files</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#storage-lab-1" data-highlight-id="storage-lab-1"
                      >Lab: Configure Azure Files Auth & Recovery</a
                    >
                  </span>
                </div>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="storage-flash-1-li">
                <input type="checkbox" id="storage-flash-1" />
                <span class="item-text"
                  >RBAC vs NTFS Permissions on Azure Files</span
                >
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-1"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-database"></i>RBAC vs NTFS Permissions on Azure Files</h4>
                  <p><strong>Observation:</strong> RBAC secures access at the Azure resource level; NTFS secures file system level inside Azure Files shares.</p>
                  <p><strong>Mnemonic:</strong> â€œRBAC = cloud access, NTFS = file accessâ€</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Misalignment between RBAC and NTFS often causes quiz mistakes â€” review sequence and configuration steps.</p>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-2-li">
                <input type="checkbox" id="storage-flash-2" />
                <span class="item-text">Soft Delete vs Snapshot</span>
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-2"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-undo"></i>Azure Files Soft Delete & Snapshot Concepts</h4>
                  <p><strong>Observation:</strong> Soft delete retains deleted files for a configurable retention window; snapshots provide point-in-time copies for recovery and versioning.</p>
                  <p><strong>Tip:</strong> Use snapshots before major changes and configure retention to meet recovery objectives.</p>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-3-li">
                <input type="checkbox" id="storage-flash-3" />
                <span class="item-text"
                  >Replication Tiers (LRS, ZRS, GRS, RA-GRS)</span
                >
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-3"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-clone"></i>Replication Tiers (LRS, ZRS, GRS, RA-GRS)</h4>
                  <p><strong>Observation:</strong> LRS keeps copies in a single datacenter; ZRS across zones; GRS replicates to a secondary region; RA-GRS allows read access to secondary. Choose based on durability and RTO/RPO requirements.</p>
                  <p><strong>Tip:</strong> Balance cost vs business continuity needs when choosing replication.</p>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-4-li">
                <input type="checkbox" id="storage-flash-4" />
                <span class="item-text">SMB Ports for Azure Files</span>
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-4"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-plug"></i>SMB Ports for Azure Files</h4>
                  <ul>
                    <li>
                      <strong>Port 445</strong> is required for SMB protocol
                      (Windows file sharing).
                    </li>
                    <li>
                      Many ISPs block outbound 445 to Azure for security
                      reasons.
                    </li>
                    <li>
                      Solutions: Use VPN, ExpressRoute, or Private Endpoint to
                      connect from on-prem.
                    </li>
                    <li>SMB 3.0 required for Azure Files with encryption.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "SMB = 445 Alive"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-5-li">
                <input type="checkbox" id="storage-flash-5" />
                <span class="item-text"
                  >Azure Files Access in VNets (Endpoints & Firewalls)</span
                >
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-5"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-shield-alt"></i>Azure Files Access in VNets
                    (Endpoints & Firewalls)
                  </h4>
                  <ul>
                    <li>
                      Use <strong>private endpoints</strong> to map Azure Files
                      to a VNet (private IP, no public exposure).
                    </li>
                    <li>
                      <strong>Service endpoints</strong> allow secure traffic
                      from VNets to Azure Files over backbone.
                    </li>
                    <li>Firewall rules can restrict access by IP or subnet.</li>
                    <li>
                      For on-premises SMB access, use VPN or ExpressRoute to
                      allow port 445 traffic securely.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Endpoints = Entry
                    Points"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-6-li">
                <input type="checkbox" id="storage-flash-6" />
                <span class="item-text">Immutable Storage Policies (WORM)</span>
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-6"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-lock"></i>Immutable Storage Policies (WORM)
                  </h4>
                  <ul>
                    <li>
                      <strong>WORM</strong> = Write Once, Read Many. Data cannot
                      be modified or deleted during retention period.
                    </li>
                    <li>
                      Set <strong>immutability policy</strong> on a container:
                      <b>time-based retention</b> or <b>legal hold</b>.
                    </li>
                    <li>
                      <strong>Retention lock</strong> can be unlocked only in
                      compliance mode (strict) or governance mode (less strict).
                    </li>
                    <li>
                      Used for regulatory compliance, legal evidence, and audit
                      trails.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Immutable =
                    Written Once, Read Many"
                  </div>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 3: Deploy and Manage Azure Compute Resources (Self-contained Focused Card) -->
        <div class="card" id="compute-focused-card">
          <input type="checkbox" id="domain3-toggle" class="card-toggle" />
          <label for="domain3-toggle" class="card-header lab-header">
            <h2>
              <i class="fas fa-server"></i>Domain 3: Deploy and Manage Azure
              Compute Resources
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <span
              id="compute-quiz-stats"
              class="domain-quiz-stats"
              style="display: block; margin-bottom: 10px"
            ></span>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> Azure Container Apps ingress configuration, VM Scale Sets orchestration modes (Uniform vs Flexible), Availability Sets with update/fault domains, Network Watcher Agent for packet capture, VM Scale Set extensions for software installation.<br />
              <strong>Action:</strong> Use the following flashcards and labs to reinforce compute management. <span style="color: var(--accent-color); font-weight: bold;">Recent quiz: 10/21 (47.62%) - Focus on container apps, scale sets, and network diagnostics.</span>
            </p>
            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Compute)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard (High Priority):</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#compute-flash-5"
                      data-highlight-id="compute-flash-5"
                      >Azure Container Apps Ingress Configuration</a
                    >
                  </span>
                  <span style="font-size: 0.8em; color: var(--accent-color); margin-left: 10px;">Recent Quiz Miss</span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#compute-lab-1" data-highlight-id="compute-lab-1"
                      >Lab: Deploy VM & App Service</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section" style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong><i class="fas fa-exclamation-triangle" style="color: #856404;"></i>Quiz Strategy Tip:</strong>
                <p style="margin: 5px 0; font-size: 0.9em; color: #856404;">Read questions carefully for <em>specific requirements</em> like "same client IP <strong>and protocol</strong>" - these details often determine the correct answer.</p>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="compute-flash-1-li">
                <input type="checkbox" id="compute-flash-1" />
                <span class="item-text">VM Creation vs Migration Steps</span>
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-1"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-server"></i>VM Creation vs Migration</h4>
                  <ul>
                    <li>
                      <strong>Creation:</strong> New VM from image/template
                      (portal, CLI, ARM/Bicep).
                    </li>
                    <li>
                      <strong>Migration:</strong> Use Azure Migrate, import VHD,
                      or site recovery.
                    </li>
                    <li>
                      Migration involves assessment, compatibility check, and
                      network integration.
                    </li>
                  </ul>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-2-li">
                <input type="checkbox" id="compute-flash-2" />
                <span class="item-text">App Service Runtime Options</span>
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-2"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-code"></i>App Service Runtimes</h4>
                  <ul>
                    <li>
                      Supports .NET, Java, Node.js, Python, PHP, Ruby, and
                      custom containers.
                    </li>
                    <li>
                      Choose runtime stack during creation or update in
                      configuration.
                    </li>
                    <li>
                      Linux and Windows hosting plans available for different
                      runtimes.
                    </li>
                    <li>
                      App Service Plan determines scaling and backup options.
                    </li>
                    <li>Backups available on Standard tier and above.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "App Service =
                    Platform Playground"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-3-li">
                <input type="checkbox" id="compute-flash-3" />
                <span class="item-text">VM Migration Order & Encryption</span>
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-3"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-lock"></i>VM Migration & Encryption Steps
                  </h4>
                  <ul>
                    <li>Take a snapshot of the VM OS disk.</li>
                    <li>
                      Encrypt the snapshot or disk if required (Azure Disk
                      Encryption or SSE).
                    </li>
                    <li>
                      Move/copy the disk to destination region/resource group.
                    </li>
                    <li>
                      Create a new VM from the encrypted disk in the target
                      region.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Snapshot â†’
                    Encrypt â†’ Move"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-4-li">
                <input type="checkbox" id="compute-flash-4" />
                <span class="item-text"
                  >Azure Container Instances (ACI) Scaling</span
                >
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-4"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-cube"></i>ACI Scaling Behavior</h4>
                  <ul>
                    <li>
                      ACI (Azure Container Instances) does
                      <strong>not</strong> support in-place scaling.
                    </li>
                    <li>
                      To scale, you must redeploy a new container group with the
                      desired instance count.
                    </li>
                    <li>
                      No built-in load balancer or auto-scaling. For scaling,
                      use AKS or orchestrators.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "ACI = Always
                    Create Instance"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-5-li">
                <input type="checkbox" id="compute-flash-5" />
                <span class="item-text">Azure Container Apps Ingress Configuration</span>
                <span class="item-tag">Compute</span>
                <select class="confidence-select" data-item-id="compute-flash-5">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-network-wired"></i>Container Apps Ingress</h4>
                  <ul>
                    <li><strong>Problem:</strong> Users can't access container app via public IP</li>
                    <li><strong>Solution:</strong> Configure ingress to generate new endpoint with HTTPS</li>
                    <li>Ingress eliminates need for Azure Load Balancer or public IP resources</li>
                    <li>Each container app can have unique ingress configurations</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Remember: "Ingress generates endpoints, not IP restrictions"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-6-li">
                <input type="checkbox" id="compute-flash-6" />
                <span class="item-text">VM Scale Sets Orchestration Modes</span>
                <span class="item-tag">Compute</span>
                <select class="confidence-select" data-item-id="compute-flash-6">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-expand-arrows-alt"></i>Uniform vs Flexible Orchestration</h4>
                  <ul>
                    <li><strong>Uniform:</strong> Uses VM template, scales to desired capacity, large-scale stateless workloads (&lt;100 VMs)</li>
                    <li><strong>Flexible:</strong> High availability with identical/multiple VM types, manually add VMs to scale set (up to 1000 VMs)</li>
                    <li>Uniform = automatic identical instances, Flexible = manual mixed instances</li>
                    <li>Cannot change orchestration mode after creation</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Remember: "Uniform = Uniform instances, Flexible = Flexible types"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-7-li">
                <input type="checkbox" id="compute-flash-7" />
                <span class="item-text">Availability Sets: Update and Fault Domains</span>
                <span class="item-tag">Compute</span>
                <select class="confidence-select" data-item-id="compute-flash-7">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-shield-alt"></i>Domain Configuration for Maintenance</h4>
                  <ul>
                    <li><strong>Update Domains:</strong> For planned maintenance - only 1 domain updated at a time</li>
                    <li><strong>Fault Domains:</strong> For unplanned failures - physical hardware separation</li>
                    <li>For 2+ VMs during maintenance: need 3 update domains + 2 fault domains minimum</li>
                    <li>ARM template: platformUpdateDomainCount=3, platformFaultDomainCount=2</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Remember: "3 Updates for planned, 2 Faults for unplanned"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-8-li">
                <input type="checkbox" id="compute-flash-8" />
                <span class="item-text">Network Watcher Agent for Diagnostics</span>
                <span class="item-tag">Compute</span>
                <select class="confidence-select" data-item-id="compute-flash-8">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-search"></i>Network Performance Troubleshooting</h4>
                  <ul>
                    <li><strong>Requirement:</strong> Install Network Watcher Agent VM extension</li>
                    <li><strong>Capabilities:</strong> Packet capture, IP flow verification, network performance analysis</li>
                    <li>Acts as bridge between VM and Network Watcher service</li>
                    <li>Different from Azure Monitor agent (general monitoring) or Performance Diagnostics (boot issues)</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Remember: "Network Watcher = Network packet capture"
                  </div>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 4: Configure and Manage Virtual Networking (Self-contained Focused Card) -->
        <div class="card" id="networking-focused-card">
          <input type="checkbox" id="domain4-toggle" class="card-toggle" />
          <label for="domain4-toggle" class="card-header snapshot-header">
            <h2>
              <i class="fas fa-network-wired"></i>Domain 4: Configure and Manage
              Virtual Networking
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Azure Storage Firewalls &
              VNets, restricting access to corporate IP ranges and VNets, Azure
              Files private endpoints vs service endpoints, on-prem SMB access
              over VPN/ExpressRoute<br />
              <span id="networking-quiz-stats" class="domain-quiz-stats"></span>
            </div>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> LB SKUs, NAT vs LB rules,
              subnets, routes, NSGs, peering, hub-spoke.<br />
              <strong>Action:</strong> Use these flashcards and labs to
              reinforce networking concepts.
            </p>
            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Networking)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#net-flash-1" data-highlight-id="net-flash-1"
                      >LB SKU Differences</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#net-lab-1" data-highlight-id="net-lab-1"
                      >Lab: Configure VNet, Subnets, NSGs</a
                    >
                  </span>
                </div>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="net-flash-1-li">
                <input type="checkbox" id="net-flash-1" />
                <span class="item-text">LB SKU Differences</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-1">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-network-wired"></i>LB SKU Differences
                  </h4>
                  <ul>
                    <li>
                      <strong>Basic SKU:</strong> No zone redundancy, limited
                      features, public IP only, no diagnostics. Not recommended
                      for production.
                    </li>
                    <li>
                      <strong>Standard SKU:</strong> Zone redundant, supports
                      private IP, diagnostics, HA, secure by default. Required
                      for most production workloads.
                    </li>
                    <li>Standard is more flexible, secure, and scalable.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Basic = Bare,
                    Standard = Secure"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="net-flash-2-li">
                <input type="checkbox" id="net-flash-2" />
                <span class="item-text">NAT vs LB Rules</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-2">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-random"></i>NAT vs LB Rules</h4>
                  <ul>
                    <li>
                      <strong>LB Rule:</strong> Distributes incoming traffic to
                      all VMs in backend pool (many-to-many).
                    </li>
                    <li>
                      <strong>NAT Rule:</strong> Maps a specific external port
                      to a single VM (one-to-one), typically for management
                      (RDP/SSH).
                    </li>
                    <li>LB Rule = load balancing; NAT Rule = direct access.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "NAT = One-to-One,
                    LB = Many"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="net-flash-3-li">
                <input type="checkbox" id="net-flash-3" />
                <span class="item-text">3-Tier Subnet Design</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-3">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-layer-group"></i>3-Tier Subnet Design
                  </h4>
                  <ul>
                    <li>
                      Separate subnets for <strong>Web</strong>,
                      <strong>App</strong>, and <strong>DB</strong> layers.
                    </li>
                    <li>
                      Web subnet: public or DMZ, receives external traffic.
                    </li>
                    <li>
                      App subnet: private, only accessible from Web subnet or
                      internal.
                    </li>
                    <li>
                      DB subnet: most restricted, only accessible from App
                      subnet.
                    </li>
                    <li>
                      NSGs and route tables enforce isolation and security.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "W-A-D = Web App
                    Database"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="net-flash-4-li">
                <input type="checkbox" id="net-flash-4" />
                <span class="item-text">Route Tables & Forced Tunneling</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-4">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-route"></i>Route Tables & Forced Tunneling
                  </h4>
                  <ul>
                    <li>
                      <strong>User Defined Routes (UDRs)</strong> override
                      system routes for subnets.
                    </li>
                    <li>
                      <strong>Forced tunneling</strong>: Directs all outbound
                      internet traffic from a VNet to on-premises (via
                      VPN/ExpressRoute) by setting 0.0.0.0/0 next hop.
                    </li>
                    <li>
                      Default route (0.0.0.0/0) normally sends traffic to Azure
                      Internet; forced tunneling changes this to on-prem.
                    </li>
                    <li>
                      Used for compliance, monitoring, or security requirements.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Forced Tunnel =
                    Force All Traffic Home"
                  </div>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 5: Monitor and Maintain Azure Resources (Self-contained Focused Card) -->
        <!-- Domain 5: Monitor and Maintain Azure Resources -->
        <div class="card" id="monitoring-focused-card">
          <input type="checkbox" id="domain5-toggle" class="card-toggle" />
          <label for="domain5-toggle" class="card-header flashcard-header">
            <h2>
              <i class="fas fa-chart-line"></i>Domain 5: Monitor and Maintain
              Azure Resources
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Metrics & Alerts, Log
              Analytics queries, VM Insights, Dashboards, Workbooks, Recovery
              Vault backup and retention.<br />
              <span id="monitoring-quiz-stats" class="domain-quiz-stats"
                >(24/30 correct, 80%)</span
              >
            </div>

            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> Metrics, Workbooks, Log
              Analytics, Dashboards, Alerts.<br />
              <strong>Action:</strong> Review these flashcards and labs to
              strengthen monitoring skills.
            </p>

            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Monitoring)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#monitoring-flash-1"
                      data-highlight-id="monitoring-flash-1"
                      >Configuring Metrics & Alerts</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#monitoring-lab-1"
                      data-highlight-id="monitoring-lab-1"
                      >Lab: Create Dashboard & Alerts</a
                    >
                  </span>
                </div>
              </div>
            </div>

            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="monitoring-flash-1-li">
                <input type="checkbox" id="monitoring-flash-1" />
                <span class="item-text">Configuring Metrics & Alerts</span>
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-1"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-chart-bar"></i>Metrics & Alerts Overview
                  </h4>
                  <ul>
                    <li>
                      Configure metrics in Azure Monitor for VMs, Storage, App
                      Service, etc.
                    </li>
                    <li>
                      Create alert rules for thresholds like CPU %, disk IOPS.
                    </li>
                    <li>Alerts can trigger emails, webhooks, or Logic Apps.</li>
                    <li>
                      <strong>Sequence:</strong> Navigate to Azure Monitor â†’
                      Metrics â†’ Select resource â†’ Pick metric â†’ Add alert rule â†’
                      Define conditions â†’ Assign action group â†’ Review & create.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Metrics =
                    Measure, Alerts = Alarm"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-2-li">
                <input type="checkbox" id="monitoring-flash-2" />
                <span class="item-text">Log Analytics Query Basics</span>
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-2"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-terminal"></i>KQL Basics</h4>
                  <ul>
                    <li>Use Kusto Query Language (KQL) for querying logs.</li>
                    <li>
                      Example:
                      <code
                        >AzureActivity | summarize count() by
                        ActivityStatusValue</code
                      >
                    </li>
                    <li>Queries drive dashboards, alerts, and workbooks.</li>
                    <li>
                      <strong>Sequence:</strong> Navigate to Log Analytics â†’
                      Select workspace â†’ Open Logs â†’ Build query â†’ Run â†’ Pin to
                      dashboard / use in alert / integrate in workbook.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Logs = Stories,
                    KQL = Translator"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-3-li">
                <input type="checkbox" id="monitoring-flash-3" />
                <span class="item-text">VM Insights Layers</span>
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-3"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-server"></i>VM Insights</h4>
                  <ul>
                    <li>
                      Guest metrics: OS-level (CPU, memory, disk, network) via
                      agent.
                    </li>
                    <li>
                      Dependency map: Visualizes connections between VMs,
                      processes, and resources.
                    </li>
                    <li>Visualized in Azure Monitor/Insights.</li>
                    <li>
                      <strong>Sequence:</strong> Enable VM Insights â†’ Configure
                      agent â†’ Collect guest metrics â†’ Analyze dependencies â†’
                      View charts and maps in Azure Monitor.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Insights = Inside
                    VM"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-4-li">
                <input type="checkbox" id="monitoring-flash-4" />
                <span class="item-text"
                  >Log Analytics vs Metrics vs Workbooks</span
                >
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-4"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-book"></i>Logs, Metrics, Workbooks</h4>
                  <ul>
                    <li>
                      Metrics: numeric, time-series data, used in charts and
                      alerts.
                    </li>
                    <li>
                      Logs: structured/unstructured events, queried with KQL.
                    </li>
                    <li>
                      Workbooks: interactive dashboards combining metrics, logs,
                      and visuals.
                    </li>
                    <li>
                      <strong>Sequence:</strong> Metrics â†’ Monitor â†’ Alerts;
                      Logs â†’ Log Analytics â†’ KQL query â†’ Pin results; Workbooks
                      â†’ New workbook â†’ Add metrics/logs visuals â†’ Save & share.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Metrics =
                    Numbers, Logs = Stories, Workbooks = Reports"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-5-li">
                <input type="checkbox" id="monitoring-flash-5" />
                <span class="item-text"
                  >Recovery Vault: Backup & Retention</span
                >
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-5"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-lock"></i>Recovery Vault</h4>
                  <ul>
                    <li>
                      Recovery Services Vault stores backups for VMs, files,
                      SQL, etc.
                    </li>
                    <li>
                      Backup policies define schedule (daily, weekly) and
                      retention.
                    </li>
                    <li>Supports instant restore and long-term retention.</li>
                    <li>
                      <strong>Sequence:</strong> Create Recovery Vault â†’ Add
                      resource â†’ Configure backup policy â†’ Trigger backup â†’
                      Monitor jobs â†’ Restore if needed.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Vault = Safe for
                    Time Travel"
                  </div>
                </div>
              </li>
            </ul>

            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 6: Azure App Service & Containers -->
        <div class="card" id="app-service-containers-focused-card">
          <input type="checkbox" id="domain6-toggle" class="card-toggle" />
          <label for="domain6-toggle" class="card-header" style="background-color: #28a745;">
            <h2>
              <i class="fas fa-cube"></i>Domain 6: Azure App Service & Containers
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #fff3e0;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 2px solid #ff9800;
              "
            >
              <strong>ðŸš¨ Critical Weak Spot:</strong> Container security scanning, deployment slots with auto-swap, VNet integration with SQL Database, Traffic Manager scaling for ACI.<br />
              <span id="app-service-containers-quiz-stats" class="domain-quiz-stats" style="color: #d32f2f; font-weight: bold;">
                (1/5 correct, 20% - IMMEDIATE PRIORITY)
              </span>
            </div>

            <h3><i class="fas fa-exclamation-triangle" style="color: #ff9800;"></i>Priority Study Areas</h3>
            <ul class="review-item-list">
              
              <li class="flashcard-item" id="app-service-flash-1-li">
                <input type="checkbox" id="app-service-flash-1" />
                <span class="item-text">Container Security: Defender + ACR Tasks + Azure Policy</span>
                <span class="item-tag" style="background: #ff9800; color: white;">Critical</span>
                <select class="confidence-select" data-item-id="app-service-flash-1">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-shield-alt"></i>Container Image Security Pipeline</h4>
                  <ul>
                    <li><strong>Microsoft Defender for Containers:</strong> Native Azure vulnerability scanning for ACR images with detailed reports</li>
                    <li><strong>ACR Tasks:</strong> Automate image scanning during CI/CD build process (shift-left security)</li>
                    <li><strong>Azure Policy:</strong> Governance tool to deny deployment of unscanned or vulnerable images</li>
                    <li><strong>Integration Pattern:</strong> Enable Defender â†’ Configure ACR Tasks in build â†’ Set Policy enforcement â†’ Only approved images reach production</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "DAP = Defender + ACR + Policy = Secure Container Pipeline"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="app-service-flash-2-li">
                <input type="checkbox" id="app-service-flash-2" />
                <span class="item-text">App Service: Zero-Downtime Deployment Slots</span>
                <span class="item-tag" style="background: #ff9800; color: white;">Critical</span>
                <select class="confidence-select" data-item-id="app-service-flash-2">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-exchange-alt"></i>Deployment Slots Configuration</h4>
                  <ul>
                    <li><strong>Auto-Swap:</strong> Automatically swaps staging to production after deployment completion and warm-up</li>
                    <li><strong>Slot Settings:</strong> Environment-specific settings (connection strings, app settings) that maintain isolation</li>
                    <li><strong>Swap Operation:</strong> Transactional process that can revert automatically on failure</li>
                    <li><strong>Required Steps:</strong> Enable auto-swap â†’ Configure slot settings â†’ Deploy to staging â†’ Automatic production swap</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "ASS = Auto-Swap + Slot Settings = Safe deployments"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="app-service-flash-3-li">
                <input type="checkbox" id="app-service-flash-3" />
                <span class="item-text">VNet Integration + SQL Database Security</span>
                <span class="item-tag" style="background: #ff9800; color: white;">Critical</span>
                <select class="confidence-select" data-item-id="app-service-flash-3">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-network-wired"></i>Secure App Service to SQL Database</h4>
                  <ul>
                    <li><strong>Step 1:</strong> VNet Integration - Connect App Service to VNet subnet</li>
                    <li><strong>Step 2:</strong> Service Endpoint - Enable on subnet for SQL Database access</li>
                    <li><strong>Step 3:</strong> Firewall Rules - Update SQL Database to allow subnet traffic</li>
                    <li><strong>Step 4:</strong> Disable Public Access - Remove internet access to SQL Database</li>
                    <li><strong>Step 5:</strong> Test Connectivity - Verify end-to-end secure connection</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "VSFDT = VNet + Service endpoint + Firewall + Disable public + Test"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="app-service-flash-4-li">
                <input type="checkbox" id="app-service-flash-4" />
                <span class="item-text">ACI Scaling: Traffic Manager vs Load Balancer</span>
                <span class="item-tag" style="background: #ff9800; color: white;">Critical</span>
                <select class="confidence-select" data-item-id="app-service-flash-4">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-globe"></i>ACI High Traffic Scaling</h4>
                  <ul>
                    <li><strong>âœ… Traffic Manager:</strong> DNS-based routing to multiple ACI deployments across regions - CORRECT for ACI scaling</li>
                    <li><strong>âŒ Azure Load Balancer:</strong> Not compatible with basic ACI (works within VNet only, ACI is outside VNet)</li>
                    <li><strong>âŒ Manual scaling:</strong> Not responsive for traffic surges like flash sales</li>
                    <li><strong>âŒ AKS migration:</strong> Requires architecture redesign (violates requirement)</li>
                    <li><strong>Key Point:</strong> Traffic Manager enables fault tolerance and global distribution without app changes</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "ACI + Traffic Manager = Global scaling without redesign"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="app-service-flash-5-li">
                <input type="checkbox" id="app-service-flash-5" />
                <span class="item-text">Wildcard SSL Certificates for Subdomains</span>
                <span class="item-tag" style="background: #28a745; color: white;">Correct</span>
                <select class="confidence-select" data-item-id="app-service-flash-5">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-certificate"></i>Wildcard SSL Certificate Management</h4>
                  <ul>
                    <li><strong>Wildcard Pattern:</strong> *.example.com covers app.example.com, blog.example.com, etc.</li>
                    <li><strong>App Service Support:</strong> Native binding support for wildcard certificates</li>
                    <li><strong>Management Benefit:</strong> Single certificate for all first-level subdomains</li>
                    <li><strong>Limitation:</strong> Does NOT cover nested subdomains (e.g., sub.blog.example.com)</li>
                    <li><strong>Security:</strong> Enables HTTPS/TLS for end-to-end encryption</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Wildcard = One cert for many subdomains (but not nested)"
                  </div>
                </div>
              </li>

            </ul>

            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Container security lab: Set up Defender + ACR Tasks + Policy enforcement</strong></span></li>
              <li class="lab-item"><span class="item-text"><strong>Deployment slots lab: Configure auto-swap with slot-specific settings</strong></span></li>
              <li class="lab-item"><span class="item-text"><strong>VNet integration lab: Secure App Service to SQL Database connection</strong></span></li>
              <li class="lab-item"><span class="item-text"><strong>ACI scaling lab: Deploy Traffic Manager with multi-region ACI instances</strong></span></li>
            </ul>
          </div>
        </div>

  <!-- End Flashcards/Labs Section -->

  <!-- Flashcard expand/collapse handled by consolidated script -->
      </div>
    </div>
  <!-- Duplicate embedded JSON/scripts removed and consolidated earlier in file -->
    </script>
    <!-- Enhancement styles (modular, additive) -->
    <style>
      details.cli-ref-block, details.scenario-block, details.related-links-block, details.concept-interlinks-block {margin:12px 0;padding:10px 14px;border:1px solid #d9e2f3;border-radius:8px;background:#f9fbfd}
      details.cli-ref-block > summary, details.scenario-block > summary, details.related-links-block > summary, details.concept-interlinks-block > summary {cursor:pointer;font-weight:600;color:#005a9e;display:flex;align-items:center;gap:6px}
  /* Highlight for related flashcard jump */
  .related-flashcard-highlight {outline:2px solid #ffb800;background:#fff8dc !important;transition:outline 0.3s ease}
  /* Concept interlink badge */
  .concept-dot {display:inline-block;width:8px;height:8px;border-radius:50%;background:#8e44ad;margin-right:6px;vertical-align:middle}
  .concept-tag {background:#f3e9fb;color:#5b2c83;border:1px solid #e3d3f5;border-radius:10px;padding:2px 6px;margin-left:8px;font-size:12px}
      details.cli-ref-block pre {background:#0f172a;color:#e2e8f0;padding:10px 12px;border-radius:6px;overflow-x:auto;font-size:0.85em;line-height:1.35;position:relative}
      .cli-copy-btn {position:absolute;top:8px;right:8px;background:#27ae60;color:#fff;border:0;padding:4px 8px;border-radius:4px;font-size:0.7em;cursor:pointer;opacity:0.9;transition:0.2s}
      .cli-copy-btn:hover {opacity:1;background:#229954}
      .cli-copy-btn.copied {background:#3498db}
      .scenario-entry {margin:8px 0;padding:8px 10px;border-left:4px solid #ff9800;background:#fff;border-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,0.06)}
      .scenario-entry h5 {margin:0 0 6px;font-size:0.95em;color:#c0392b}
      .scenario-steps {margin:0;padding-left:18px;font-size:0.85em}
      .related-links-list {list-style:none;margin:6px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:8px}
      .related-links-list a {background:#e6f2ff;border:1px solid #c5ddf5;padding:4px 8px;border-radius:4px;font-size:0.75em;text-decoration:none;color:#005a9e;transition:.18s}
      .related-links-list a:hover {background:#005a9e;color:#fff}
    </style>

    <!-- Reinforcement feature injection script -->
    <script>
      (function(){
        const cliReferences = {
          'idgov-flash-1': { cli: 'az role assignment list --assignee <user@domain.com>\naz role assignment create --assignee <user@domain.com> --role "Storage File Data SMB Share Contributor" --scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>', ps: 'Get-AzRoleAssignment -SignInName user@domain.com\nNew-AzRoleAssignment -SignInName user@domain.com -RoleDefinitionName "Storage File Data SMB Share Contributor" -Scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>' },
          'idgov-flash-2': { cli: 'az role assignment create --assignee <principalId> --role Reader --scope /subscriptions/<subId>', ps: 'New-AzRoleAssignment -ObjectId <principalId> -RoleDefinitionName Reader -Scope /subscriptions/<subId>' },
          'idgov-flash-4': { cli: 'az ad user list --filter "accountEnabled eq true"\n# Microsoft Graph example via REST:\nGET https://graph.microsoft.com/v1.0/users', ps: 'Get-MgUser -Filter "accountEnabled eq true"' },
          'idgov-flash-6': { cli: 'az storage share-rbac-assignment create --account-name <storageAcct> --share-name <fileshare> --group-id <AADGroupObjectId> --role "Storage File Data SMB Share Contributor"', ps: '# Azure Files Kerberos setup typically via portal + AD DS; sample PowerShell RBAC assignment:\nNew-AzRoleAssignment -ObjectId <AADGroupObjectId> -RoleDefinitionName "Storage File Data SMB Share Contributor" -Scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>' },
          'storage-flash-1': { cli: 'az storage account create -n <acct> -g <rg> --sku Standard_LRS --kind StorageV2\naz role assignment create --assignee <user@domain.com> --role "Storage File Data SMB Share Contributor" --scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>', ps: 'New-AzStorageAccount -Name <acct> -ResourceGroupName <rg> -SkuName Standard_LRS -Kind StorageV2\nNew-AzRoleAssignment -ObjectId <userObjectId> -RoleDefinitionName "Storage File Data SMB Share Contributor" -Scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>' },
          'storage-flash-2': { cli: 'az storage account blob-service-properties update --account-name <acct> --enable-delete-retention true --delete-retention-days 30', ps: 'Set-AzStorageBlobServiceProperty -StorageAccountName <acct> -EnableDeleteRetention $true -DeleteRetentionDays 30' },
          'storage-flash-3': { cli: 'az storage account create -n <acct> -g <rg> --sku Standard_ZRS\n# Change replication (preview scenarios vary)', ps: '# Replication tier chosen at creation; cannot switch all tiers freely.' },
          'storage-flash-4': { cli: '# Port 445 testing (mac/Linux):\nnc -vz <storageAcct>.file.core.windows.net 445', ps: 'Test-NetConnection -ComputerName <storageAcct>.file.core.windows.net -Port 445' },
          'storage-flash-6': { cli: 'az storage container immutability-policy create --account-name <acct> -n <container> --period 30', ps: 'Set-AzStorageBlobImmutabilityPolicy -StorageAccountName <acct> -ContainerName <container> -ImmutabilityPeriod 30' },
          'compute-flash-1': { cli: 'az vm create -n <vmName> -g <rg> --image UbuntuLTS --size Standard_B2ms --admin-username azureuser --generate-ssh-keys', ps: 'New-AzVM -Name <vmName> -ResourceGroupName <rg> -Image UbuntuLTS -Size Standard_B2ms -Credential (Get-Credential)' },
          'compute-flash-4': { cli: 'az container create -n quickapp -g <rg> --image mcr.microsoft.com/azuredocs/aci-helloworld --cpu 2 --memory 4', ps: '# ACI PowerShell example:\nNew-AzContainerGroup -ResourceGroupName <rg> -Name quickapp -Image mcr.microsoft.com/azuredocs/aci-helloworld -OsType Linux -Cpu 2 -MemoryInGb 4' },
          'net-flash-1': { cli: 'az network lb create -g <rg> -n myStandardLb --sku Standard --public-ip-address myPublicIp', ps: 'New-AzLoadBalancer -ResourceGroupName <rg> -Name myStandardLb -Sku Standard -FrontendIpConfiguration @(...)' },
          'net-flash-2': { cli: 'az network lb inbound-nat-rule create -g <rg> --lb-name myStandardLb -n sshRule --protocol Tcp --frontend-port 22 --backend-port 22 --frontend-ip-name LoadBalancerFrontEnd --backend-pool-name MyPool', ps: 'Add-AzLoadBalancerInboundNatRuleConfig -Name sshRule -FrontendPort 22 -BackendPort 22 ...' },
          'net-flash-4': { cli: 'az network route-table route add --address-prefix 0.0.0.0/0 --next-hop-type VirtualAppliance --route-table-name forceAll --name forceTunnel --next-hop-ip-address <onPremFirewallIP>', ps: 'Add-AzRouteConfig -Name forceTunnel -AddressPrefix 0.0.0.0/0 -NextHopType VirtualAppliance -NextHopIpAddress <onPremFirewallIP> -RouteTable forceAll' },
          'monitoring-flash-1': { cli: 'az monitor metrics list --resource <resId> --metric "Percentage CPU"\naz monitor alert create -n cpuAlert -g <rg> --scopes <resId> --condition "avg Percentage CPU > 80" --action-group <agId>', ps: 'Get-AzMetric -ResourceId <resId> -MetricName "Percentage CPU"\nNew-AzScheduledQueryRule ...' },
          'monitoring-flash-2': { cli: 'az monitor log-analytics query -w <workspaceId> --analytics-query "AzureActivity | summarize count() by ActivityStatusValue"', ps: 'Invoke-AzOperationalInsightsQuery -WorkspaceId <workspaceId> -Query "AzureActivity | summarize count() by ActivityStatusValue"' },
          'monitoring-flash-5': { cli: 'az backup protection enable-for-vm -g <rg> -v <vmName> -rsv <vaultName> --policy-name DailyPolicy', ps: 'Enable-AzRecoveryServicesBackupProtection -ResourceGroupName <rg> -VaultId <vaultId> -Policy $policy -Name <vmName>' },
          'app-service-flash-1': { cli: 'az security assessment list --assessed-resource-id /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.ContainerRegistry/registries/<acrName>\naz acr task create -r <acrName> -n scanTask --image <imageName> --file Dockerfile --context . --assign-identity', ps: 'Get-AzSecurityAssessment -AssessedResourceId /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.ContainerRegistry/registries/<acrName>' },
          'app-service-flash-2': { cli: 'az webapp deployment slot create -g <rg> -n <appName> -s staging\naz webapp deployment slot auto-swap -g <rg> -n <appName> -s staging --enable-auto-swap', ps: 'New-AzWebAppSlot -ResourceGroupName <rg> -Name <appName> -Slot staging\nSet-AzWebAppSlot -ResourceGroupName <rg> -Name <appName> -Slot staging -AutoSwapSlotName production' },
          'app-service-flash-3': { cli: 'az webapp vnet-integration add -g <rg> -n <appName> --vnet <vnetName> --subnet <subnetName>\naz network vnet subnet update -n <subnetName> --vnet-name <vnetName> -g <rg> --service-endpoints Microsoft.Sql', ps: 'Set-AzWebApp -ResourceGroupName <rg> -Name <appName> -VnetName <vnetName> -SubnetName <subnetName>\nSet-AzVirtualNetworkSubnetConfig -Name <subnetName> -VirtualNetwork <vnet> -ServiceEndpoint Microsoft.Sql' },
          'app-service-flash-4': { cli: 'az network traffic-manager profile create -n <tmProfile> -g <rg> --routing-method Performance\naz container create -n aci-west -g <rg> --image <imageUrl> --location westus', ps: 'New-AzTrafficManagerProfile -Name <tmProfile> -ResourceGroupName <rg> -TrafficRoutingMethod Performance\nNew-AzContainerGroup -ResourceGroupName <rg> -Name aci-west -Image <imageUrl> -Location "West US"' },
          'app-service-flash-5': { cli: 'az webapp config ssl upload -g <rg> -n <appName> --certificate-file wildcard.pfx\naz webapp config ssl bind -g <rg> -n <appName> --certificate-thumbprint <thumbprint> --ssl-type SNI', ps: 'New-AzWebAppSSLBinding -ResourceGroupName <rg> -WebAppName <appName> -CertificateFilePath wildcard.pfx -Name "*.example.com"' }
        };

        const domainMap = {
          'identities-focused-card': {
            name: 'Identities', related: ['storage-flash-1','storage-flash-2','net-flash-2','compute-flash-1']
          },
          'storage-focused-card': {
            name: 'Storage', related: ['idgov-flash-6','net-flash-1','monitoring-flash-1']
          },
            'compute-focused-card': {
            name: 'Compute', related: ['net-flash-1','monitoring-flash-1','storage-flash-3']
          },
          'networking-focused-card': {
            name: 'Networking', related: ['storage-flash-5','compute-flash-4','monitoring-flash-2']
          },
          'monitoring-focused-card': {
            name: 'Monitoring', related: ['net-flash-4','compute-flash-3','storage-flash-2']
          },
          'app-service-containers-focused-card': {
            name: 'App Service & Containers', related: ['compute-flash-2','storage-flash-4','monitoring-flash-3']
          }
        };

        const scenarioData = {
          global: [
            { title: 'Incident: Unauthorized Storage Access Spike', steps: [
              'Azure Monitor alert fires: anomalous reads on a storage account.',
              'Check recent RBAC changes (Identities domain).',
              'Validate firewall + private endpoint configuration (Networking + Storage).',
              'Run CLI to list active role assignments and narrow suspect principals.',
              'Apply mitigation: remove excess role assignment, tighten NTFS + RBAC alignment.'
            ] },
            { title: 'Scenario: VM Migration Performance Lag', steps: [
              'During VM migration, performance degraded.',
              'Review Disk snapshot + encryption sequence (Compute).',
              'Check network forced tunneling route impact (Networking).',
              'Monitor CPU/memory metrics & set temporary alert (Monitoring).'
            ] }
          ],
          'identities-focused-card': [
            { title: 'Guest User Conversion Flow', steps: [ 'External guest requires elevated file share access.', 'Review RBAC vs Entra DS permission layering.', 'Convert guest to member, assign storage role, test SMB access using Kerberos.' ] }
          ],
          'storage-focused-card': [
            { title: 'Recover Deleted File Share', steps: [ 'Soft delete retention still active.', 'List deleted shares via CLI.', 'Restore; verify NTFS & RBAC alignment.', 'Set snapshot before critical bulk permission change.' ] }
          ],
          'compute-focused-card': [
            { title: 'Redeploy ACI Under Load', steps: [ 'Traffic spike requires scaling.', 'ACI no in-place scale â†’ plan redeploy bigger group.', 'Evaluate switch to AKS for orchestrated scaling.', 'Document decision in workbook (Monitoring).' ] }
          ],
          'networking-focused-card': [
            { title: 'Forced Tunneling Misconfiguration', steps: [ 'Users report outbound slowness.', 'Inspect UDR default route 0.0.0.0/0.', 'Validate next hop firewall availability.', 'Adjust route or add exception for Azure services.' ] }
          ],
          'monitoring-focused-card': [
            { title: 'Alert Noise Reduction', steps: [ 'Too many CPU alerts across VM fleet.', 'Aggregate via metrics chart.', 'Adjust threshold & evaluation period.', 'Add workbook combining CPU + Disk IO trends.' ] }
          ],
          'app-service-containers-focused-card': [
            { title: 'Security Scan Failure Blocks Deployment', steps: [ 'ACR image deployment blocked by policy.', 'Review Defender for Containers scan results.', 'Fix critical vulnerabilities in base image.', 'Re-trigger ACR task build.', 'Verify policy allows compliant image through.' ] },
            { title: 'Deployment Slot Swap Rollback', steps: [ 'Auto-swap triggered, but staging has bugs.', 'Transactional swap detects failure.', 'Automatic rollback to previous production.', 'Fix staging issues, test slot-specific settings.', 'Re-enable auto-swap for next deployment.' ] },
            { title: 'VNet Integration Connectivity Loss', steps: [ 'App Service loses SQL Database connection.', 'Verify VNet integration subnet status.', 'Check service endpoint configuration.', 'Validate SQL Database firewall rules.', 'Test connectivity, update monitoring alerts.' ] }
          ]
        };

        function injectCliRefs(){
          document.querySelectorAll('.flashcard-item').forEach(item => {
            const id = item.querySelector('input[type=checkbox]')?.id;
            if(!id || !cliReferences[id]) return;
            const area = item.querySelector('.flashcard-content-area');
            if(!area) return;
            // prevent duplicate injection
            if(area.querySelector('details.cli-ref-block')) return;
            const details = document.createElement('details');
            details.className = 'cli-ref-block';
            const summary = document.createElement('summary');
            summary.textContent = 'ðŸ’» CLI / PowerShell Reference';
            const pre = document.createElement('pre');
            pre.textContent = 'CLI:\n' + cliReferences[id].cli + '\n\nPowerShell:\n' + cliReferences[id].ps;
            // Add copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'cli-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = function(e){
              e.preventDefault();
              e.stopPropagation();
              try {
                navigator.clipboard.writeText(pre.textContent).then(() => {
                  copyBtn.textContent = 'Copied!';
                  copyBtn.classList.add('copied');
                  setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                    copyBtn.classList.remove('copied');
                  }, 2000);
                }).catch(() => {
                  copyBtn.textContent = 'Failed';
                  setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                });
              } catch(err) {
                copyBtn.textContent = 'Not supported';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
              }
            };
            pre.appendChild(copyBtn);
            details.appendChild(summary); details.appendChild(pre);
            area.appendChild(details);
          });
        }

        function buildRelatedLinks(){
          Object.entries(domainMap).forEach(([cardId, meta]) => {
            const card = document.getElementById(cardId);
            if(!card) return;
            const flashList = card.querySelector('ul.review-item-list');
            if(!flashList) return;
            // Insert before the Lab Tracker header (find the first h3 following flashcards list that contains 'Lab Tracker')
            const labHeader = Array.from(card.querySelectorAll('h3')).find(h => /Lab Tracker/i.test(h.textContent));
            if(!labHeader || labHeader.previousElementSibling?.classList.contains('related-links-block')) return;
            const wrapper = document.createElement('details');
            wrapper.className = 'related-links-block';
            const summary = document.createElement('summary');
            summary.textContent = 'ðŸ§© Related Flashcards (' + meta.name + ')';
            const ul = document.createElement('ul'); ul.className='related-links-list';
            meta.related.forEach(refId => {
              const li = document.createElement('li');
              const a = document.createElement('a');
              // Anchor to the actual list item element (e.g., #compute-flash-1-li) so the whole card row is visible
              a.href = '#' + refId + '-li';
              // Resolve actual flashcard title from the referenced item's .item-text
              const refItem = document.querySelector('#' + refId + '-li .item-text');
              a.textContent = refItem ? refItem.textContent.trim() : refId.replace(/-.+?-flash-?/,'').replace(/-/g,' ').trim();
              // Add a click enhancer: briefly highlight the destination list item
              a.addEventListener('click', (e) => {
                const targetId = refId + '-li';
                // Delay to allow default hash navigation to complete
                setTimeout(() => {
                  const dest = document.getElementById(targetId);
                  if(dest){
                    dest.classList.add('related-flashcard-highlight');
                    dest.scrollIntoView({behavior:'smooth', block:'center'});
                    setTimeout(()=>dest.classList.remove('related-flashcard-highlight'), 1600);
                  }
                }, 50);
              });
              li.appendChild(a); ul.appendChild(li);
            });
            wrapper.appendChild(summary); wrapper.appendChild(ul);
            labHeader.parentNode.insertBefore(wrapper, labHeader);
          });
        }

        function injectScenarios(){
          // Global block after snapshot card (insert at top of card-container after first card)
          const container = document.querySelector('.card-container');
            const firstCard = container?.querySelector('.card');
          if(container && firstCard && !document.getElementById('global-scenarios-block')){
            const globalCard = document.createElement('details');
            globalCard.className='scenario-block';
            globalCard.id='global-scenarios-block';
            const summary=document.createElement('summary'); summary.textContent='ðŸ§ª Scenario Drill Mode (Global)';
            globalCard.appendChild(summary);
            scenarioData.global.forEach(sc => {
              const div=document.createElement('div'); div.className='scenario-entry';
              const h5=document.createElement('h5'); h5.textContent=sc.title; div.appendChild(h5);
              const ol=document.createElement('ol'); ol.className='scenario-steps';
              sc.steps.forEach(s => { const li=document.createElement('li'); li.textContent=s; ol.appendChild(li); });
              div.appendChild(ol); globalCard.appendChild(div);
            });
            // Make the global scenarios block open by default so changes are visible immediately
            try { globalCard.open = true; } catch(e) {}
            container.insertBefore(globalCard, firstCard.nextSibling);
          }
          // Per-domain blocks
          Object.keys(domainMap).forEach(cardId => {
            const card = document.getElementById(cardId);
            if(!card) return;
            if(card.querySelector('details.scenario-block')) return;
            const tracker = card.querySelector('.next-steps-tracker');
            const scenarios = scenarioData[cardId];
            if(!tracker || !scenarios) return;
            const details=document.createElement('details'); details.className='scenario-block';
            const summary=document.createElement('summary'); summary.textContent='ðŸ§ª Scenario Drill Mode (' + domainMap[cardId].name + ')';
            details.appendChild(summary);
            scenarios.forEach(sc => {
              const div=document.createElement('div'); div.className='scenario-entry';
              const h5=document.createElement('h5'); h5.textContent=sc.title; div.appendChild(h5);
              const ol=document.createElement('ol'); ol.className='scenario-steps';
              sc.steps.forEach(s => { const li=document.createElement('li'); li.textContent=s; ol.appendChild(li); });
              div.appendChild(ol); details.appendChild(div);
            });
            tracker.insertAdjacentElement('afterend', details);
          });
        }

        function buildConceptInterlinks(){
          // Map concept slugs to flashcard checkbox IDs (without -li suffix)
          const conceptMap = {
            'rbac-vs-entra-ds': ['idgov-flash-1','idgov-flash-3','storage-flash-1','storage-flash-5'],
            'rbac-vs-ntfs': ['storage-flash-1','storage-flash-5','idgov-flash-1'],
            'load-balancer-skus': ['net-flash-1','net-flash-3','compute-flash-4'],
            'app-service-scaling': ['compute-flash-4','compute-flash-2','monitoring-flash-1'],
            'private-vs-service-endpoints': ['storage-flash-5','net-flash-2','storage-flash-2']
          };
          // Human-readable titles for concept headings
          const conceptTitles = {
            'rbac-vs-entra-ds': 'RBAC vs Entra DS / Directory Permissions',
            'rbac-vs-ntfs': 'RBAC vs NTFS Alignment (Azure Files)',
            'load-balancer-skus': 'Load Balancer SKU Differences',
            'app-service-scaling': 'App Service Scaling & Runtime Patterns',
            'private-vs-service-endpoints': 'Private Endpoints vs Service Endpoints'
          };
          // Reverse index: which concepts each flashcard participates in
          const reverseIndex = {};
          Object.entries(conceptMap).forEach(([slug, ids]) => {
            ids.forEach(id => {
              reverseIndex[id] = reverseIndex[id] || [];
              reverseIndex[id].push(slug);
            });
          });
          // Tag flashcards with concept slugs (data attributes, plus a small badge)
          Object.entries(reverseIndex).forEach(([flashId, slugs]) => {
            const li = document.getElementById(flashId + '-li');
            if(!li) return;
            li.dataset.concepts = slugs.join(',');
            // Append inline concept tags inside content area header if available
            const contentArea = li.querySelector('.flashcard-content-area h4');
            if(contentArea){
              slugs.forEach((slug, idx) => {
                const span = document.createElement('span');
                span.className='concept-tag';
                span.textContent = conceptTitles[slug] ? conceptTitles[slug].split(/\s+/).slice(0,3).join(' ') + (conceptTitles[slug].length>25?'â€¦':'') : slug;
                span.title = conceptTitles[slug] || slug;
                contentArea.appendChild(span);
              });
            }
          });
          // Inject a Concept Interlinks block into each domain card before Lab Tracker header
          Object.keys(domainMap).forEach(cardId => {
            const card = document.getElementById(cardId);
            if(!card) return;
            if(card.querySelector('details.concept-interlinks-block')) return;
            const labHeader = Array.from(card.querySelectorAll('h3')).find(h => /Lab Tracker/i.test(h.textContent));
            if(!labHeader) return;
            // Collect all flashcards in this card and aggregate their concept slugs
            const flashItems = Array.from(card.querySelectorAll('li.flashcard-item'));
            const conceptUsage = {};
            flashItems.forEach(li => {
              const c = li.dataset.concepts?.split(',').filter(Boolean) || [];
              c.forEach(slug => { conceptUsage[slug] = conceptUsage[slug] || new Set(); conceptUsage[slug].add(li.id.replace(/-li$/,'')); });
            });
            if(Object.keys(conceptUsage).length === 0) return; // nothing relevant
            const details = document.createElement('details'); details.className='concept-interlinks-block';
            const summary = document.createElement('summary'); summary.textContent='ðŸ”— Concept Interlinks (' + domainMap[cardId].name + ')';
            details.appendChild(summary);
            const list = document.createElement('ul'); list.style.listStyle='none'; list.style.margin='6px 0 0'; list.style.padding='0';
            Object.entries(conceptUsage).forEach(([slug, idSet]) => {
              const li = document.createElement('li'); li.style.margin='4px 0';
              const dot = document.createElement('span'); dot.className='concept-dot'; li.appendChild(dot);
              const title = document.createElement('strong'); title.textContent = conceptTitles[slug] || slug; li.appendChild(title);
              // Links row
              const linksSpan = document.createElement('span'); linksSpan.style.marginLeft='8px';
              Array.from(idSet).forEach(fid => {
                const a = document.createElement('a');
                a.href = '#' + fid + '-li';
                a.style.marginRight='6px'; a.style.fontSize='0.75em';
                const refItem = document.querySelector('#' + fid + '-li .item-text');
                a.textContent = refItem ? refItem.textContent.trim() : fid;
                a.addEventListener('click', (e) => {
                  setTimeout(()=>{
                    const dest = document.getElementById(fid + '-li');
                    if(dest){
                      dest.classList.add('related-flashcard-highlight');
                      dest.scrollIntoView({behavior:'smooth', block:'center'});
                      setTimeout(()=>dest.classList.remove('related-flashcard-highlight'),1600);
                    }
                  },50);
                });
                linksSpan.appendChild(a);
              });
              li.appendChild(linksSpan); list.appendChild(li);
            });
            details.appendChild(list);
            labHeader.parentNode.insertBefore(details, labHeader);
          });
        }

        function initReinforcement(){
          try{ injectCliRefs(); }catch(e){}
          try{ buildRelatedLinks(); }catch(e){}
          try{ injectScenarios(); }catch(e){}
          try{ buildConceptInterlinks(); }catch(e){}
        }

        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', initReinforcement);
        } else { initReinforcement(); }
      })();
    </script>

    <!-- Theme Toggle Script -->
    <script>
      (function() {
        const THEME_KEY = 'prg-theme';

        function initTheme() {
          const saved = localStorage.getItem(THEME_KEY);
          if (saved === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            updateToggleButton(true);
          }
        }

        function toggleTheme() {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          if (isDark) {
            document.documentElement.removeAttribute('data-theme');
            localStorage.setItem(THEME_KEY, 'light');
            updateToggleButton(false);
          } else {
            document.documentElement.setAttribute('data-theme', 'dark');
            localStorage.setItem(THEME_KEY, 'dark');
            updateToggleButton(true);
          }
        }

        function updateToggleButton(isDark) {
          const btn = document.getElementById('theme-toggle');
          if (!btn) return;
          const icon = btn.querySelector('i');
          const text = btn.querySelector('span');
          if (isDark) {
            if (icon) { icon.className = 'fas fa-sun'; }
            if (text) { text.textContent = 'Light'; }
          } else {
            if (icon) { icon.className = 'fas fa-moon'; }
            if (text) { text.textContent = 'Dark'; }
          }
        }

        initTheme();
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      })();
    </script>
  </body>
</html>
