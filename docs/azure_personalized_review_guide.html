<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Personalized Review: Weak Spot Focus (AZ-104)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --azure-blue: #0078d4;
        --azure-blue-dark: #005a9e;
        --azure-bg-light: #f0f4f8;
        --text-dark: #323130;
        --text-light: #ffffff;
        --border-color: #d1d1d1;
        --card-bg: #ffffff;
        --diagram-bg: #f8f9fa;
        --success-color: #107c10;
        --warning-color: #d83b01;
        --info-color: #005a9e;
        --shadow-color: rgba(0, 0, 0, 0.1);
        /* Personalized Review specific colors */
        --review-main-color: #d83b01; /* Orange for main review section */
        --snapshot-card-color: #ff9800; /* Lighter orange for snapshot */
        --flashcard-card-color: #0078d4; /* Azure blue for flashcards */
        --lab-card-color: #4caf50; /* Green for labs */
        --az104-tip-color: #ffc107; /* Gold for exam tips */
        --flashcard-reveal-bg: #e6f2ff; /* Light blue for revealed content */
        --flashcard-reveal-border: #0078d4; /* Azure blue for revealed border */

        /* Confidence Colors */
        --confidence-weak: #e74c3c; /* Red */
        --confidence-medium: #f1c40f; /* Yellow */
        --confidence-strong: #2ecc71; /* Green */

        /* Next Steps Section Colors */
        --next-step-bg: #fdfaf5;
        --next-step-border: #ffcc80;
        --next-step-title-color: #d83b01;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--text-dark);
        line-height: 1.6;
        background-color: var(--azure-bg-light);
      }
      .main-container {
        max-width: 900px;
        width: 100%;
      }

      h1 {
        color: var(--review-main-color);
        text-align: center;
        border-bottom: 2px solid var(--snapshot-card-color);
        padding-bottom: 15px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      h1 i {
        margin-right: 10px;
        color: var(--snapshot-card-color);
      }

      .back-to-hub-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto 20px auto;
        padding: 0 20px;
        box-sizing: border-box;
      }
      .back-to-hub {
        padding: 10px;
        background-color: #ffe0b2;
        border-radius: 5px;
        text-align: left;
        border: 1px solid var(--snapshot-card-color);
      }
      .back-to-hub a {
        text-decoration: none;
        color: var(--review-main-color);
        font-weight: bold;
        font-size: 1.1em;
      }
      .back-to-hub a i {
        margin-right: 8px;
      }

      .card-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        width: 100%;
      }
      @media (min-width: 768px) {
        .card-container {
          grid-template-columns: repeat(1, 1fr);
        } /* Single column for readability */
      }

      .card {
        background-color: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 10px var(--shadow-color);
        overflow: hidden;
        border: 1px solid var(--border-color);
        transition: box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
      }
      .card:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }
      .card-toggle {
        display: none;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        color: var(--text-light);
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid;
      }
      .card-header.snapshot-header {
        background-color: var(--snapshot-card-color);
        border-bottom-color: #e08e00;
      }
      .card-header.snapshot-header:hover {
        background-color: #e08e00;
      }
      .card-header.flashcard-header {
        background-color: var(--flashcard-card-color);
        border-bottom-color: #005fbb;
      }
      .card-header.flashcard-header:hover {
        background-color: #005fbb;
      }
      .card-header.lab-header {
        background-color: var(--lab-card-color);
        border-bottom-color: #388e3c;
      }
      .card-header.lab-header:hover {
        background-color: #388e3c;
      }

      .card-header h2 {
        margin: 0;
        font-size: 1.3em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .card-header h2 i {
        font-size: 1.1em;
        opacity: 0.9;
      }
      .card-header .toggle-icon {
        font-size: 1.2em;
        transition: transform 0.3s ease;
      }

      .card-content {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        padding: 0 20px;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-in,
          padding 0.4s ease-out, border-top 0.4s ease-out;
        background-color: var(--card-bg);
        border-top: 0px solid var(--border-color);
        flex-grow: 1;
      }
      .card-toggle:checked + .card-header {
        border-bottom-color: transparent;
      }
      .card-toggle:checked + .card-header .toggle-icon {
        transform: rotate(180deg);
      }
      .card-toggle:checked ~ .card-content {
        max-height: 2500px;
        opacity: 1;
        padding: 20px;
        border-top: 1px solid var(--border-color);
        overflow-y: auto;
      }

      .card-content h3 {
        color: var(--azure-blue-dark);
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.2em;
        font-weight: 600;
        border-bottom: 1px dashed #eee;
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card-content h3 i {
        font-size: 1em;
        color: var(--azure-blue-dark);
      }
      .card-content p {
        font-size: 0.95em;
        margin-bottom: 12px;
      }
      .card-content ul {
        font-size: 0.95em;
        padding-left: 0;
        margin-top: 5px;
        margin-bottom: 15px;
        list-style: none;
      }

      .review-item-list {
        list-style: none;
        padding: 0;
      }
      /* Styling for the clickable flashcard item itself */
      .review-item-list li.flashcard-item,
      .review-item-list li.lab-item {
        /* Also apply to lab items */
        margin-bottom: 10px; /* More space between items */
        padding: 10px 15px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        background-color: #f9f9f9;
        transition: background-color 0.2s ease, border-color 0.2s ease;
        cursor: pointer; /* Make the whole li clickable */
        display: flex;
        align-items: flex-start; /* Align checkbox to top of text */
        flex-wrap: wrap; /* Allow tags to wrap */
      }
      .review-item-list li.flashcard-item:hover,
      .review-item-list li.lab-item:hover {
        background-color: #f0f0f0;
        border-color: #cce4ff; /* Light blue hover border */
      }
      .review-item-list li.flashcard-item.active,
      .review-item-list li.lab-item.active {
        /* When content is revealed */
        border-color: var(--flashcard-reveal-border);
        background-color: var(--flashcard-reveal-bg);
      }
      .review-item-list input[type="checkbox"] {
        margin-right: 12px;
        transform: scale(1.1);
        accent-color: var(--review-main-color);
        flex-shrink: 0; /* Prevent checkbox from shrinking */
      }
      .review-item-list span.item-text {
        flex-grow: 1;
        color: #333;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        /* Makes the topic name look clickable */
      }
      .review-item-list span.item-tag {
        background-color: #e6f2ff;
        color: #005a9e;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        margin-left: 10px;
        white-space: nowrap; /* Prevent tags from breaking */
      }
      /* Confidence level styling */
      .review-item-list select.confidence-select {
        margin-left: 10px;
        padding: 3px 5px;
        border-radius: 3px;
        border: 1px solid #ccc;
        font-size: 0.85em;
        cursor: pointer;
        background-color: #fff;
        flex-shrink: 0; /* Prevent dropdown from shrinking */
        min-width: 120px; /* Give it a decent width */
        text-align: center;
      }
      .review-item-list select.confidence-select.none {
        background-color: #f0f0f0;
        border-color: #ccc;
        color: #606060;
      }
      .review-item-list select.confidence-select.weak {
        background-color: #f8d7da;
        border-color: var(--confidence-weak);
        color: var(--confidence-weak);
      }
      .review-item-list select.confidence-select.medium {
        background-color: #fff3cd;
        border-color: var(--confidence-medium);
        color: #856404;
      }
      .review-item-list select.confidence-select.strong {
        background-color: #d4edda;
        border-color: var(--confidence-strong);
        color: var(--confidence-strong);
      }

      .review-item-list li.reviewed {
        background-color: #e8f5e9;
        border-left: 5px solid var(--success-color);
        opacity: 0.8;
      }
      /* Lab section grouping and highlight for quick navigation */
      .lab-section-header {
        background: #f1f7ee;
        padding: 8px 12px;
        margin: 8px 0 6px 0;
        border-radius: 4px;
        font-weight: 700;
        color: #2e6b2e;
        border: 1px solid #e0efe0;
      }
      .lab-section-list {
        list-style: none;
        padding-left: 8px;
        margin: 6px 0 14px 0;
      }
      .lab-highlight {
        animation: lab-highlight-pulse 2s ease-in-out 0s 2;
        border: 2px solid #ffcc33;
        box-shadow: 0 4px 14px rgba(255, 204, 51, 0.25);
        background-color: #fffbe6 !important;
      }
      @keyframes lab-highlight-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.01); }
        100% { transform: scale(1); }
      }
      /* Brief highlight when a flashcard is revealed via Next Steps */
      .flashcard-open-highlight {
        animation: flashcard-open-pulse 1.2s ease-in-out 0s 1;
        box-shadow: 0 8px 20px rgba(0,122,204,0.12);
        border: 1px solid rgba(0,122,204,0.25) !important;
        background-color: rgba(230,242,255,0.9) !important;
      }
      @keyframes flashcard-open-pulse {
        0% { transform: translateY(0); }
        30% { transform: translateY(-4px); }
        100% { transform: translateY(0); }
      }
      .review-item-list li.reviewed span.item-text {
        text-decoration: line-through;
        color: #606060;
      }

      /* Flashcard Content Area */
      .flashcard-content-area {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: max-height 0.4s ease-out, opacity 0.3s ease-in;
        margin-top: 10px;
        padding: 15px;
        border-top: 1px solid var(--flashcard-reveal-border);
        background-color: var(--flashcard-reveal-bg);
        border-radius: 0 0 4px 4px; /* Rounded bottom corners */
        width: 100%;
        box-sizing: border-box; /* Include padding in width */
      }
      .flashcard-content-area.show {
        max-height: 3000px; /* increased to fully display all domains */
        overflow-y: auto;   /* ensures scroll if needed */
        padding: 20px;
        opacity: 1;
      }
      .az104-tip {
        position: relative;
        z-index: 1; /* prevents covering text */
      }
      .flashcard-content-area h4 {
        color: var(--azure-blue-dark);
        font-size: 1em;
        margin-top: 0;
        margin-bottom: 8px;
        padding-bottom: 3px;
        border-bottom: 1px dotted #a0c3e0; /* Lighter dotted border */
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .flashcard-content-area h4 i {
        color: var(--flashcard-reveal-border);
        font-size: 0.9em;
      }
      .flashcard-content-area ul {
        list-style: disc; /* Regular bullet points */
        padding-left: 20px;
        margin-top: 5px;
        font-size: 0.9em;
      }
      .flashcard-content-area ul li {
        margin-bottom: 5px;
        padding-left: 0; /* Remove extra padding from global li rule */
        position: static; /* Remove absolute positioning from global li rule */
      }
      .flashcard-content-area ul li i.fa-li {
        /* Override fa-li icon if present */
        display: none;
      }
      .flashcard-content-area strong {
        color: var(--flashcard-card-color);
      }
      .flashcard-content-area .mnemonic-internal {
        background-color: #e3f2fd; /* Even lighter blue */
        border-left: 3px solid #0078d4;
        padding: 8px 12px;
        margin: 10px 0;
        font-size: 0.9em;
        font-weight: bold;
        color: #004578;
      }
      .flashcard-content-area .mnemonic-internal i {
        margin-right: 5px;
        color: #0078d4;
      }

      .domain-progress-row {
        display: flex;
        align-items: center;
        margin-top: 10px;
        font-size: 0.9em;
      }
      .domain-progress-row .domain-icon {
        margin-right: 8px;
        font-size: 1.1em;
        width: 20px; /* Fixed width for icons */
        text-align: center;
      }
      .domain-progress-row .progress-meter {
        /* Adjust for inline display */
        flex-grow: 1;
        margin-right: 10px;
        height: 20px; /* Fixed height for progress bar container */
        background-color: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        display: flex;
        align-items: center;
      }
      .domain-progress-row .progress-meter .progress-bar {
        height: 100%;
        background-color: #ccc;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 5px;
        color: var(--text-dark);
        font-weight: normal;
        transition: width 0.4s ease-in-out, background-color 0.4s ease-in-out;
        font-size: 0.8em;
      }
      .domain-progress-row .progress-meter .progress-bar.strong {
        background-color: var(--confidence-strong);
        color: var(--text-light);
      }
      .domain-progress-row .progress-meter .progress-bar.medium {
        background-color: var(--confidence-medium);
        color: var(--text-dark);
      }
      .domain-progress-row .progress-meter .progress-bar.weak {
        background-color: var(--confidence-weak);
        color: var(--text-light);
      }

      .domain-progress-row .domain-percentage-text {
        /* Textual percentage display */
        width: 40px; /* Fixed width */
        text-align: right;
        font-weight: bold;
        color: var(--azure-blue-dark);
        margin-left: 8px;
      }

      /* Next Steps Tracker Styling */
      .next-steps-tracker {
        background-color: var(--next-step-bg);
        border: 1px solid var(--next-step-border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        text-align: center;
      }
      .next-steps-tracker h3 {
        color: var(--next-step-title-color);
        font-size: 1.3em;
        margin-top: 0;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--next-step-border);
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .next-steps-tracker .tracker-content {
        text-align: left;
        padding: 10px 0;
        font-size: 1em;
      }
      .next-steps-tracker .tracker-section {
        margin-bottom: 10px;
      }
      .next-steps-tracker .tracker-section strong {
        display: block;
        margin-bottom: 5px;
        color: var(--azure-blue-dark);
        font-size: 1.05em;
      }
      .next-steps-tracker .tracker-item {
        background-color: #f0f4f8;
        border: 1px solid #d1d1d1;
        padding: 8px 12px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
      }
      .next-steps-tracker .tracker-item.missing {
        color: #d83b01;
        font-style: italic;
      }
      .next-steps-tracker .tracker-item i {
        font-size: 1.1em;
        color: var(--review-main-color);
      }
      .next-steps-tracker .tracker-item span.title {
        flex-grow: 1;
        font-weight: 500;
      }
      .next-steps-tracker .tracker-item a {
        color: var(--flashcard-card-color);
        text-decoration: none;
        font-weight: bold;
      }
      .next-steps-tracker .tracker-item a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <!-- Whizlabs data and merged quiz scores are centralized in the consolidated script below -->
    <div class="back-to-hub-container">
      <div class="back-to-hub">
        <a href="index.html"
          ><i class="fas fa-arrow-left"></i>Back to Study Hub</a
        >
      </div>
    </div>

    <!-- merged quiz scores moved to consolidated script -->
    <div class="main-container">
      <h1>
        <i class="fas fa-bullseye"></i>Personalized Review: Weak Spot Focus
      </h1>

        <!-- Inline saved merged quiz scores (editable by in-page Save) -->
        <script id="merged-quiz-scores-json" type="application/json">
        {
  "Identities": { "correct": 25, "total": 44 },
  "Storage": { "correct": 17, "total": 40 },
  "Compute": { "correct": 14, "total": 38 },
  "Networking": { "correct": 18, "total": 31 },
  "Monitoring": { "correct": 14, "total": 26 }
}
        </script>

        <!-- Compact Score Editor (floating, minimal footprint) -->
        <div id="score-editor" style="position:fixed;right:12px;bottom:12px;z-index:1200;font-family:inherit">
          <button id="score-editor-toggle" title="Open score editor" style="background:#2c3e50;color:#fff;border:0;border-radius:6px;padding:6px 8px;cursor:pointer">Scores ▾</button>
          <div id="score-editor-panel" style="display:none;background:#fff;border:1px solid #ddd;border-radius:6px;padding:8px 10px;box-shadow:0 6px 18px rgba(0,0,0,0.08);width:320px;margin-top:6px">
            <div style="font-size:13px;margin-bottom:6px;font-weight:700">Quick: Add Quiz Marks</div>
            <div style="display:flex;gap:6px;margin-bottom:6px">
              <select id="score-editor-domain" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px"></select>
            </div>
            <div style="display:flex;gap:6px;margin-bottom:6px">
              <input id="score-editor-add-correct" type="number" placeholder="+ correct (use negative to subtract)" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px" />
              <input id="score-editor-add-total" type="number" placeholder="+ total (use negative to subtract)" style="width:84px;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px" />
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:6px">
              <div style="display:flex;gap:6px;align-items:center">
                <label style="font-size:12px;color:#444;margin-right:6px">Blend:</label>
                <select id="score-editor-blend" title="Blend quiz vs confidence" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px">
                  <option value="0.6">60% quiz / 40% confidence</option>
                  <option value="0.7">70% quiz / 30% confidence</option>
                  <option value="0.5">50% quiz / 50% confidence</option>
                  <option value="0.4">40% quiz / 60% confidence</option>
                </select>
                <button id="blend-tip-btn" title="What is blend?" style="margin-left:8px;border:0;background:#eef;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:12px;color:#234">i</button>
              </div>
              <div id="blend-tip" style="display:none;font-size:12px;color:#444;line-height:1.2">Blend controls how much weight the page gives to your quiz numbers versus your self-rated confidence when calculating domain mastery. For example, 60% quiz / 40% confidence blends both to produce the displayed percent and affects recommended labs.</div>
            </div>
            <div style="display:flex;gap:6px;justify-content:flex-end;align-items:center">
              <button id="score-editor-apply" style="background:#3498db;color:#fff;border:0;padding:6px 8px;border-radius:4px;cursor:pointer">Apply</button>
              <button id="score-editor-undo" title="Undo last Apply" disabled style="background:#f39c12;color:#fff;border:0;padding:6px 8px;border-radius:4px;cursor:pointer;margin-left:4px">Undo</button>
              <button id="score-editor-save" style="background:#27ae60;color:#fff;border:0;padding:6px 8px;border-radius:4px;cursor:pointer;margin-left:4px">Save</button>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px;margin-bottom:4px">
              <input type="checkbox" id="score-editor-autocollapse" />
              <label for="score-editor-autocollapse" style="font-size:13px;color:#444;cursor:pointer">Auto-collapse other domains when opening a domain</label>
            </div>
            <div id="score-editor-msg" style="font-size:12px;color:#666;margin-top:8px;min-height:18px"></div>

            <!-- Collapsed debug area inside Score Editor -->
            <div style="margin-top:8px">
              <button id="debug-toggle" style="background:#f3f3f3;border:0;padding:6px 8px;border-radius:4px;cursor:pointer;font-size:12px">Debug ▾</button>
              <div id="debug-area" style="display:none;margin-top:8px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                  <strong style="font-size:13px">Debug</strong>
                  <div>
                    <button id="debug-refresh" style="background:#3498db;color:#fff;border:0;padding:4px 6px;border-radius:4px;cursor:pointer;font-size:12px">Refresh</button>
                  </div>
                </div>
                <div style="max-height:180px;overflow:auto;font-family:monospace;background:#fafafa;padding:6px;border-radius:4px;border:1px solid #f0f0f0" id="debug-panel-body">loading...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Toast / temporary confirmation -->
        <div id="global-toast" style="position:fixed;right:12px;bottom:84px;z-index:1300;display:none;max-width:320px;background:rgba(0,0,0,0.85);color:#fff;padding:10px 12px;border-radius:6px;box-shadow:0 8px 20px rgba(0,0,0,0.3);font-size:13px"></div>

        <!-- Debug panel moved into the Score Editor panel (collapsed by default) -->

  <!-- Next Steps Tracker -->
  <div class="next-steps-tracker">
        <h3>
          <i class="fas fa-arrow-circle-right"></i>Your Next Steps Tracker
        </h3>
        <div id="next-steps-content" class="tracker-content">
          <!-- Dynamic content will be rendered here -->
        </div>
        <div class="az104-tip" style="margin-top: 15px">
          <i class="fas fa-info-circle"></i>This section guides you to your next
          priority flashcard and lab. Mark items as 'Strong' to progress!
        </div>
      </div>
      <!-- Domain progress rendering moved to consolidated script -->

  <!-- Inline lab-module mapping -->
      <script id="lab-module-map" type="application/json">
      {
        "labs": [
          {
            "labId": "lab-001",
            "title": "Create Users, Groups, Assign Roles",
            "modules": ["identity","rbac","users"],
            "domains": ["Identities"],
            "tags": ["rbac","entra","roles"],
            "difficulty": 0.4,
            "estimatedMinutes": 25,
            "priority": 1,
            "section": "1. Manage Azure subscriptions and governance",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-001b",
            "title": "Guest/B2B Invite Flow Lab",
            "modules": ["identity","b2b","guest"],
            "domains": ["Identities"],
            "tags": ["b2b","guest","invites"],
            "difficulty": 0.45,
            "estimatedMinutes": 20,
            "priority": 2,
            "section": "1. Manage Azure subscriptions and governance",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-002",
            "title": "Configure Azure Files Auth & Recovery",
            "modules": ["storage","files","auth"],
            "domains": ["Storage"],
            "tags": ["azure files","entra ds","smb"],
            "difficulty": 0.5,
            "estimatedMinutes": 30,
            "priority": 1,
            "section": "3. Configure Azure Files and Azure Blob Storage",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-002b",
            "title": "Blob Storage Tiering & Snapshots",
            "modules": ["storage","blob","snapshots"],
            "domains": ["Storage"],
            "tags": ["blob","snapshot","tiering"],
            "difficulty": 0.5,
            "estimatedMinutes": 25,
            "priority": 2,
            "section": "3. Configure Azure Files and Azure Blob Storage",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298",
            "challenge": true,
            "challengeId": 1
          },
          {
            "labId": "lab-003",
            "title": "Deploy VM & App Service",
            "modules": ["compute","vm","appservice"],
            "domains": ["Compute"],
            "tags": ["vm","app service","deployment"],
            "difficulty": 0.5,
            "estimatedMinutes": 35,
            "priority": 2,
            "section": "5. Create and configure VMs",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-003b",
            "title": "VM Migration & Disk Snapshot Lab",
            "modules": ["compute","migration","snapshot"],
            "domains": ["Compute"],
            "tags": ["migration","snapshot","disk"],
            "difficulty": 0.6,
            "estimatedMinutes": 40,
            "priority": 3,
            "section": "5. Create and configure VMs",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-004",
            "title": "Configure VNet, Subnets, NSGs",
            "modules": ["networking","vnet","nsg"],
            "domains": ["Networking"],
            "tags": ["vnet","subnet","nsg","peering"],
            "difficulty": 0.6,
            "estimatedMinutes": 40,
            "priority": 1,
            "section": "8. Configure virtual networks",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-004b",
            "title": "Load Balancer & NAT Rules Lab",
            "modules": ["networking","lb","nat"],
            "domains": ["Networking"],
            "tags": ["lb","nat","routing"],
            "difficulty": 0.6,
            "estimatedMinutes": 30,
            "priority": 2,
            "section": "9. Configure load balancing",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298",
            "challenge": true,
            "challengeId": 2
          },
          {
            "labId": "lab-005",
            "title": "Create Alerts and Workbooks",
            "modules": ["monitoring","alerts","workbooks"],
            "domains": ["Monitoring"],
            "tags": ["alerts","log analytics","kql"],
            "difficulty": 0.4,
            "estimatedMinutes": 30,
            "priority": 2,
            "section": "11. Monitor resources by using Azure Monitor",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          },
          {
            "labId": "lab-005b",
            "title": "KQL Basics & Log Analytics",
            "modules": ["monitoring","kql","logs"],
            "domains": ["Monitoring"],
            "tags": ["kql","log analytics","queries"],
            "difficulty": 0.45,
            "estimatedMinutes": 25,
            "priority": 1,
            "section": "11. Monitor resources by using Azure Monitor",
            "link": "https://www.whizlabs.com/learn/course/microsoft-azure-certification-az-104/298"
          }
        ]
      }
      </script>

  <!-- Consolidated script -->
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          // Centralized data (single source of truth)
          const whizlabsData = {
            labs: [
              { domain: "Identities", title: "Create Users, Groups, Assign Roles", completed: true },
              { domain: "Storage", title: "Configure Azure Files Auth & Recovery", completed: false },
              { domain: "Compute", title: "Deploy VM & App Service", completed: true },
              { domain: "Networking", title: "Configure VNet, Subnets, NSGs", completed: false },
              { domain: "Monitoring", title: "Create Alerts and Workbooks", completed: false }
            ]
          };

          const mergedQuizScores = {
            Identities: { correct: 25, total: 44 },
            Storage: { correct: 17, total: 40 },
            Compute: { correct: 14, total: 38 },
            Networking: { correct: 18, total: 31 },
            Monitoring: { correct: 14, total: 26 }
          };

          // If a persisted mergedQuizScores exists in localStorage, prefer it.
          // Otherwise fall back to the inline JSON script tag. This ensures
          // that Apply (which writes to localStorage) survives page reloads.
          (function loadMergedQuizScoresFromJson(){
            try {
              // Try localStorage first
              try {
                const raw = localStorage.getItem('mergedQuizScores');
                if (raw) {
                  const payloadLS = JSON.parse(raw);
                  if (payloadLS && typeof payloadLS === 'object') {
                    Object.keys(payloadLS).forEach(k => {
                      if (payloadLS[k] && (typeof payloadLS[k].correct !== 'undefined' || typeof payloadLS[k].total !== 'undefined')) {
                        mergedQuizScores[k] = { correct: payloadLS[k].correct || 0, total: payloadLS[k].total || 0 };
                      }
                    });
                    return; // loaded from localStorage, done
                  }
                }
              } catch(e) {
                // ignore localStorage parse errors and fallback to inline JSON
              }

              // Fallback: inline script element in the HTML (editable via Save)
              const el = document.getElementById('merged-quiz-scores-json');
              if (!el || !el.textContent || !el.textContent.trim()) return;
              const payload = JSON.parse(el.textContent);
              if (payload && typeof payload === 'object') {
                Object.keys(payload).forEach(k => {
                  if (payload[k] && (typeof payload[k].correct !== 'undefined' || typeof payload[k].total !== 'undefined')) {
                    mergedQuizScores[k] = { correct: payload[k].correct || 0, total: payload[k].total || 0 };
                  }
                });
              }
            } catch (e) {
              console.warn('Failed to load persisted mergedQuizScores', e);
            }
          })();

          // Runtime user confidence store (computed from selects). Values 0..1
          const userConfidence = {};
          const CONFIDENCE_VALUE = { none: null, weak: 0.3, medium: 0.6, strong: 0.9 };

          // Compute average confidence for a domain by inspecting selects inside its card
          function computeDomainConfidence(domainKey) {
            const card = document.getElementById(domainCardIdMap[domainKey]);
            if (!card) return null;
            const selects = Array.from(card.querySelectorAll('select.confidence-select'));
            const vals = selects.map(s => (s.value || 'none')).map(v => CONFIDENCE_VALUE[v]).filter(v => v != null);
            if (!vals.length) return null;
            const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
            userConfidence[domainKey] = avg; // store 0..1
            return avg * 100; // return percent
          }

          // Update mergedQuizScores with an adjusted percent that blends quiz-derived percent and user confidence
          function updateMergedQuizScoresFromConfidence() {
            // read blend ratio from the score editor (quizWeight: 0..1). default 0.6
            let quizWeight = 0.6;
            try {
              const sel = document.getElementById('score-editor-blend');
              if (sel && sel.value) quizWeight = parseFloat(sel.value) || 0.6;
            } catch (e) {}
            const confWeight = Math.max(0, Math.min(1, 1 - quizWeight));
            Object.keys(mergedQuizScores).forEach(domain => {
              const data = mergedQuizScores[domain];
              const origPercent = data.total ? (data.correct / data.total) * 100 : 0;
              const userPercent = computeDomainConfidence(domain);
              if (typeof userPercent === 'number') {
                data.adjustedPercent = Math.round((origPercent * quizWeight) + (userPercent * confWeight));
              } else {
                data.adjustedPercent = Math.round(origPercent);
              }
            });
          }

          // --- Persist adjusted percents (debounced) so Next Steps survive close/reopen ---
          const ADJUSTED_KEY = 'mergedQuizAdjusted';
          let _adjustedSaveTimer = null;
          const ADJUSTED_DEBOUNCE_MS = 1200; // aggregate quick changes

          function persistAdjustedNow(source){
            try{
              const adj = {};
              Object.keys(mergedQuizScores).forEach(k => { adj[k] = { adjustedPercent: mergedQuizScores[k].adjustedPercent || Math.round((mergedQuizScores[k].correct||0) / Math.max(1, mergedQuizScores[k].total||1) * 100) }; });
              try{ localStorage.setItem(ADJUSTED_KEY, JSON.stringify(adj)); }catch(e){}
              // also push a compact snapshot into history (non-blocking)
              try{ pushMergedQuizHistory(source || 'autosave'); }catch(e){}
            }catch(e){}
          }

          function schedulePersistAdjusted(source){
            try{
              if (_adjustedSaveTimer) clearTimeout(_adjustedSaveTimer);
              _adjustedSaveTimer = setTimeout(()=>{ persistAdjustedNow(source); _adjustedSaveTimer = null; }, ADJUSTED_DEBOUNCE_MS);
            }catch(e){}
          }

          // Map names used in page cards
          const domainCardIdMap = {
            Identities: "identities-focused-card",
            Storage: "storage-focused-card",
            Compute: "compute-focused-card",
            Networking: "networking-focused-card",
            Monitoring: "monitoring-focused-card"
          };

          const domainNamesMap = {
            Identities: "Manage Azure Identities",
            Storage: "Implement & Manage Storage",
            Compute: "Deploy & Manage Compute",
            Networking: "Configure Virtual Networking",
            Monitoring: "Monitor Azure Resources"
          };

          const domainDisplayNames = {
            Identities: "Identities & Governance",
            Storage: "Storage",
            Compute: "Compute",
            Networking: "Networking",
            Monitoring: "Monitoring"
          };

          // Simple mapping: recommend an Anki deck name per domain.
          // This is a friendly hint only — no live Anki integration is performed.
          const domainAnkiDeckMap = {
            Identities: "AZ-104 - Identities (Anki)",
            Storage: "AZ-104 - Storage (Anki)",
            Compute: "AZ-104 - Compute (Anki)",
            Networking: "AZ-104 - Networking (Anki)",
            Monitoring: "AZ-104 - Monitoring (Anki)"
          };

          function getRecommendedAnkiDeck(domainKey){
            return domainAnkiDeckMap[domainKey] || 'AZ-104 - Core (Anki)';
          }

          const domainIcons = {
            Identities: "fa-user-shield",
            Storage: "fa-database",
            Compute: "fa-server",
            Networking: "fa-network-wired",
            Monitoring: "fa-chart-line"
          };

          // --- Utility: ensure lab items have checkboxes ---
          function ensureLabCheckboxes() {
            document.querySelectorAll(".card").forEach((card) => {
              card.querySelectorAll("ul.review-item-list li.lab-item").forEach((li) => {
                if (!li.querySelector("input[type='checkbox']")) {
                  const firstChild = li.querySelector("span.item-text,strong,b");
                  if (firstChild && (firstChild.tagName === "STRONG" || firstChild.tagName === "B")) {
                    return; // skip headers
                  }
                  const cb = document.createElement("input");
                  cb.type = "checkbox";
                  cb.style.marginRight = "12px";
                  li.insertBefore(cb, li.firstChild);
                }
              });
            });

              // Challenge lab styling (injected here so single-file remains portable)
              (function injectChallengeStyles(){
                const css = `
                .lab-section-header { font-weight:700; margin-top:10px; color:#123; }
                .lab-section-list { margin:6px 0 12px 18px; padding:0; }
                li.lab-item { list-style:none; margin:6px 0; }
                li.lab-item .challenge-badge { display:inline-block; background:#b33; color:#fff; padding:2px 6px; border-radius:12px; font-size:12px; margin-right:8px; }
                li.lab-item.lab-challenge { border-left:3px solid #b33; padding-left:8px; background:rgba(179,51,51,0.03); }
                .next-step-challenge { font-weight:700; color:#b33; }
                `;
                const s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);
              })();
          }

          // --- Render domain progress bars ---
          function renderDomainProgress() {
            const container = document.getElementById("domain-progress-container");
            if (!container) return;
            container.innerHTML = "";
            let totalCorrect = 0, totalQuestions = 0;
            Object.values(mergedQuizScores).forEach(({ correct, total }) => {
              totalCorrect += correct; totalQuestions += total;
            });
            const overall = totalQuestions ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const overallEl = document.getElementById("overall-quiz-score");
            if (overallEl) overallEl.textContent = overall + "%";

            Object.keys(mergedQuizScores).forEach((domain) => {
              const data = mergedQuizScores[domain] || { correct: 0, total: 0 };
              const rawPercent = data.total ? Math.round((data.correct / data.total) * 100) : 0;
              const percent = (typeof data.adjustedPercent === 'number') ? Math.round(data.adjustedPercent) : rawPercent;
              let confidenceClass = "weak";
              if (percent >= 80) confidenceClass = "strong";
              else if (percent >= 40) confidenceClass = "medium";
              const html = `\n                <div class="domain-progress-row">\n                  <span class="domain-icon"><i class="fas ${domainIcons[domain]}"></i></span>\n                  <span class="domain-name">${domainDisplayNames[domain]}</span>\n                  <span class="progress-meter">\n                    <span class="progress-bar ${confidenceClass}" style="width: ${percent}%">${percent}%</span>\n                  </span>\n                  <span class="domain-percentage-text">${data.correct || 0}/${data.total || 0}</span>\n                </div>\n              `;
              container.insertAdjacentHTML('beforeend', html);
              const statEl = document.getElementById(domain.toLowerCase() + "-quiz-stats");
              if (statEl) statEl.textContent = `(${data.correct || 0}/${data.total || 0} correct, ${percent}%)`;
            });
            try{ renderRetentionTrends(); }catch(e){}
          }

          // --- Load inline lab-module map (single-file mode) ---
          let labModuleMap = [];
          function loadInlineLabModuleMap() {
            const el = document.getElementById('lab-module-map');
            if (el && el.textContent && el.textContent.trim()) {
              try {
                const payload = JSON.parse(el.textContent);
                labModuleMap = Array.isArray(payload.labs) ? payload.labs : (payload || []);
              } catch (e) {
                console.warn('Failed to parse inline lab-module map', e);
                labModuleMap = [];
              }
            }
          }

          // --- Recommend labs for a flashcard using the inline map (fallbacks to whizlabsData) ---
          function recommendLabsForFlashcard(domain, flashcardTitle, topN = 3) {
            // Use the curated inline labModuleMap only — this avoids recommending
            // labs that aren't actually available on Whizlabs and prevents
            // falling back to a secondary list that may be incomplete.
            const source = (labModuleMap && labModuleMap.length) ? labModuleMap : [];
            const keywords = (flashcardTitle || '').toLowerCase().split(/\s+/).filter(Boolean);
            if (!keywords.length) return [];
            const scored = source.map((lab) => {
              const labDomains = (lab.domains || []).map(s => (s || '').toLowerCase());
              const labModules = (lab.modules || []).map(s => (s || '').toLowerCase());
              const labTags = (lab.tags || []).map(s => (s || '').toLowerCase());
              const title = (lab.title || '').toLowerCase();
              const domainMatch = labDomains.includes((domain || '').toLowerCase()) ? 1 : 0;
              const keywordMatches = keywords.reduce((acc, k) => acc + (title.includes(k) || labModules.includes(k) || labTags.includes(k) ? 1 : 0), 0);
              const moduleScore = keywordMatches / Math.max(1, keywords.length);
              const difficultyBonus = 1 - (lab.difficulty || 0.5);
              const priorityBonus = 1 / (1 + (lab.priority || 1));
              // Base score
              let finalScore = 0.6 * domainMatch + 0.25 * moduleScore + 0.1 * difficultyBonus + 0.05 * priorityBonus;
              // If user has low confidence for the domain, boost labs for that domain
              const uconf = userConfidence[domain]; // 0..1 or undefined
              if (typeof uconf === 'number') {
                // lower confidence -> higher boost. scale: up to +0.2
                finalScore += (1 - uconf) * 0.2;
              }
              return { lab, score: finalScore };
            });
            return scored.sort((a, b) => b.score - a.score).slice(0, topN).map(s => s.lab);
          }

          // --- Get next unchecked flashcard in a card ---
          function getNextFlashcard(domainKey) {
            const card = document.getElementById(domainCardIdMap[domainKey]);
            if (!card) return null;
            const cb = card.querySelector('.flashcard-item input[type="checkbox"]:not(:checked)');
            if (!cb) return null;
            let title = '';
            const textEl = cb.parentElement.querySelector('.item-text');
            if (textEl) title = textEl.textContent.trim();
            else if (cb.nextSibling) title = (cb.nextSibling.textContent || '').trim();
            return { title, element: cb };
          }

          // Open and reveal a flashcard given its checkbox element (or li)
          function openFlashcardForCheckbox(cbOrEl){
            try{
              const cb = (cbOrEl && cbOrEl.tagName === 'INPUT') ? cbOrEl : (cbOrEl && cbOrEl.querySelector ? cbOrEl.querySelector('input[type="checkbox"]') : null);
              if (!cb) return;
              const li = cb.closest('li.flashcard-item');
              if (!li) return;
              const content = li.querySelector('.flashcard-content-area');
              // Optionally collapse other domain cards when opening one (controlled by Score Editor checkbox)
              try{
                const autocollapseEl = document.getElementById('score-editor-autocollapse');
                const autocollapse = autocollapseEl ? !!autocollapseEl.checked : (localStorage.getItem('scoreEditorAutoCollapse') === 'true');
                const parentCard = li.closest('.card');
                if (autocollapse) {
                  document.querySelectorAll('.card').forEach(c => {
                    if (c !== parentCard) {
                      const toggle = c.querySelector('input.card-toggle');
                      if (toggle) try { toggle.checked = false; } catch(e) {}
                      c.querySelectorAll('.flashcard-content-area').forEach(fc=>fc.classList.remove('show'));
                      c.querySelectorAll('.flashcard-item').forEach(it=>it.classList.remove('active'));
                    }
                  });
                } else {
                  // just collapse any open flashcard content globally to avoid multiple open contents
                  document.querySelectorAll('.flashcard-content-area').forEach(c=>c.classList.remove('show'));
                  document.querySelectorAll('.flashcard-item').forEach(it=>it.classList.remove('active'));
                }
              } catch(e) { /* ignore */ }

              if (content) {
                content.classList.add('show');
                li.classList.add('active');
                // scroll into view
                li.scrollIntoView({behavior:'smooth', block:'center'});
                // brief highlight to make revealed flashcard obvious
                try{
                  li.classList.remove('flashcard-open-highlight');
                  void li.offsetWidth;
                  li.classList.add('flashcard-open-highlight');
                  setTimeout(()=>{ try{ li.classList.remove('flashcard-open-highlight'); }catch(e){} }, 1400);
                }catch(e){}
              }
            }catch(e){/* ignore */}
          }

          // --- Update the Next Steps Tracker (renders clickable lab links) ---
          function escapeHtml(str) {
            return String(str)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
          }

          function updateNextStepsTracker() {
            // Determine weakest domain based only on remaining flashcards
            let weakestDomain = null; let lowestPercent = 101;
            Object.keys(mergedQuizScores).forEach((domain) => {
              const data = mergedQuizScores[domain] || { correct: 0, total: 0 };
              const percent = (typeof data.adjustedPercent === 'number') ? Number(data.adjustedPercent) : (data.total ? (data.correct / data.total) * 100 : 0);
              const card = document.getElementById(domainCardIdMap[domain]);
              if (!card) return;
              // Only consider uncompleted flashcards for prioritization
              const nextFlash = card.querySelector('.flashcard-item input[type="checkbox"]:not(:checked)');
              if (nextFlash && percent < lowestPercent) {
                lowestPercent = percent; weakestDomain = domain;
              }
            });
            const trackerContent = document.getElementById('next-steps-content');
            if (!trackerContent) return;
            if (!weakestDomain) { trackerContent.innerHTML = '<strong>All domains completed!</strong>'; return; }
            const currentFlash = getNextFlashcard(weakestDomain);
            const nextFlashTitle = currentFlash && currentFlash.title ? currentFlash.title : 'All flashcards completed!';
            const matchedLabs = currentFlash && currentFlash.title ? recommendLabsForFlashcard(weakestDomain, currentFlash.title, 3) : [];

            let nextLabHtml = 'No relevant labs found.';
            if (matchedLabs.length) {
              nextLabHtml = matchedLabs.map(l => {
                  const title = escapeHtml(l.title || 'Untitled Lab');
                  const mins = l.estimatedMinutes ? ` (${l.estimatedMinutes} min)` : '';
                  const challengeBadgeInline = l.challenge ? ` <span class="next-step-challenge">(Challenge #${escapeHtml((l.challengeId||'').toString())})</span>` : '';
                // Prefer same-page anchors to avoid external login redirects.
                const anchorId = `lab-${(l.labId||l.title||'').toString().replace(/[^a-z0-9-_]/gi, '-').toLowerCase()}`;
                return `<a href="#${anchorId}" data-internal-link="true">${title}</a>${mins}${challengeBadgeInline}`;
              }).join(' <span style="color:#999">•</span> ');
            }

            // Also update per-domain trackers inside each card so they reflect the next unchecked flashcard and recommended labs for that domain
            Object.keys(domainCardIdMap).forEach(domainKey => {
              try{
                const card = document.getElementById(domainCardIdMap[domainKey]);
                if (!card) return;
                const tracker = card.querySelector('.next-steps-tracker');
                if (!tracker) return;
                const nextFlash = getNextFlashcard(domainKey);
                const nfTitle = nextFlash && nextFlash.title ? escapeHtml(nextFlash.title) : 'All flashcards completed!';
                const matched = nextFlash && nextFlash.title ? recommendLabsForFlashcard(domainKey, nextFlash.title, 3) : [];
                let labHtml = 'No relevant labs found.';
                if (matched.length){
                  labHtml = matched.map(l => {
                    const t = escapeHtml(l.title || 'Untitled Lab');
                    const mins = l.estimatedMinutes ? ` (${l.estimatedMinutes} min)` : '';
                    const anchorId = `lab-${(l.labId||l.title||'').toString().replace(/[^a-z0-9-_]/gi, '-').toLowerCase()}`;
                    return `<a href="#${anchorId}" data-internal-link="true">${t}</a>${mins}`;
                  }).join(' <span style="color:#999">•</span> ');
                }
                // Update the first tracker-section (Next Flashcard)
                const sections = tracker.querySelectorAll('.tracker-section');
                if (sections && sections.length){
                  const flashSection = sections[0];
                  const flashTitleEl = flashSection.querySelector('.tracker-item .title');
                  if (flashTitleEl) flashTitleEl.innerHTML = nfTitle;
                }
                if (sections && sections.length > 1){
                  const labSection = sections[1];
                  const labTitleEl = labSection.querySelector('.tracker-item .title');
                  if (labTitleEl) labTitleEl.innerHTML = labHtml;
                    // Update or insert recommended Anki deck hint for this domain
                    try{
                      const deckName = escapeHtml(getRecommendedAnkiDeck(domainKey));
                      let deckItem = labSection.querySelector('.anki-deck-item');
                      const deckInner = `<i class="fas fa-book"></i> <span class="title">Recommended Anki deck: ${deckName}</span>`;
                      if (deckItem) {
                        deckItem.innerHTML = deckInner;
                      } else {
                        labSection.insertAdjacentHTML('beforeend', `<div class="tracker-item anki-deck-item">${deckInner}</div>`);
                      }
                    }catch(e){}
                }
              }catch(e){/* ignore per-card update failures */}
            });
            attachInternalLinkHandlers();
          
            // Render the global tracker content (cleaned HTML)
            trackerContent.innerHTML = `
              <strong>Next Step: ${domainNamesMap[weakestDomain]} (~${Math.round(lowestPercent)}% Mastery)</strong>
              <div style="margin:10px 0;display:flex;gap:8px;justify-content:center">
                <button id="go-next-step-btn" style="background:#0078d4;color:#fff;border:0;padding:6px 10px;border-radius:5px;cursor:pointer">Go to Next Flashcard</button>
                <button id="re-eval-btn" style="background:#f0ad4e;color:#fff;border:0;padding:6px 10px;border-radius:5px;cursor:pointer">Re-evaluate Recommendations</button>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">${escapeHtml(nextFlashTitle)}</span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">${nextLabHtml}</span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-book"></i>Recommended Anki Deck:</strong>
                <div class="tracker-item">
                  <i class="fas fa-book-open"></i>
                  <span class="title">${escapeHtml(getRecommendedAnkiDeck(weakestDomain))}</span>
                </div>
              </div>
              </div>
            `;
            // attach the interactive tracker buttons
            try{
              const goBtn = trackerContent.querySelector('#go-next-step-btn');
              if (goBtn && currentFlash && currentFlash.element) {
                goBtn.addEventListener('click', (ev)=>{
                  ev.preventDefault();
                  try{
                    // Ensure the domain card containing the flashcard is expanded/open
                    try{
                      const domainKey = weakestDomain;
                      const cardId = domainCardIdMap[domainKey];
                      const card = document.getElementById(cardId);
                      if (card) {
                        const toggle = card.querySelector('input.card-toggle');
                        if (toggle && !toggle.checked) {
                          try { toggle.checked = true; } catch(e) { /* ignore */ }
                          // also ensure the card-content is visible
                          const content = card.querySelector('.card-content');
                          if (content) content.style.display = 'block';
                        }
                      }
                    }catch(e){}
                    // reveal and scroll to the next flashcard
                    openFlashcardForCheckbox(currentFlash.element);
                  }catch(e){}
                });
              }
              const reBtn = trackerContent.querySelector('#re-eval-btn');
              if (reBtn) {
                reBtn.addEventListener('click', (ev)=>{
                  ev.preventDefault();
                  try{
                    updateMergedQuizScoresFromConfidence();
                    renderDomainProgress();
                    updateNextStepsTracker();
                    // Show a persistent clarifying toast unless autosave is enabled
                    try{
                      const autosaveEl = document.getElementById('score-editor-reval-autosave');
                      const autosave = autosaveEl ? !!autosaveEl.checked : false;
                      if (autosave) {
                        // Persist adjustedPercent snapshot (separate key; does not modify correct/total)
                        const adj = {};
                        Object.keys(mergedQuizScores).forEach(k => { adj[k] = { adjustedPercent: mergedQuizScores[k].adjustedPercent }; });
                        try { localStorage.setItem('mergedQuizAdjusted', JSON.stringify(adj)); }catch(e){}
                        try{ pushMergedQuizHistory('reval-autosave'); }catch(e){}
                        showToast('Recomputed recommendations and saved adjusted percents', 3000);
                      } else {
                        // persistent toast (until replaced)
                        showToast('Recomputed recommendations (not saved)', 0);
                      }
                    }catch(e){ showToast('Recomputed recommendations'); }
                  }catch(e){}
                });
              }
            }catch(e){}
          }

          // --- Prune Lab Tracker lists to mapped/recommended labs (reduces noise) ---
          function pruneLabListsToMapped() {
            if (!labModuleMap || !labModuleMap.length) return;
            Object.keys(domainCardIdMap).forEach(domainKey => {
              const card = document.getElementById(domainCardIdMap[domainKey]);
              if (!card) return;
              const lists = card.querySelectorAll('ul.review-item-list');
              if (!lists || lists.length === 0) return;
              // Usually the last review-item-list in the card is the lab tracker
              const labList = lists[lists.length - 1];
              // Clear existing lab items
              labList.innerHTML = '';
              // Find mapped labs for this domain
              let domainLabs = labModuleMap.filter(l => (l.domains || []).map(d => (d||'').toLowerCase()).includes(domainKey.toLowerCase()));
              // Fallback to whizlabsData if no mapped labs found
              if (!domainLabs.length) {
                domainLabs = (whizlabsData.labs || []).filter(l => (l.domain || '').toLowerCase().includes(domainKey.toLowerCase()));
              }
              // Group labs by first module (treat as section) or by 'section' field when present
              const grouped = {};
              domainLabs.forEach(lab => {
                const section = (lab.section || (lab.modules && lab.modules[0]) || 'General').toString();
                if (!grouped[section]) grouped[section] = [];
                grouped[section].push(lab);
              });
              // Insert grouped lab items with section headers
              Object.keys(grouped).forEach(sectionName => {
                const headerLi = document.createElement('li');
                headerLi.className = 'lab-section-header';
                headerLi.textContent = sectionName;
                labList.appendChild(headerLi);
                const sectionUl = document.createElement('ul');
                sectionUl.className = 'lab-section-list';
                grouped[sectionName].forEach(lab => {
                  const li = document.createElement('li');
                  li.className = 'lab-item';
                  if (lab.challenge) li.classList.add('lab-challenge');
                  // create a stable in-page id for the lab
                  const safeIdBase = (lab.labId || lab.title || '').toString().replace(/[^a-z0-9-_]/gi, '-').toLowerCase();
                  const anchorId = `lab-${safeIdBase}`;
                  li.id = anchorId;
                  const title = escapeHtml(lab.title || 'Untitled Lab');
                  const mins = lab.estimatedMinutes ? ` <span style="color:#666">(${lab.estimatedMinutes} min)</span>` : '';
                  // build optional challenge badge
                  const challengeBadge = lab.challenge ? `<span class="challenge-badge">Challenge #${escapeHtml((lab.challengeId||'').toString())}</span>` : '';
                  // Prefer same-page anchors so you stay inside the review page
                  li.innerHTML = `${challengeBadge}<a href="#${anchorId}" data-internal-link="true">${title}</a>${mins}`;
                  sectionUl.appendChild(li);
                });
                labList.appendChild(sectionUl);
              });
              // ensure internal links inside lab lists have handlers
              attachInternalLinkHandlers();
            });
          }

          // --- Attach checkbox/listener handling ---
          function attachListeners() {
            // Update Next Steps only when flashcards change (not when labs change)
            document.querySelectorAll('.flashcard-item input[type="checkbox"]').forEach(cb => {
              cb.removeEventListener('change', updateNextStepsTracker); // idempotent reattach
              cb.addEventListener('change', updateNextStepsTracker);
            });
            // Do not attach Next Steps updates to lab checkbox changes to avoid noisy updates
            // Lab checkboxes keep their own UI behavior but won't change the prioritization
            // Toggle flashcard content area when clicking item-text
            document.querySelectorAll('.flashcard-item .item-text').forEach(el => {
              el.addEventListener('click', (e) => {
                const li = el.closest('li.flashcard-item');
                if (!li) return;
                const content = li.querySelector('.flashcard-content-area');
                if (!content) return;
                const isShown = content.classList.contains('show');
                document.querySelectorAll('.flashcard-content-area').forEach(c=>c.classList.remove('show'));
                document.querySelectorAll('.flashcard-item').forEach(it=>it.classList.remove('active'));
                if (!isShown) { content.classList.add('show'); li.classList.add('active'); }
                // Also update next steps when the user actively opens a flashcard
                updateNextStepsTracker();
              });
            });
            // Intercept internal lab anchor clicks to smooth-scroll and highlight
            document.querySelectorAll('a[data-internal-link="true"]').forEach(a => {
              a.addEventListener('click', (ev) => {
                // Only handle same-page anchors
                const href = a.getAttribute('href') || '';
                if (!href.startsWith('#')) return;
                ev.preventDefault();
                const id = href.slice(1);
                const target = document.getElementById(id);
                if (!target) return;
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // briefly highlight
                target.classList.remove('lab-highlight');
                void target.offsetWidth; // force reflow
                target.classList.add('lab-highlight');
                // remove highlight after a delay
                setTimeout(() => target.classList.remove('lab-highlight'), 2500);
              });
            });
          }

          // Re-attach internal anchor handlers for dynamically-inserted links
          function attachInternalLinkHandlers() {
            document.querySelectorAll('a[data-internal-link="true"]').forEach(a => {
              // avoid double-binding
              if (a.__internalHandlerBound) return;
              const handler = (ev) => {
                const href = a.getAttribute('href') || '';
                if (!href.startsWith('#')) return;
                ev.preventDefault();
                const id = href.slice(1);
                const target = document.getElementById(id);
                if (!target) return;
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                target.classList.remove('lab-highlight');
                void target.offsetWidth;
                target.classList.add('lab-highlight');
                setTimeout(() => target.classList.remove('lab-highlight'), 2500);
              };
              a.addEventListener('click', handler);
              a.__internalHandlerBound = true;
            });
          }

          // --- Initialize ---
          loadInlineLabModuleMap();
          pruneLabListsToMapped();
          ensureLabCheckboxes();
          // compute initial confidence-adjusted scores and render
          // If an adjusted-percents snapshot exists from previous session, load it
          try{
            const rawAdj = localStorage.getItem('mergedQuizAdjusted');
            if (rawAdj) {
              try{
                const adj = JSON.parse(rawAdj);
                Object.keys(adj).forEach(k => { if (mergedQuizScores[k]) mergedQuizScores[k].adjustedPercent = adj[k] && typeof adj[k].adjustedPercent === 'number' ? adj[k].adjustedPercent : mergedQuizScores[k].adjustedPercent; });
              }catch(e){}
            }
          }catch(e){}
          updateMergedQuizScoresFromConfidence();
          renderDomainProgress();
          attachListeners();
          updateNextStepsTracker();

          // Wire up confidence select handlers so changes affect recommendations
          function attachConfidenceSelectHandlers() {
            // Attach handlers that persist confidence selections locally.
            // We intentionally DO NOT auto-recompute adjusted scores here to
            // avoid noisy changes while the user is editing many selects.
            document.querySelectorAll('select.confidence-select').forEach(sel => {
              sel.removeEventListener('change', sel.__confBoundHandler);
              const h = () => {
                try { saveFlashcardState(); } catch(e) {}
                // visual class updates
                ['none','weak','medium','strong'].forEach(c=>sel.classList.remove(c));
                if (sel.value) sel.classList.add(sel.value);
                // Recompute adjusted percent for the domain containing this select so
                // Next Steps and progress update immediately in constrained hosts
                try{
                  // find domainKey by locating the parent card id
                  const card = sel.closest('.card');
                  let domainKey = null;
                  if (card && card.id) {
                    domainKey = Object.keys(domainCardIdMap).find(k => domainCardIdMap[k] === card.id);
                  }
                  // compute and set adjustedPercent for this domain only
                  if (domainKey) {
                    const userPct = computeDomainConfidence(domainKey); // returns 0..100 or null
                    // read blend ratio
                    let quizWeight = 0.6;
                    try { const s = document.getElementById('score-editor-blend'); if (s && s.value) quizWeight = parseFloat(s.value) || 0.6; } catch(e){}
                    const confWeight = Math.max(0, Math.min(1, 1 - quizWeight));
                    const data = mergedQuizScores[domainKey] || { correct:0, total:0 };
                    const origPercent = data.total ? (data.correct / data.total) * 100 : 0;
                    if (typeof userPct === 'number') {
                      data.adjustedPercent = Math.round((origPercent * quizWeight) + (userPct * confWeight));
                    } else {
                      data.adjustedPercent = Math.round(origPercent);
                    }
                  }
                }catch(e){}
                // immediate visual feedback: update domain progress bars and next steps
                try{ renderDomainProgress(); }catch(e){}
                try{ updateNextStepsTracker(); }catch(e){}
                // schedule a debounced persist of adjusted percents so they are available after a reload/close
                try{ schedulePersistAdjusted('confidence-change'); }catch(e){}
              };
              sel.addEventListener('change', h);
              sel.__confBoundHandler = h;
            });
          }
          attachConfidenceSelectHandlers();

          // --- Compact Score Editor logic ---
          (function wireScoreEditor(){
            const domains = Object.keys(domainCardIdMap);
            const select = document.getElementById('score-editor-domain');
            domains.forEach(d => {
              const opt = document.createElement('option'); opt.value = d; opt.textContent = domainDisplayNames[d] || d; select.appendChild(opt);
            });
            const panel = document.getElementById('score-editor-panel');
            const toggle = document.getElementById('score-editor-toggle');
            toggle.addEventListener('click', () => { panel.style.display = panel.style.display === 'none' ? 'block' : 'none'; });

            // Toast + Undo + Debug helpers (scoped to the score editor wiring)
            const toastEl = document.getElementById('global-toast');
            function showToast(text, timeout = 3000){
              try{
                if (!toastEl) return;
                toastEl.textContent = text;
                toastEl.style.display = 'block';
                toastEl.style.opacity = '1';
                clearTimeout(showToast._t);
                // If timeout is > 0, auto-hide after that many ms. If timeout <= 0, keep persistent until next toast.
                if (typeof timeout === 'number' && timeout > 0) {
                  showToast._t = setTimeout(()=>{ try{ toastEl.style.opacity='0'; toastEl.style.display='none'; }catch(e){} }, timeout);
                }
              }catch(e){}
            }

            const undoBtnEl = document.getElementById('score-editor-undo');
            function enableUndo(){ if (undoBtnEl) undoBtnEl.disabled = false; }
            function disableUndo(){ if (undoBtnEl) undoBtnEl.disabled = true; try{ localStorage.removeItem('lastScoreEditorSnapshot'); }catch(e){} }

            function updateDebugPanel(){
              try{
                const body = document.getElementById('debug-panel-body');
                if (!body) return;
                const keys = ['mergedQuizScores','quizFlashcardState','scoreEditorBlend','scoreEditorAutoCollapse','lastScoreEditorSnapshot'];
                const out = {};
                keys.forEach(k => { try{ out[k] = JSON.parse(localStorage.getItem(k)); }catch(e){ out[k] = localStorage.getItem(k); } });
                body.textContent = JSON.stringify(out, null, 2);
              }catch(e){}
            }

            // Small merged-quiz debug badge (floating) to surface effective values
            function updateDebugBadge(){
              try{
                let badge = document.getElementById('merged-quiz-debug-badge');
                if (!badge) {
                  badge = document.createElement('div');
                  badge.id = 'merged-quiz-debug-badge';
                  badge.style.position = 'fixed';
                  badge.style.left = '12px';
                  badge.style.bottom = '12px';
                  badge.style.zIndex = '1400';
                  badge.style.background = 'rgba(0,0,0,0.75)';
                  badge.style.color = '#fff';
                  badge.style.padding = '8px 10px';
                  badge.style.borderRadius = '6px';
                  badge.style.fontSize = '12px';
                  badge.style.maxWidth = '320px';
                  badge.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
                  badge.style.fontFamily = 'Segoe UI, sans-serif';
                  document.body.appendChild(badge);
                }
                // Build content from mergedQuizScores
                const keys = Object.keys(mergedQuizScores || {});
                if (!keys.length) { badge.innerHTML = '<strong>No mergedQuizScores</strong>'; return; }
                const overallParts = keys.map(k => {
                  const d = mergedQuizScores[k] || { correct:0, total:0 };
                  const pct = d.total ? Math.round((d.correct/d.total)*100) : (typeof d.adjustedPercent === 'number' ? Math.round(d.adjustedPercent) : 0);
                  return `${k}: ${pct}% (${d.correct||0}/${d.total||0})`;
                });

                // sync indicator (optional): compare localStorage mergedQuizScores vs inline JSON
                function computeSyncStatus(){
                  try{
                    const rawLS = localStorage.getItem('mergedQuizScores');
                    const fromLS = rawLS ? JSON.parse(rawLS) : null;
                    const el = document.getElementById('merged-quiz-scores-json');
                    const fromInline = (el && el.textContent) ? JSON.parse(el.textContent) : null;
                    if (!fromLS || !fromInline) return { ok: !!fromLS && !!fromInline, equal: !!fromLS && !!fromInline && JSON.stringify(Object.keys(fromLS).sort().reduce((acc,k)=>{acc[k]={correct: fromLS[k].correct||0, total: fromLS[k].total||0}; return acc;},{}) ) === JSON.stringify(Object.keys(fromInline).sort().reduce((acc,k)=>{acc[k]={correct: fromInline[k].correct||0, total: fromInline[k].total||0}; return acc;},{}) ), fromLS, fromInline };
                    // Normalize shapes and compare per-domain correct/total
                    const norm = (obj) => {
                      const out = {};
                      Object.keys(obj).sort().forEach(k => { out[k] = { correct: (obj[k] && obj[k].correct) ? obj[k].correct : 0, total: (obj[k] && obj[k].total) ? obj[k].total : 0 }; });
                      return out;
                    };
                    const nLS = norm(fromLS);
                    const nIn = norm(fromInline);
                    const equal = JSON.stringify(nLS) === JSON.stringify(nIn);
                    return { ok: true, equal, fromLS: nLS, fromInline: nIn };
                  }catch(e){ return { ok:false, equal:false }; }
                }

                const syncPref = (function(){ try{ return localStorage.getItem('scoreEditorShowSyncIndicator') === 'true'; }catch(e){ return false; } })();
                const sync = syncPref ? computeSyncStatus() : null;
                let syncHtml = '';
                if (syncPref) {
                  if (!sync || !sync.ok) {
                    syncHtml = `<div style="margin-top:6px;color:#ffcc00;font-size:11px">Sync: unknown</div>`;
                  } else if (sync.equal) {
                    syncHtml = `<div style="margin-top:6px;color:#8bc34a;font-size:11px">Sync: Local = File</div>`;
                  } else {
                    syncHtml = `<div style="margin-top:6px;color:#ff7043;font-size:11px">Sync: Local differs</div>`;
                  }
                }

                badge.innerHTML = `<strong>Merged Scores</strong><div style="margin-top:6px;line-height:1.25">${overallParts.join('<br/>')}</div>${syncHtml}`;
              }catch(e){}
            }

            document.getElementById('debug-refresh') && document.getElementById('debug-refresh').addEventListener('click', updateDebugPanel);
            // debug toggle inside score editor
            const debugToggleBtn = document.getElementById('debug-toggle');
            const debugArea = document.getElementById('debug-area');
            if (debugToggleBtn && debugArea) debugToggleBtn.addEventListener('click', () => { debugArea.style.display = debugArea.style.display === 'none' ? 'block' : 'none'; updateDebugPanel(); });

            // Add optional Autosave toggle for Re-evaluate (persist adjustedPercent snapshot)
            try{
              const autosaveContainer = document.createElement('div');
              autosaveContainer.style.display = 'flex';
              autosaveContainer.style.alignItems = 'center';
              autosaveContainer.style.gap = '8px';
              autosaveContainer.style.marginTop = '8px';
              const autosaveCheckbox = document.createElement('input');
              autosaveCheckbox.type = 'checkbox';
              autosaveCheckbox.id = 'score-editor-reval-autosave';
              autosaveCheckbox.style.transform = 'scale(1.05)';
              const autosaveLabel = document.createElement('label');
              autosaveLabel.htmlFor = 'score-editor-reval-autosave';
              autosaveLabel.style.fontSize = '12px';
              autosaveLabel.style.color = '#333';
              autosaveLabel.textContent = 'Autosave re-evaluate adjusted percents';
              autosaveContainer.appendChild(autosaveCheckbox);
              autosaveContainer.appendChild(autosaveLabel);
              panel.appendChild(autosaveContainer);
              // Load persisted state
              try{ const raw = localStorage.getItem('scoreEditorRevalAutosave'); if (raw) autosaveCheckbox.checked = (raw === 'true'); }catch(e){}
              autosaveCheckbox.addEventListener('change', ()=>{ try{ localStorage.setItem('scoreEditorRevalAutosave', autosaveCheckbox.checked ? 'true' : 'false'); updateDebugPanel(); }catch(e){} });
              
              // --- Debug helpers: reload / clear mergedQuizScores ---
              // small debug control container (also hosts the optional sync indicator toggle)
              const dbgContainer = document.createElement('div'); dbgContainer.style.display='flex'; dbgContainer.style.gap='8px'; dbgContainer.style.marginTop='8px'; dbgContainer.style.justifyContent='space-between';
              const reloadBtn = document.createElement('button'); reloadBtn.textContent = 'Reload from inline JSON'; reloadBtn.style.flex='1'; reloadBtn.style.padding='6px'; reloadBtn.style.fontSize='12px'; reloadBtn.style.cursor='pointer';
              const clearBtn = document.createElement('button'); clearBtn.textContent = 'Clear mergedQuizScores LS'; clearBtn.style.flex='1'; clearBtn.style.padding='6px'; clearBtn.style.fontSize='12px'; clearBtn.style.cursor='pointer'; clearBtn.style.background='#b33'; clearBtn.style.color='#fff';
              // Optional sync indicator toggle (hidden by default, opt-in)
              const syncToggleContainer = document.createElement('div'); syncToggleContainer.style.display = 'flex'; syncToggleContainer.style.alignItems = 'center'; syncToggleContainer.style.gap = '6px';
              const syncToggle = document.createElement('input'); syncToggle.type = 'checkbox'; syncToggle.id = 'score-editor-show-sync-indicator';
              const syncLabel = document.createElement('label'); syncLabel.htmlFor = 'score-editor-show-sync-indicator'; syncLabel.style.fontSize = '12px'; syncLabel.style.color = '#333'; syncLabel.textContent = 'Show local vs file sync';
              syncToggleContainer.appendChild(syncToggle); syncToggleContainer.appendChild(syncLabel);
              // place toggle to the left of the buttons
              const leftGroup = document.createElement('div'); leftGroup.style.display='flex'; leftGroup.style.gap='8px'; leftGroup.style.flex='1'; leftGroup.appendChild(syncToggleContainer);
              const rightGroup = document.createElement('div'); rightGroup.style.display='flex'; rightGroup.style.gap='8px'; rightGroup.style.flex='2'; rightGroup.appendChild(reloadBtn); rightGroup.appendChild(clearBtn);
              dbgContainer.appendChild(leftGroup); dbgContainer.appendChild(rightGroup); panel.appendChild(dbgContainer);
              // Load persisted toggle state
              try{ const raw = localStorage.getItem('scoreEditorShowSyncIndicator'); if (raw) syncToggle.checked = (raw === 'true'); }catch(e){}
              // ensure badge reflects initial state
              try{ updateDebugBadge(); }catch(e){}
              syncToggle.addEventListener('change', ()=>{ try{ localStorage.setItem('scoreEditorShowSyncIndicator', syncToggle.checked ? 'true' : 'false'); updateDebugPanel(); updateDebugBadge(); }catch(e){} });
              // Handlers
              reloadBtn.addEventListener('click', ()=>{
                try{
                  // read inline JSON block and overwrite mergedQuizScores and LS
                  const el = document.getElementById('merged-quiz-scores-json');
                  if (!el) { showToast('Inline JSON block not found',3000); return; }
                  const payload = JSON.parse(el.textContent || '{}');
                  Object.keys(payload).forEach(k=>{ mergedQuizScores[k] = { correct: payload[k].correct||0, total: payload[k].total||0 }; });
                  const payloadToStore = {};
                  Object.keys(mergedQuizScores).forEach(k=>{ payloadToStore[k] = { correct: mergedQuizScores[k].correct||0, total: mergedQuizScores[k].total||0 }; });
                  try{ localStorage.setItem('mergedQuizScores', JSON.stringify(payloadToStore)); }catch(e){}
                  try{ window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payloadToStore })); }catch(e){}
                  updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker(); updateDebugPanel(); updateDebugBadge(); showToast('Reloaded mergedQuizScores from inline JSON',3000);
                }catch(e){ showToast('Reload failed'); }
              });
              clearBtn.addEventListener('click', ()=>{
                try{ localStorage.removeItem('mergedQuizScores'); showToast('Cleared mergedQuizScores from localStorage',3000); updateDebugPanel(); updateDebugBadge(); // reload from inline
                  try{ loadMergedQuizScoresFromJson(); updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker(); }catch(e){}
                }catch(e){ showToast('Clear failed'); }
              });
            }catch(e){}

            // undo handler: restore last snapshot saved by Apply (one-step undo)
            if (undoBtnEl) {
              undoBtnEl.addEventListener('click', () => {
                try{
                  const raw = localStorage.getItem('lastScoreEditorSnapshot');
                  if (!raw) { showToast('Nothing to undo'); return; }
                  const prev = JSON.parse(raw);
                  // restore values into mergedQuizScores
                  Object.keys(prev).forEach(k => { mergedQuizScores[k] = { correct: prev[k].correct || 0, total: prev[k].total || 0 }; });
                  const payload = {};
                  Object.keys(mergedQuizScores).forEach(k => { payload[k] = { correct: mergedQuizScores[k].correct || 0, total: mergedQuizScores[k].total || 0 }; });
                  const el = document.getElementById('merged-quiz-scores-json'); if (el) el.textContent = JSON.stringify(payload, null, 2);
                  try { localStorage.setItem('mergedQuizScores', JSON.stringify(payload)); } catch(e){}
                  try { window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payload })); } catch(e){}
                  updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker();
                  showToast('Undo: restored previous merged scores');
                  disableUndo();
                  updateDebugPanel();
                }catch(e){ showToast('Undo failed'); }
              });
            }

            const applyBtn = document.getElementById('score-editor-apply');
            const saveBtn = document.getElementById('score-editor-save');
            const inCorrect = document.getElementById('score-editor-add-correct');
            const inTotal = document.getElementById('score-editor-add-total');
            const msg = document.getElementById('score-editor-msg');

            applyBtn.addEventListener('click', () => {
              const domain = select.value;
              const deltaC = parseInt(inCorrect.value || 0, 10);
              const deltaT = parseInt(inTotal.value || 0, 10);
              if (!domain || (deltaC === 0 && deltaT === 0)) { msg.textContent = 'Enter numbers to add or subtract.'; return; }
              const data = mergedQuizScores[domain];
              if (!data) { msg.textContent = 'Unknown domain.'; return; }

              // Capture a snapshot for one-step undo (persist to localStorage)
              try{
                const prev = JSON.stringify(mergedQuizScores);
                localStorage.setItem('lastScoreEditorSnapshot', prev);
                enableUndo();
              }catch(e){}

              // apply deltas (allow negative values for subtraction)
              data.correct = (data.correct || 0) + (isNaN(deltaC) ? 0 : deltaC);
              data.total = (data.total || 0) + (isNaN(deltaT) ? 0 : deltaT);
              // Normalize values: totals and corrects cannot be negative; correct cannot exceed total
              data.total = Math.max(0, Math.round(data.total));
              data.correct = Math.max(0, Math.round(data.correct));
              if (data.correct > data.total) data.correct = data.total;

              // Persist current selections and blend, and persist mergedQuizScores to localStorage and inline JSON
              try{ saveFlashcardState(); saveScoreEditorBlend(); }catch(e){}
              try {
                const payload = {};
                Object.keys(mergedQuizScores).forEach(k => { payload[k] = { correct: mergedQuizScores[k].correct || 0, total: mergedQuizScores[k].total || 0 }; });
                // update inline script block so Save later matches current state
                const el = document.getElementById('merged-quiz-scores-json');
                if (el) el.textContent = JSON.stringify(payload, null, 2);
                try { localStorage.setItem('mergedQuizScores', JSON.stringify(payload)); } catch(e){}
                try { window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payload })); } catch(e){}
              } catch(e){}

              // re-run adjusted/confidence and UI
              updateMergedQuizScoresFromConfidence(); renderDomainProgress(); updateNextStepsTracker();
              msg.textContent = `Applied ${deltaC >= 0 ? '+'+deltaC : deltaC} correct, ${deltaT >= 0 ? '+'+deltaT : deltaT} total to ${domain}. New: ${data.correct}/${data.total}.`;
              inCorrect.value = ''; inTotal.value = '';

              // UI helpers
              showToast(`Applied changes to ${domain}`);
              try{ pushMergedQuizHistory('apply'); }catch(e){}
              updateDebugPanel();
            });

            // blend tip toggle
            const blendTipBtn = document.getElementById('blend-tip-btn');
            const blendTip = document.getElementById('blend-tip');
            if (blendTipBtn && blendTip) blendTipBtn.addEventListener('click', () => { blendTip.style.display = blendTip.style.display === 'none' ? 'block' : 'none'; });

            // Save: open confirmation modal; actual save happens on confirm
            saveBtn.addEventListener('click', () => {
              const modal = document.getElementById('score-save-modal');
              if (modal) modal.style.display = 'flex';
            });
            // Modal handlers
            const modal = document.getElementById('score-save-modal');
            if (modal) {
              const cancel = document.getElementById('score-save-cancel');
              const confirm = document.getElementById('score-save-confirm');
              cancel && cancel.addEventListener('click', () => { modal.style.display = 'none'; });
              confirm && confirm.addEventListener('click', () => {
                // perform save same as before
                try {
                  // write the current mergedQuizScores into the inline JSON script
                  const el = document.getElementById('merged-quiz-scores-json');
                  if (!el) { msg.textContent = 'Save failed: internal element not found.'; modal.style.display='none'; return; }
                  const payload = {};
                  Object.keys(mergedQuizScores).forEach(k => { payload[k] = { correct: mergedQuizScores[k].correct || 0, total: mergedQuizScores[k].total || 0 }; });
                  el.textContent = JSON.stringify(payload, null, 2);
                  try { localStorage.setItem('mergedQuizScores', JSON.stringify(payload)); } catch (e) { /* ignore storage failures */ }
                  // dispatch a storage-like event for same-window listeners
                  try { window.dispatchEvent(new CustomEvent('mergedQuizScoresUpdated', { detail: payload })); } catch(e){}
                  msg.textContent = 'Saved changes in-page and to localStorage. To persist to disk, choose "Save Page As..." in your browser and overwrite the file.';
                  showToast('Saved changes to merged quiz scores');
                  try{ pushMergedQuizHistory('save'); }catch(e){}
                  updateDebugPanel();
                } catch (e) { msg.textContent = 'Save failed: ' + (e && e.message); }
                modal.style.display = 'none';
              });
            }

            function buildMergedQuizScoresBlock(){
              // Build a string: const mergedQuizScores = { ... };
              const parts = Object.keys(mergedQuizScores).map(k => {
                const v = mergedQuizScores[k] || { correct:0, total:0 };
                return `  ${k}: { correct: ${v.correct || 0}, total: ${v.total || 0} }`;
              });
              return 'const mergedQuizScores = {\n' + parts.join(',\n') + '\n};';
            }

            // --- Persistence helpers: flashcard state (checkbox + confidence) and blend ---
            const FLASHCARD_STATE_KEY = 'quizFlashcardState';
            const SCORE_BLEND_KEY = 'scoreEditorBlend';
            const AUTO_COLLAPSE_KEY = 'scoreEditorAutoCollapse';

            function loadFlashcardState(){
              try{
                const raw = localStorage.getItem(FLASHCARD_STATE_KEY);
                if (!raw) return;
                const state = JSON.parse(raw);
                Object.keys(state).forEach(itemId => {
                  try{
                    const cb = document.getElementById(itemId);
                    if (cb && typeof state[itemId].checked !== 'undefined'){
                      cb.checked = !!state[itemId].checked;
                      const li = cb.closest('li.flashcard-item');
                      if (li) {
                        if (cb.checked) li.classList.add('reviewed'); else li.classList.remove('reviewed');
                      }
                    }
                    const sel = document.querySelector(`select.confidence-select[data-item-id="${itemId}"]`);
                    if (sel && state[itemId].confidence){
                      sel.value = state[itemId].confidence;
                      ['none','weak','medium','strong'].forEach(c=>sel.classList.remove(c));
                      if (state[itemId].confidence) sel.classList.add(state[itemId].confidence);
                    }
                  }catch(e){}
                });
              }catch(e){}
            }

            function saveFlashcardState(){
              try{
                const state = {};
                document.querySelectorAll('.flashcard-item').forEach(li => {
                  const cb = li.querySelector('input[type="checkbox"]');
                  if (!cb || !cb.id) return;
                  const sel = li.querySelector('select.confidence-select');
                  state[cb.id] = { checked: !!cb.checked, confidence: sel ? (sel.value || 'none') : 'none' };
                });
                localStorage.setItem(FLASHCARD_STATE_KEY, JSON.stringify(state));
              }catch(e){}
            }

            function loadScoreEditorBlend(){
              try{
                const v = localStorage.getItem(SCORE_BLEND_KEY);
                const sel = document.getElementById('score-editor-blend');
                if (sel && v) sel.value = v;
              }catch(e){}
            }

            function saveScoreEditorBlend(){
              try{
                const sel = document.getElementById('score-editor-blend');
                if (sel) localStorage.setItem(SCORE_BLEND_KEY, sel.value);
              }catch(e){}
            }

            function loadScoreEditorAutoCollapse(){
              try{
                const v = localStorage.getItem(AUTO_COLLAPSE_KEY);
                const el = document.getElementById('score-editor-autocollapse');
                if (el) {
                  if (v === null) {
                    // default: enabled (true) for a cleaner single-card focus
                    el.checked = true;
                  } else {
                    el.checked = (v === 'true');
                  }
                }
              }catch(e){}
            }

            function saveScoreEditorAutoCollapse(){
              try{
                const el = document.getElementById('score-editor-autocollapse');
                if (!el) return;
                localStorage.setItem(AUTO_COLLAPSE_KEY, el.checked ? 'true' : 'false');
              }catch(e){}
            }

            function loadScoreEditorRevalAutosave(){
              try{
                const v = localStorage.getItem('scoreEditorRevalAutosave');
                const el = document.getElementById('score-editor-reval-autosave');
                if (el) {
                  el.checked = (v === 'true');
                }
              }catch(e){}
            }

              // --- Retention history (trend scope) helpers ---
              const HISTORY_KEY = 'mergedQuizHistory';
              const HISTORY_MAX_KEY = 'mergedQuizHistoryMax'; // optional override

              function pushMergedQuizHistory(source){
                try{
                  const raw = localStorage.getItem(HISTORY_KEY);
                  let arr = raw ? JSON.parse(raw) : [];
                  const snap = {};
                  Object.keys(mergedQuizScores).forEach(k => {
                    const d = mergedQuizScores[k] || { correct:0, total:0 };
                    const p = (typeof d.adjustedPercent === 'number') ? d.adjustedPercent : (d.total ? Math.round((d.correct / d.total) * 100) : 0);
                    snap[k] = p;
                  });
                  arr.push({ t: (new Date()).toISOString(), domainPercents: snap, source: source || 'manual' });
                  const max = parseInt(localStorage.getItem(HISTORY_MAX_KEY)) || 30;
                  while(arr.length > max) arr.shift();
                  try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }catch(e){}
                }catch(e){}
              }

              function computeTrendMetrics(domain){
                try{
                  const raw = localStorage.getItem(HISTORY_KEY);
                  if (!raw) return null;
                  const arr = JSON.parse(raw).map(s => s.domainPercents && typeof s.domainPercents[domain] === 'number' ? s.domainPercents[domain] : null).filter(v => v != null);
                  if (!arr.length) return null;
                  const first = arr[0];
                  const last = arr[arr.length - 1];
                  const delta = last - first;
                  const slope = arr.length > 1 ? delta / (arr.length - 1) : 0;
                  // moving average of last 3
                  const maWindow = 3;
                  const windowVals = arr.slice(-maWindow);
                  const ma = Math.round(windowVals.reduce((a,b)=>a+b,0) / windowVals.length);
                  return { first, last, delta, slope, samples: arr, ma };
                }catch(e){ return null; }
              }

              function renderRetentionTrends(){
                try{
                  const containerId = 'retention-trends-container';
                  let container = document.getElementById(containerId);
                  if (!container){
                    // create a simple card and insert near the top of the card-container
                    const cardContainer = document.querySelector('.card-container');
                    if (!cardContainer) return;
                    const card = document.createElement('div'); card.className='card'; card.id='retention-trends-card';
                    card.innerHTML = `
                      <input type="checkbox" id="retention-trends-toggle" class="card-toggle" checked />
                      <label for="retention-trends-toggle" class="card-header lab-header"><h2><i class="fas fa-history"></i>Retention Trends</h2><i class="fas fa-chevron-down toggle-icon"></i></label>
                      <div class="card-content"><div id="${containerId}">Loading...</div></div>
                    `;
                    cardContainer.insertBefore(card, cardContainer.firstChild);
                    container = document.getElementById(containerId);
                  }
                  // build content
                  const raw = localStorage.getItem(HISTORY_KEY);
                  const history = raw ? JSON.parse(raw) : [];
                  if (!history.length) { container.innerHTML = '<p style="color:#666">No retention history yet — snapshots will appear when you Apply/Save (or Re-evaluate with autosave).</p>'; return; }
                  const domains = Object.keys(mergedQuizScores);
                  const rows = domains.map(domain => {
                    const m = computeTrendMetrics(domain);
                    if (!m) return '';
                    const trendClass = m.delta > 0 ? 'trend-up' : (m.delta < 0 ? 'trend-down' : 'trend-flat');
                    // sparkline simple polyline
                    const samples = m.samples;
                    const w = 120, h = 28, pad = 2;
                    const min = Math.min(...samples), max = Math.max(...samples);
                    const range = Math.max(1, max - min);
                    const points = samples.map((v,i)=>{
                      const x = pad + (i * (w - pad*2) / Math.max(1, samples.length-1));
                      const y = h - pad - ((v - min) * (h - pad*2) / range);
                      return x + ',' + y;
                    }).join(' ');
                    const spark = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg"><polyline fill="none" stroke="#0078d4" stroke-width="2" points="${points}" stroke-linejoin="round" stroke-linecap="round" /></svg>`;
                    const deltaSign = m.delta > 0 ? '▲' : (m.delta < 0 ? '▼' : '→');
                    return `
                      <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0f0f0">
                        <div style="flex:1;min-width:160px"><strong>${domainDisplayNames[domain] || domain}</strong><div style="font-size:12px;color:#666">last: ${m.last}% · Δ ${deltaSign}${Math.abs(m.delta)}</div></div>
                        <div style="width:140px;text-align:right">${spark}</div>
                      </div>
                    `;
                  }).join('\n');
                  container.innerHTML = rows;
                }catch(e){/* ignore */}
              }

            // Hook into UI elements to persist state idempotently
            function hookPersistenceHandlers(){
              // checkboxes
              document.querySelectorAll('.flashcard-item input[type="checkbox"]').forEach(cb => {
                if (cb.__persistHook) cb.removeEventListener('change', cb.__persistHook);
                const h = () => { try{ saveFlashcardState(); updateNextStepsTracker(); }catch(e){} };
                cb.addEventListener('change', h);
                cb.__persistHook = h;
              });
              // confidence selects: persist selection but do not auto-recompute
              document.querySelectorAll('select.confidence-select').forEach(sel => {
                if (sel.__persistHook) sel.removeEventListener('change', sel.__persistHook);
                const h = () => { try{ saveFlashcardState(); ['none','weak','medium','strong'].forEach(c=>sel.classList.remove(c)); if (sel.value) sel.classList.add(sel.value); }catch(e){} };
                sel.addEventListener('change', h);
                sel.__persistHook = h;
              });
              // blend select
              const blend = document.getElementById('score-editor-blend');
              if (blend){
                if (blend.__persistHook) blend.removeEventListener('change', blend.__persistHook);
                const bh = () => { try{ saveScoreEditorBlend(); }catch(e){} };
                blend.addEventListener('change', bh);
                blend.__persistHook = bh;
              }
              // auto-collapse checkbox persistence
              const ac = document.getElementById('score-editor-autocollapse');
              if (ac) {
                if (ac.__persistHook) ac.removeEventListener('change', ac.__persistHook);
                const ah = () => { try{ saveScoreEditorAutoCollapse(); }catch(e){} };
                ac.addEventListener('change', ah);
                ac.__persistHook = ah;
              }
            }

            // Initialize persisted UI state after the rest of the script sets up the DOM
            try{
              loadScoreEditorBlend();
              loadScoreEditorAutoCollapse();
              try{ loadScoreEditorRevalAutosave(); }catch(e){}
              loadFlashcardState();
              hookPersistenceHandlers();
              // initial debug panel render
              try{ updateDebugPanel(); }catch(e){}
              try{ if (localStorage.getItem('lastScoreEditorSnapshot')) enableUndo(); else disableUndo(); }catch(e){}
            }catch(e){}

          })();

        });
      </script>
  <!-- End consolidated script -->

      <div class="card-container">
        <!-- Card 1: Current Performance Snapshot -->
        <div class="card">
          <input
            type="checkbox"
            id="performance-snapshot-toggle"
            class="card-toggle"
            checked
          />
          <label
            for="performance-snapshot-toggle"
            class="card-header snapshot-header"
          >
            <h2>
              <i class="fas fa-chart-pie"></i>Current Performance Snapshot
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <h3><i class="fas fa-signal"></i>Your AZ-104 Study Breakdown</h3>
            <p class="snapshot-text">
              <strong>Overall Quiz Score:</strong>
              <span id="overall-quiz-score">Loading...</span><br /><br />
              <strong>Domain Mastery:</strong> (Based on your confidence ratings
              below)
            </p>

            <div id="domain-progress-container">
              <!-- Domain progress bars will be rendered here by JS -->
            </div>
            <div class="flashcard-content-area show" id="personalized-review-essay">
              <h4><i class="fas fa-lightbulb"></i>Personalized Review: Weak Spot Focus</h4>

              <p><strong>Identities & Governance (57% Accuracy) 🟠 Next Focus</strong></p>
              <p><strong>Observation:</strong> Moderate performance with gaps around RBAC vs Entra DS, group-based licensing, B2B guest invites, self-service password reset (SSPR) configurations per group, CLI vs Microsoft Graph commands, and Entra portal navigation.</p>
              <p><strong>Action:</strong> Target flashcards and labs on role assignments, guest/B2B invitations, group licensing, SSPR, and portal navigation. Focus on flashcards marked 🟠.</p>
              <p><strong>Next Steps:</strong> Practice creating users, groups, and roles in labs. Confirm understanding of RBAC vs directory permissions. Recommended labs: Create Users, Groups, Assign Roles, Guest/B2B Invite Flow Lab (link + 20–25 min).</p>

              <p><strong>Storage (43% Accuracy) ⚠ Major Weak Spot</strong></p>
              <p><strong>Observation:</strong> Weaknesses identified in Azure Files authentication, immutability policies, soft delete retention, replication tiers, SMB port/firewall configuration, endpoint selection for secure SMB access, and RBAC vs NTFS alignment.</p>
              <p><strong>Action:</strong> Prioritize flashcards and labs covering RBAC vs NTFS, Entra DS authentication, soft delete, immutable policies, replication, endpoints, firewall/SAS, and backup workflows.</p>
              <p><strong>Next Steps:</strong> Run labs on file recovery, replication, backup, and authentication. Review all Storage flashcards marked ⚠. Recommended labs: Configure Azure Files Auth & Recovery, Blob Storage Tiering & Snapshots (link + 25–30 min).</p>

              <p><strong>Compute (37% Accuracy) ⚠ Weak Spot</strong></p>
              <p><strong>Observation:</strong> Minor gaps in App Service runtimes, Azure Container Instances (ACI) scaling limitations, VM creation vs migration steps, and Bicep vs portal deployment differences.</p>
              <p><strong>Action:</strong> Review flashcards/labs on VM creation, migration, App Service deployment, and ACI scaling scenarios.</p>
              <p><strong>Next Steps:</strong> Run at least one VM/App Service lab; compare Bicep vs Portal deployment. Recommended labs: Deploy VM & App Service, VM Migration & Disk Snapshot Lab (link + 35–40 min).</p>

              <p><strong>Networking (58% Accuracy) ⚠ Weak Spot</strong></p>
              <p><strong>Observation:</strong> Solid foundational understanding, but review Load Balancer SKU differences, inbound NAT vs LB rules, subnet models (3‑tier architecture), NSG/UDR troubleshooting, and Azure DNS Private Zones for internal name resolution.</p>
              <p><strong>Action:</strong> Light review of flashcards and labs on virtual network configuration, routing, NSGs, peering, and load balancing.</p>
              <p><strong>Next Steps:</strong> Practice VNet and routing labs; reinforce IP forwarding and custom route scenarios. Recommended labs: Configure VNet, Subnets, NSGs, Load Balancer & NAT Rules Lab (link + 30–40 min).</p>

              <p><strong>Monitoring (54% Accuracy) ⚠ Minor Weak Spot</strong></p>
              <p><strong>Observation:</strong> Strong domain overall. Minor misses on metrics configuration, Log Analytics queries (KQL), and dashboards/alerts setup.</p>
              <p><strong>Action:</strong> Light review of metrics, logs, and workbooks flashcards; practice using Azure Monitor and Log Analytics queries.</p>
              <p><strong>Next Steps:</strong> Run labs on creating alerts, dashboards, and KQL queries; refresh understanding of monitoring configuration. Recommended labs: Create Alerts and Workbooks, KQL Basics & Log Analytics (link + 25–30 min).</p>

              <p><strong>Summary & Recommendations:</strong> Focus on Storage first (major weak spot), reinforce Identities next (🟠), then review Compute and Networking. Monitoring is solid; light refresher only. Use the confidence dropdowns to track mastery before the AZ‑104 exam.</p>
            </div>

            <div class="az104-tip">
              <i class="fas fa-star"></i>Focus on the "Storage" domain first, as
              it's identified as your major weak spot. Use the flashcards and
              labs below! Mark your confidence level for each item.
            </div>
          </div>
        </div>

        <!-- Confirmation modal (hidden) -->
        <div id="score-save-modal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:1500;align-items:center;justify-content:center">
          <div style="background:#fff;padding:18px;border-radius:8px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(0,0,0,0.25);">
            <h3 style="margin-top:0">Confirm save</h3>
            <p style="color:#333">Save will produce a downloadable HTML file with the current quiz scores embedded. Proceed?</p>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="score-save-cancel" style="background:#ccc;border:0;padding:8px 10px;border-radius:6px;cursor:pointer">Cancel</button>
              <button id="score-save-confirm" style="background:#27ae60;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer">Confirm & Save</button>
            </div>
          </div>
        </div>

  <!-- Flashcards/Labs Section -->
        <!-- Domain 1: Manage Azure Identities and Governance (Self-contained Focused Card) -->
        <div class="card" id="identities-focused-card">
          <input type="checkbox" id="domain1-toggle" class="card-toggle" />
          <label for="domain1-toggle" class="card-header snapshot-header">
            <h2>
              <i class="fas fa-user-shield"></i>Domain 1: Manage Azure
              Identities and Governance
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Entra Kerberos integration for
              Azure Files, Hybrid AD DS authentication, RBAC vs Share-Level
              permissions, User profile updates (Job Info blade), Group-based
              licensing & roles, Guest/B2B invites and external-to-internal
              conversion, SSPR methods per group, and Entra portal navigation
              awareness.<br />
              <span id="identities-quiz-stats" class="domain-quiz-stats"></span>
            </div>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> Group-based licensing & roles,
              Guest/B2B invites & conversions, Self-service password reset
              (methods & per-group targeting), Entra portal navigation, RBAC vs
              Entra DS distinctions.
              <br />
              <strong>Action:</strong> Drill into the following flashcards and
              labs to reinforce these topics.
            </p>
            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Identities)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#idgov-flash-1" data-highlight-id="idgov-flash-1"
                      >RBAC vs Entra ID/DS Permissions</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#idgov-lab-1" data-highlight-id="idgov-lab-1"
                      >Lab: Create Users, Groups, Assign Roles</a
                    >
                  </span>
                </div>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="idgov-flash-1-li">
                <input type="checkbox" id="idgov-flash-1" />
                <span class="item-text">RBAC vs Entra ID/DS Permissions</span>
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-1">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-user-shield"></i>RBAC vs Entra DS Permissions</h4>
                  <p><strong>Observation:</strong> RBAC controls access to Azure resources at subscription, resource group, or resource level. Entra DS controls OS/app-level identity and authentication (e.g., NTFS, LDAP/Kerberos for Azure Files).</p>
                  <p class="mnemonic-internal"><i class="fas fa-lightbulb"></i>Mnemonic: “RBAC = Azure Gatekeeper, Entra DS = Identity Librarian”</p>
                  <p><strong>Tip:</strong> Distinguish between resource-level access (RBAC) and file-level access (Entra DS).</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Commonly confused on quizzes — review scenarios carefully.</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-2-li">
                <input type="checkbox" id="idgov-flash-2" />
                <span class="item-text">Role Assignment CLI vs Portal</span>
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-2">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-terminal"></i>Role Assignment CLI vs Portal</h4>
                  <p><strong>Observation:</strong> Portal is GUI-based, suited for individual role assignments. CLI allows automation, bulk assignments, and integration into pipelines.</p>
                  <p><strong>Tip:</strong> Use CLI for repeatable scripts; Portal for quick manual assignments.</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-3-li">
                <input type="checkbox" id="idgov-flash-3" />
                <span class="item-text"
                  >RBAC vs Entra DS (AD DS) Deep Dive</span
                >
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-3">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-user-shield"></i>RBAC vs Entra DS (AD DS) Deep Dive</h4>
                  <p><strong>Observation:</strong> RBAC is stateless (ARM-managed) and focuses on who can manage Azure resources. Entra DS is stateful and controls identity/authentication at the OS/file level (e.g., NTFS permissions, Kerberos).</p>
                  <p><strong>Mnemonic:</strong> “RBAC = Azure Gatekeeper, Entra DS = Identity Librarian”</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Confusing resource-level vs file-level permissions — review example scenarios.</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-4-li">
                <input type="checkbox" id="idgov-flash-4" />
                <span class="item-text">CLI vs Microsoft Graph</span>
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-4">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-terminal"></i>CLI vs Microsoft Graph</h4>
                  <p><strong>Observation:</strong> CLI is procedural for Azure tasks; Microsoft Graph is the REST API for Microsoft 365/Entra ID automation.</p>
                  <p><strong>Mnemonic:</strong> “CLI = hammer, Graph = blueprint”</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-5-li">
                <input type="checkbox" id="idgov-flash-5" />
                <span class="item-text"
                  >RBAC Scope Levels (Sub, RG, Resource)</span
                >
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-5">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-sitemap"></i>RBAC Scope Levels (Sub, RG, Resource)</h4>
                  <p><strong>Observation:</strong> Role assignments apply at subscription, resource group, or resource level and are inherited down the scope. Assign least privilege at the lowest necessary scope.</p>
                  <p class="mnemonic-internal"><i class="fas fa-lightbulb"></i>Mnemonic: “Scope = Sub → Group → Resource (SGR)”</p>
                </div>
              </li>
              <li class="flashcard-item" id="idgov-flash-6-li">
                <input type="checkbox" id="idgov-flash-6" />
                <span class="item-text"
                  >Azure Files with Entra DS Authentication</span
                >
                <span class="item-tag">Identities</span>
                <select class="confidence-select" data-item-id="idgov-flash-6">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-key"></i>Azure Files with Entra DS Authentication</h4>
                  <p><strong>Observation:</strong> Combine Azure RBAC and NTFS permissions for secure access. Configure Kerberos for SMB and ensure users are domain members with appropriate permissions.</p>
                  <p class="mnemonic-internal"><i class="fas fa-lightbulb"></i>Mnemonic: “Azure Files Auth = Domain + Double Permissions”</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Frequently missed on quizzes — review the authentication setup steps.</p>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 2: Implement and Manage Storage (Self-contained Focused Card) -->
        <div class="card" id="storage-focused-card">
          <input type="checkbox" id="domain2-toggle" class="card-toggle" />
          <label for="domain2-toggle" class="card-header flashcard-header">
            <h2>
              <i class="fas fa-database"></i>Domain 2: Implement and Manage
              Storage
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Azure Files identity-based
              access, Soft Delete retention (365 days), Snapshots before
              deletion, Blob Versioning, Object replication prefix filters,
              Private Endpoints, TLS supported versions (1.0–1.2), SAS for
              temporary access, Customer-managed keys, Firewall restrictions
              with VNets, endpoint selection for secure SMB access<br />
              <span id="storage-quiz-stats" class="domain-quiz-stats"></span>
            </div>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> Azure Files auth, immutability,
              soft delete, replication tiers, SMB ports.<br />
              <strong>Action:</strong> Use the flashcards and labs below to
              reinforce your storage skills.
            </p>
            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Storage)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#storage-flash-1"
                      data-highlight-id="storage-flash-1"
                      >RBAC vs NTFS Permissions on Azure Files</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#storage-lab-1" data-highlight-id="storage-lab-1"
                      >Lab: Configure Azure Files Auth & Recovery</a
                    >
                  </span>
                </div>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="storage-flash-1-li">
                <input type="checkbox" id="storage-flash-1" />
                <span class="item-text"
                  >RBAC vs NTFS Permissions on Azure Files</span
                >
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-1"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-database"></i>RBAC vs NTFS Permissions on Azure Files</h4>
                  <p><strong>Observation:</strong> RBAC secures access at the Azure resource level; NTFS secures file system level inside Azure Files shares.</p>
                  <p><strong>Mnemonic:</strong> “RBAC = cloud access, NTFS = file access”</p>
                  <p style="color:#ff9800;font-weight:bold;">Weak Spot: Misalignment between RBAC and NTFS often causes quiz mistakes — review sequence and configuration steps.</p>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-2-li">
                <input type="checkbox" id="storage-flash-2" />
                <span class="item-text">Soft Delete vs Snapshot</span>
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-2"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-undo"></i>Azure Files Soft Delete & Snapshot Concepts</h4>
                  <p><strong>Observation:</strong> Soft delete retains deleted files for a configurable retention window; snapshots provide point-in-time copies for recovery and versioning.</p>
                  <p><strong>Tip:</strong> Use snapshots before major changes and configure retention to meet recovery objectives.</p>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-3-li">
                <input type="checkbox" id="storage-flash-3" />
                <span class="item-text"
                  >Replication Tiers (LRS, ZRS, GRS, RA-GRS)</span
                >
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-3"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-clone"></i>Replication Tiers (LRS, ZRS, GRS, RA-GRS)</h4>
                  <p><strong>Observation:</strong> LRS keeps copies in a single datacenter; ZRS across zones; GRS replicates to a secondary region; RA-GRS allows read access to secondary. Choose based on durability and RTO/RPO requirements.</p>
                  <p><strong>Tip:</strong> Balance cost vs business continuity needs when choosing replication.</p>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-4-li">
                <input type="checkbox" id="storage-flash-4" />
                <span class="item-text">SMB Ports for Azure Files</span>
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-4"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-plug"></i>SMB Ports for Azure Files</h4>
                  <ul>
                    <li>
                      <strong>Port 445</strong> is required for SMB protocol
                      (Windows file sharing).
                    </li>
                    <li>
                      Many ISPs block outbound 445 to Azure for security
                      reasons.
                    </li>
                    <li>
                      Solutions: Use VPN, ExpressRoute, or Private Endpoint to
                      connect from on-prem.
                    </li>
                    <li>SMB 3.0 required for Azure Files with encryption.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "SMB = 445 Alive"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-5-li">
                <input type="checkbox" id="storage-flash-5" />
                <span class="item-text"
                  >Azure Files Access in VNets (Endpoints & Firewalls)</span
                >
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-5"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-shield-alt"></i>Azure Files Access in VNets
                    (Endpoints & Firewalls)
                  </h4>
                  <ul>
                    <li>
                      Use <strong>private endpoints</strong> to map Azure Files
                      to a VNet (private IP, no public exposure).
                    </li>
                    <li>
                      <strong>Service endpoints</strong> allow secure traffic
                      from VNets to Azure Files over backbone.
                    </li>
                    <li>Firewall rules can restrict access by IP or subnet.</li>
                    <li>
                      For on-premises SMB access, use VPN or ExpressRoute to
                      allow port 445 traffic securely.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Endpoints = Entry
                    Points"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="storage-flash-6-li">
                <input type="checkbox" id="storage-flash-6" />
                <span class="item-text">Immutable Storage Policies (WORM)</span>
                <span class="item-tag">Storage</span>
                <select
                  class="confidence-select"
                  data-item-id="storage-flash-6"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-lock"></i>Immutable Storage Policies (WORM)
                  </h4>
                  <ul>
                    <li>
                      <strong>WORM</strong> = Write Once, Read Many. Data cannot
                      be modified or deleted during retention period.
                    </li>
                    <li>
                      Set <strong>immutability policy</strong> on a container:
                      <b>time-based retention</b> or <b>legal hold</b>.
                    </li>
                    <li>
                      <strong>Retention lock</strong> can be unlocked only in
                      compliance mode (strict) or governance mode (less strict).
                    </li>
                    <li>
                      Used for regulatory compliance, legal evidence, and audit
                      trails.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Immutable =
                    Written Once, Read Many"
                  </div>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 3: Deploy and Manage Azure Compute Resources (Self-contained Focused Card) -->
        <div class="card" id="compute-focused-card">
          <input type="checkbox" id="domain3-toggle" class="card-toggle" />
          <label for="domain3-toggle" class="card-header lab-header">
            <h2>
              <i class="fas fa-server"></i>Domain 3: Deploy and Manage Azure
              Compute Resources
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <span
              id="compute-quiz-stats"
              class="domain-quiz-stats"
              style="display: block; margin-bottom: 10px"
            ></span>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> App Service runtimes, ACI
              scaling, VM migration and deployment.<br />
              <strong>Action:</strong> Use the following flashcards and labs to
              reinforce compute management.
            </p>
            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Compute)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#compute-flash-1"
                      data-highlight-id="compute-flash-1"
                      >VM Creation vs Migration Steps</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#compute-lab-1" data-highlight-id="compute-lab-1"
                      >Lab: Deploy VM & App Service</a
                    >
                  </span>
                </div>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="compute-flash-1-li">
                <input type="checkbox" id="compute-flash-1" />
                <span class="item-text">VM Creation vs Migration Steps</span>
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-1"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-server"></i>VM Creation vs Migration</h4>
                  <ul>
                    <li>
                      <strong>Creation:</strong> New VM from image/template
                      (portal, CLI, ARM/Bicep).
                    </li>
                    <li>
                      <strong>Migration:</strong> Use Azure Migrate, import VHD,
                      or site recovery.
                    </li>
                    <li>
                      Migration involves assessment, compatibility check, and
                      network integration.
                    </li>
                  </ul>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-2-li">
                <input type="checkbox" id="compute-flash-2" />
                <span class="item-text">App Service Runtime Options</span>
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-2"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-code"></i>App Service Runtimes</h4>
                  <ul>
                    <li>
                      Supports .NET, Java, Node.js, Python, PHP, Ruby, and
                      custom containers.
                    </li>
                    <li>
                      Choose runtime stack during creation or update in
                      configuration.
                    </li>
                    <li>
                      Linux and Windows hosting plans available for different
                      runtimes.
                    </li>
                    <li>
                      App Service Plan determines scaling and backup options.
                    </li>
                    <li>Backups available on Standard tier and above.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "App Service =
                    Platform Playground"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-3-li">
                <input type="checkbox" id="compute-flash-3" />
                <span class="item-text">VM Migration Order & Encryption</span>
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-3"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-lock"></i>VM Migration & Encryption Steps
                  </h4>
                  <ul>
                    <li>Take a snapshot of the VM OS disk.</li>
                    <li>
                      Encrypt the snapshot or disk if required (Azure Disk
                      Encryption or SSE).
                    </li>
                    <li>
                      Move/copy the disk to destination region/resource group.
                    </li>
                    <li>
                      Create a new VM from the encrypted disk in the target
                      region.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Snapshot →
                    Encrypt → Move"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="compute-flash-4-li">
                <input type="checkbox" id="compute-flash-4" />
                <span class="item-text"
                  >Azure Container Instances (ACI) Scaling</span
                >
                <span class="item-tag">Compute</span>
                <select
                  class="confidence-select"
                  data-item-id="compute-flash-4"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-cube"></i>ACI Scaling Behavior</h4>
                  <ul>
                    <li>
                      ACI (Azure Container Instances) does
                      <strong>not</strong> support in-place scaling.
                    </li>
                    <li>
                      To scale, you must redeploy a new container group with the
                      desired instance count.
                    </li>
                    <li>
                      No built-in load balancer or auto-scaling. For scaling,
                      use AKS or orchestrators.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "ACI = Always
                    Create Instance"
                  </div>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 4: Configure and Manage Virtual Networking (Self-contained Focused Card) -->
        <div class="card" id="networking-focused-card">
          <input type="checkbox" id="domain4-toggle" class="card-toggle" />
          <label for="domain4-toggle" class="card-header snapshot-header">
            <h2>
              <i class="fas fa-network-wired"></i>Domain 4: Configure and Manage
              Virtual Networking
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Azure Storage Firewalls &
              VNets, restricting access to corporate IP ranges and VNets, Azure
              Files private endpoints vs service endpoints, on-prem SMB access
              over VPN/ExpressRoute<br />
              <span id="networking-quiz-stats" class="domain-quiz-stats"></span>
            </div>
            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> LB SKUs, NAT vs LB rules,
              subnets, routes, NSGs, peering, hub-spoke.<br />
              <strong>Action:</strong> Use these flashcards and labs to
              reinforce networking concepts.
            </p>
            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Networking)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#net-flash-1" data-highlight-id="net-flash-1"
                      >LB SKU Differences</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a href="#net-lab-1" data-highlight-id="net-lab-1"
                      >Lab: Configure VNet, Subnets, NSGs</a
                    >
                  </span>
                </div>
              </div>
            </div>
            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="net-flash-1-li">
                <input type="checkbox" id="net-flash-1" />
                <span class="item-text">LB SKU Differences</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-1">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-network-wired"></i>LB SKU Differences
                  </h4>
                  <ul>
                    <li>
                      <strong>Basic SKU:</strong> No zone redundancy, limited
                      features, public IP only, no diagnostics. Not recommended
                      for production.
                    </li>
                    <li>
                      <strong>Standard SKU:</strong> Zone redundant, supports
                      private IP, diagnostics, HA, secure by default. Required
                      for most production workloads.
                    </li>
                    <li>Standard is more flexible, secure, and scalable.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Basic = Bare,
                    Standard = Secure"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="net-flash-2-li">
                <input type="checkbox" id="net-flash-2" />
                <span class="item-text">NAT vs LB Rules</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-2">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-random"></i>NAT vs LB Rules</h4>
                  <ul>
                    <li>
                      <strong>LB Rule:</strong> Distributes incoming traffic to
                      all VMs in backend pool (many-to-many).
                    </li>
                    <li>
                      <strong>NAT Rule:</strong> Maps a specific external port
                      to a single VM (one-to-one), typically for management
                      (RDP/SSH).
                    </li>
                    <li>LB Rule = load balancing; NAT Rule = direct access.</li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "NAT = One-to-One,
                    LB = Many"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="net-flash-3-li">
                <input type="checkbox" id="net-flash-3" />
                <span class="item-text">3-Tier Subnet Design</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-3">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-layer-group"></i>3-Tier Subnet Design
                  </h4>
                  <ul>
                    <li>
                      Separate subnets for <strong>Web</strong>,
                      <strong>App</strong>, and <strong>DB</strong> layers.
                    </li>
                    <li>
                      Web subnet: public or DMZ, receives external traffic.
                    </li>
                    <li>
                      App subnet: private, only accessible from Web subnet or
                      internal.
                    </li>
                    <li>
                      DB subnet: most restricted, only accessible from App
                      subnet.
                    </li>
                    <li>
                      NSGs and route tables enforce isolation and security.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "W-A-D = Web App
                    Database"
                  </div>
                </div>
              </li>
              <li class="flashcard-item" id="net-flash-4-li">
                <input type="checkbox" id="net-flash-4" />
                <span class="item-text">Route Tables & Forced Tunneling</span>
                <span class="item-tag">Networking</span>
                <select class="confidence-select" data-item-id="net-flash-4">
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-route"></i>Route Tables & Forced Tunneling
                  </h4>
                  <ul>
                    <li>
                      <strong>User Defined Routes (UDRs)</strong> override
                      system routes for subnets.
                    </li>
                    <li>
                      <strong>Forced tunneling</strong>: Directs all outbound
                      internet traffic from a VNet to on-premises (via
                      VPN/ExpressRoute) by setting 0.0.0.0/0 next hop.
                    </li>
                    <li>
                      Default route (0.0.0.0/0) normally sends traffic to Azure
                      Internet; forced tunneling changes this to on-prem.
                    </li>
                    <li>
                      Used for compliance, monitoring, or security requirements.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Forced Tunnel =
                    Force All Traffic Home"
                  </div>
                </div>
              </li>
            </ul>
            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>

        <!-- Domain 5: Monitor and Maintain Azure Resources (Self-contained Focused Card) -->
        <!-- Domain 5: Monitor and Maintain Azure Resources -->
        <div class="card" id="monitoring-focused-card">
          <input type="checkbox" id="domain5-toggle" class="card-toggle" />
          <label for="domain5-toggle" class="card-header flashcard-header">
            <h2>
              <i class="fas fa-chart-line"></i>Domain 5: Monitor and Maintain
              Azure Resources
            </h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </label>
          <div class="card-content">
            <div
              class="quiz-focus-summary"
              style="
                background: #f4f4f6;
                border-radius: 7px;
                padding: 12px 18px;
                margin-bottom: 18px;
                border: 1px solid #e2e2e2;
              "
            >
              <strong>Recent Quiz Focus:</strong> Metrics & Alerts, Log
              Analytics queries, VM Insights, Dashboards, Workbooks, Recovery
              Vault backup and retention.<br />
              <span id="monitoring-quiz-stats" class="domain-quiz-stats"
                >(24/30 correct, 80%)</span
              >
            </div>

            <h3>
              <i class="fas fa-lightbulb"></i>Snapshot & Personalized Review
            </h3>
            <p>
              <strong>Weak Spot Focus:</strong> Metrics, Workbooks, Log
              Analytics, Dashboards, Alerts.<br />
              <strong>Action:</strong> Review these flashcards and labs to
              strengthen monitoring skills.
            </p>

            <div class="next-steps-tracker" style="margin-bottom: 18px">
              <h3 style="font-size: 1.1em">
                <i class="fas fa-arrow-circle-right"></i>Next Steps Tracker
                (Monitoring)
              </h3>
              <div class="tracker-section">
                <strong><i class="fas fa-book-open"></i>Next Flashcard:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#monitoring-flash-1"
                      data-highlight-id="monitoring-flash-1"
                      >Configuring Metrics & Alerts</a
                    >
                  </span>
                </div>
              </div>
              <div class="tracker-section">
                <strong><i class="fas fa-flask"></i>Next Lab:</strong>
                <div class="tracker-item">
                  <i class="fas fa-arrow-right"></i>
                  <span class="title">
                    <a
                      href="#monitoring-lab-1"
                      data-highlight-id="monitoring-lab-1"
                      >Lab: Create Dashboard & Alerts</a
                    >
                  </span>
                </div>
              </div>
            </div>

            <h3><i class="fas fa-book-open"></i>Flashcards</h3>
            <ul class="review-item-list">
              <li class="flashcard-item" id="monitoring-flash-1-li">
                <input type="checkbox" id="monitoring-flash-1" />
                <span class="item-text">Configuring Metrics & Alerts</span>
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-1"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4>
                    <i class="fas fa-chart-bar"></i>Metrics & Alerts Overview
                  </h4>
                  <ul>
                    <li>
                      Configure metrics in Azure Monitor for VMs, Storage, App
                      Service, etc.
                    </li>
                    <li>
                      Create alert rules for thresholds like CPU %, disk IOPS.
                    </li>
                    <li>Alerts can trigger emails, webhooks, or Logic Apps.</li>
                    <li>
                      <strong>Sequence:</strong> Navigate to Azure Monitor →
                      Metrics → Select resource → Pick metric → Add alert rule →
                      Define conditions → Assign action group → Review & create.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Metrics =
                    Measure, Alerts = Alarm"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-2-li">
                <input type="checkbox" id="monitoring-flash-2" />
                <span class="item-text">Log Analytics Query Basics</span>
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-2"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-terminal"></i>KQL Basics</h4>
                  <ul>
                    <li>Use Kusto Query Language (KQL) for querying logs.</li>
                    <li>
                      Example:
                      <code
                        >AzureActivity | summarize count() by
                        ActivityStatusValue</code
                      >
                    </li>
                    <li>Queries drive dashboards, alerts, and workbooks.</li>
                    <li>
                      <strong>Sequence:</strong> Navigate to Log Analytics →
                      Select workspace → Open Logs → Build query → Run → Pin to
                      dashboard / use in alert / integrate in workbook.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Logs = Stories,
                    KQL = Translator"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-3-li">
                <input type="checkbox" id="monitoring-flash-3" />
                <span class="item-text">VM Insights Layers</span>
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-3"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-server"></i>VM Insights</h4>
                  <ul>
                    <li>
                      Guest metrics: OS-level (CPU, memory, disk, network) via
                      agent.
                    </li>
                    <li>
                      Dependency map: Visualizes connections between VMs,
                      processes, and resources.
                    </li>
                    <li>Visualized in Azure Monitor/Insights.</li>
                    <li>
                      <strong>Sequence:</strong> Enable VM Insights → Configure
                      agent → Collect guest metrics → Analyze dependencies →
                      View charts and maps in Azure Monitor.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Insights = Inside
                    VM"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-4-li">
                <input type="checkbox" id="monitoring-flash-4" />
                <span class="item-text"
                  >Log Analytics vs Metrics vs Workbooks</span
                >
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-4"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-book"></i>Logs, Metrics, Workbooks</h4>
                  <ul>
                    <li>
                      Metrics: numeric, time-series data, used in charts and
                      alerts.
                    </li>
                    <li>
                      Logs: structured/unstructured events, queried with KQL.
                    </li>
                    <li>
                      Workbooks: interactive dashboards combining metrics, logs,
                      and visuals.
                    </li>
                    <li>
                      <strong>Sequence:</strong> Metrics → Monitor → Alerts;
                      Logs → Log Analytics → KQL query → Pin results; Workbooks
                      → New workbook → Add metrics/logs visuals → Save & share.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Metrics =
                    Numbers, Logs = Stories, Workbooks = Reports"
                  </div>
                </div>
              </li>

              <li class="flashcard-item" id="monitoring-flash-5-li">
                <input type="checkbox" id="monitoring-flash-5" />
                <span class="item-text"
                  >Recovery Vault: Backup & Retention</span
                >
                <span class="item-tag">Monitoring</span>
                <select
                  class="confidence-select"
                  data-item-id="monitoring-flash-5"
                >
                  <option value="none">Rate Confidence</option>
                  <option value="weak">Weak</option>
                  <option value="medium">Medium</option>
                  <option value="strong">Strong</option>
                </select>
                <div class="flashcard-content-area">
                  <h4><i class="fas fa-lock"></i>Recovery Vault</h4>
                  <ul>
                    <li>
                      Recovery Services Vault stores backups for VMs, files,
                      SQL, etc.
                    </li>
                    <li>
                      Backup policies define schedule (daily, weekly) and
                      retention.
                    </li>
                    <li>Supports instant restore and long-term retention.</li>
                    <li>
                      <strong>Sequence:</strong> Create Recovery Vault → Add
                      resource → Configure backup policy → Trigger backup →
                      Monitor jobs → Restore if needed.
                    </li>
                  </ul>
                  <div class="mnemonic-internal">
                    <i class="fas fa-lightbulb"></i>Mnemonic: "Vault = Safe for
                    Time Travel"
                  </div>
                </div>
              </li>
            </ul>

            <h3><i class="fas fa-flask"></i>Lab Tracker</h3>
            <ul class="review-item-list">
              <li class="lab-item"><span class="item-text"><strong>Mapped labs will appear here</strong></span></li>
            </ul>
          </div>
        </div>
  <!-- End Flashcards/Labs Section -->

  <!-- Flashcard expand/collapse handled by consolidated script -->
      </div>
    </div>
  <!-- Duplicate embedded JSON/scripts removed and consolidated earlier in file -->
    </script>
    <!-- Enhancement styles (modular, additive) -->
    <style>
      details.cli-ref-block, details.scenario-block, details.related-links-block, details.concept-interlinks-block {margin:12px 0;padding:10px 14px;border:1px solid #d9e2f3;border-radius:8px;background:#f9fbfd}
      details.cli-ref-block > summary, details.scenario-block > summary, details.related-links-block > summary, details.concept-interlinks-block > summary {cursor:pointer;font-weight:600;color:#005a9e;display:flex;align-items:center;gap:6px}
  /* Highlight for related flashcard jump */
  .related-flashcard-highlight {outline:2px solid #ffb800;background:#fff8dc !important;transition:outline 0.3s ease}
  /* Concept interlink badge */
  .concept-dot {display:inline-block;width:8px;height:8px;border-radius:50%;background:#8e44ad;margin-right:6px;vertical-align:middle}
  .concept-tag {background:#f3e9fb;color:#5b2c83;border:1px solid #e3d3f5;border-radius:10px;padding:2px 6px;margin-left:8px;font-size:12px}
      details.cli-ref-block pre {background:#0f172a;color:#e2e8f0;padding:10px 12px;border-radius:6px;overflow-x:auto;font-size:0.85em;line-height:1.35;position:relative}
      .cli-copy-btn {position:absolute;top:8px;right:8px;background:#27ae60;color:#fff;border:0;padding:4px 8px;border-radius:4px;font-size:0.7em;cursor:pointer;opacity:0.9;transition:0.2s}
      .cli-copy-btn:hover {opacity:1;background:#229954}
      .cli-copy-btn.copied {background:#3498db}
      .scenario-entry {margin:8px 0;padding:8px 10px;border-left:4px solid #ff9800;background:#fff;border-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,0.06)}
      .scenario-entry h5 {margin:0 0 6px;font-size:0.95em;color:#c0392b}
      .scenario-steps {margin:0;padding-left:18px;font-size:0.85em}
      .related-links-list {list-style:none;margin:6px 0 0;padding:0;display:flex;flex-wrap:wrap;gap:8px}
      .related-links-list a {background:#e6f2ff;border:1px solid #c5ddf5;padding:4px 8px;border-radius:4px;font-size:0.75em;text-decoration:none;color:#005a9e;transition:.18s}
      .related-links-list a:hover {background:#005a9e;color:#fff}
    </style>

    <!-- Reinforcement feature injection script -->
    <script>
      (function(){
        const cliReferences = {
          'idgov-flash-1': { cli: 'az role assignment list --assignee <user@domain.com>\naz role assignment create --assignee <user@domain.com> --role "Storage File Data SMB Share Contributor" --scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>', ps: 'Get-AzRoleAssignment -SignInName user@domain.com\nNew-AzRoleAssignment -SignInName user@domain.com -RoleDefinitionName "Storage File Data SMB Share Contributor" -Scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>' },
          'idgov-flash-2': { cli: 'az role assignment create --assignee <principalId> --role Reader --scope /subscriptions/<subId>', ps: 'New-AzRoleAssignment -ObjectId <principalId> -RoleDefinitionName Reader -Scope /subscriptions/<subId>' },
          'idgov-flash-4': { cli: 'az ad user list --filter "accountEnabled eq true"\n# Microsoft Graph example via REST:\nGET https://graph.microsoft.com/v1.0/users', ps: 'Get-MgUser -Filter "accountEnabled eq true"' },
          'idgov-flash-6': { cli: 'az storage share-rbac-assignment create --account-name <storageAcct> --share-name <fileshare> --group-id <AADGroupObjectId> --role "Storage File Data SMB Share Contributor"', ps: '# Azure Files Kerberos setup typically via portal + AD DS; sample PowerShell RBAC assignment:\nNew-AzRoleAssignment -ObjectId <AADGroupObjectId> -RoleDefinitionName "Storage File Data SMB Share Contributor" -Scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>' },
          'storage-flash-1': { cli: 'az storage account create -n <acct> -g <rg> --sku Standard_LRS --kind StorageV2\naz role assignment create --assignee <user@domain.com> --role "Storage File Data SMB Share Contributor" --scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>', ps: 'New-AzStorageAccount -Name <acct> -ResourceGroupName <rg> -SkuName Standard_LRS -Kind StorageV2\nNew-AzRoleAssignment -ObjectId <userObjectId> -RoleDefinitionName "Storage File Data SMB Share Contributor" -Scope /subscriptions/<subId>/resourceGroups/<rg>/providers/Microsoft.Storage/storageAccounts/<acct>' },
          'storage-flash-2': { cli: 'az storage account blob-service-properties update --account-name <acct> --enable-delete-retention true --delete-retention-days 30', ps: 'Set-AzStorageBlobServiceProperty -StorageAccountName <acct> -EnableDeleteRetention $true -DeleteRetentionDays 30' },
          'storage-flash-3': { cli: 'az storage account create -n <acct> -g <rg> --sku Standard_ZRS\n# Change replication (preview scenarios vary)', ps: '# Replication tier chosen at creation; cannot switch all tiers freely.' },
          'storage-flash-4': { cli: '# Port 445 testing (mac/Linux):\nnc -vz <storageAcct>.file.core.windows.net 445', ps: 'Test-NetConnection -ComputerName <storageAcct>.file.core.windows.net -Port 445' },
          'storage-flash-6': { cli: 'az storage container immutability-policy create --account-name <acct> -n <container> --period 30', ps: 'Set-AzStorageBlobImmutabilityPolicy -StorageAccountName <acct> -ContainerName <container> -ImmutabilityPeriod 30' },
          'compute-flash-1': { cli: 'az vm create -n <vmName> -g <rg> --image UbuntuLTS --size Standard_B2ms --admin-username azureuser --generate-ssh-keys', ps: 'New-AzVM -Name <vmName> -ResourceGroupName <rg> -Image UbuntuLTS -Size Standard_B2ms -Credential (Get-Credential)' },
          'compute-flash-4': { cli: 'az container create -n quickapp -g <rg> --image mcr.microsoft.com/azuredocs/aci-helloworld --cpu 2 --memory 4', ps: '# ACI PowerShell example:\nNew-AzContainerGroup -ResourceGroupName <rg> -Name quickapp -Image mcr.microsoft.com/azuredocs/aci-helloworld -OsType Linux -Cpu 2 -MemoryInGb 4' },
          'net-flash-1': { cli: 'az network lb create -g <rg> -n myStandardLb --sku Standard --public-ip-address myPublicIp', ps: 'New-AzLoadBalancer -ResourceGroupName <rg> -Name myStandardLb -Sku Standard -FrontendIpConfiguration @(...)' },
          'net-flash-2': { cli: 'az network lb inbound-nat-rule create -g <rg> --lb-name myStandardLb -n sshRule --protocol Tcp --frontend-port 22 --backend-port 22 --frontend-ip-name LoadBalancerFrontEnd --backend-pool-name MyPool', ps: 'Add-AzLoadBalancerInboundNatRuleConfig -Name sshRule -FrontendPort 22 -BackendPort 22 ...' },
          'net-flash-4': { cli: 'az network route-table route add --address-prefix 0.0.0.0/0 --next-hop-type VirtualAppliance --route-table-name forceAll --name forceTunnel --next-hop-ip-address <onPremFirewallIP>', ps: 'Add-AzRouteConfig -Name forceTunnel -AddressPrefix 0.0.0.0/0 -NextHopType VirtualAppliance -NextHopIpAddress <onPremFirewallIP> -RouteTable forceAll' },
          'monitoring-flash-1': { cli: 'az monitor metrics list --resource <resId> --metric "Percentage CPU"\naz monitor alert create -n cpuAlert -g <rg> --scopes <resId> --condition "avg Percentage CPU > 80" --action-group <agId>', ps: 'Get-AzMetric -ResourceId <resId> -MetricName "Percentage CPU"\nNew-AzScheduledQueryRule ...' },
          'monitoring-flash-2': { cli: 'az monitor log-analytics query -w <workspaceId> --analytics-query "AzureActivity | summarize count() by ActivityStatusValue"', ps: 'Invoke-AzOperationalInsightsQuery -WorkspaceId <workspaceId> -Query "AzureActivity | summarize count() by ActivityStatusValue"' },
          'monitoring-flash-5': { cli: 'az backup protection enable-for-vm -g <rg> -v <vmName> -rsv <vaultName> --policy-name DailyPolicy', ps: 'Enable-AzRecoveryServicesBackupProtection -ResourceGroupName <rg> -VaultId <vaultId> -Policy $policy -Name <vmName>' }
        };

        const domainMap = {
          'identities-focused-card': {
            name: 'Identities', related: ['storage-flash-1','storage-flash-2','net-flash-2','compute-flash-1']
          },
          'storage-focused-card': {
            name: 'Storage', related: ['idgov-flash-6','net-flash-1','monitoring-flash-1']
          },
            'compute-focused-card': {
            name: 'Compute', related: ['net-flash-1','monitoring-flash-1','storage-flash-3']
          },
          'networking-focused-card': {
            name: 'Networking', related: ['storage-flash-5','compute-flash-4','monitoring-flash-2']
          },
          'monitoring-focused-card': {
            name: 'Monitoring', related: ['net-flash-4','compute-flash-3','storage-flash-2']
          }
        };

        const scenarioData = {
          global: [
            { title: 'Incident: Unauthorized Storage Access Spike', steps: [
              'Azure Monitor alert fires: anomalous reads on a storage account.',
              'Check recent RBAC changes (Identities domain).',
              'Validate firewall + private endpoint configuration (Networking + Storage).',
              'Run CLI to list active role assignments and narrow suspect principals.',
              'Apply mitigation: remove excess role assignment, tighten NTFS + RBAC alignment.'
            ] },
            { title: 'Scenario: VM Migration Performance Lag', steps: [
              'During VM migration, performance degraded.',
              'Review Disk snapshot + encryption sequence (Compute).',
              'Check network forced tunneling route impact (Networking).',
              'Monitor CPU/memory metrics & set temporary alert (Monitoring).'
            ] }
          ],
          'identities-focused-card': [
            { title: 'Guest User Conversion Flow', steps: [ 'External guest requires elevated file share access.', 'Review RBAC vs Entra DS permission layering.', 'Convert guest to member, assign storage role, test SMB access using Kerberos.' ] }
          ],
          'storage-focused-card': [
            { title: 'Recover Deleted File Share', steps: [ 'Soft delete retention still active.', 'List deleted shares via CLI.', 'Restore; verify NTFS & RBAC alignment.', 'Set snapshot before critical bulk permission change.' ] }
          ],
          'compute-focused-card': [
            { title: 'Redeploy ACI Under Load', steps: [ 'Traffic spike requires scaling.', 'ACI no in-place scale → plan redeploy bigger group.', 'Evaluate switch to AKS for orchestrated scaling.', 'Document decision in workbook (Monitoring).' ] }
          ],
          'networking-focused-card': [
            { title: 'Forced Tunneling Misconfiguration', steps: [ 'Users report outbound slowness.', 'Inspect UDR default route 0.0.0.0/0.', 'Validate next hop firewall availability.', 'Adjust route or add exception for Azure services.' ] }
          ],
          'monitoring-focused-card': [
            { title: 'Alert Noise Reduction', steps: [ 'Too many CPU alerts across VM fleet.', 'Aggregate via metrics chart.', 'Adjust threshold & evaluation period.', 'Add workbook combining CPU + Disk IO trends.' ] }
          ]
        };

        function injectCliRefs(){
          document.querySelectorAll('.flashcard-item').forEach(item => {
            const id = item.querySelector('input[type=checkbox]')?.id;
            if(!id || !cliReferences[id]) return;
            const area = item.querySelector('.flashcard-content-area');
            if(!area) return;
            // prevent duplicate injection
            if(area.querySelector('details.cli-ref-block')) return;
            const details = document.createElement('details');
            details.className = 'cli-ref-block';
            const summary = document.createElement('summary');
            summary.textContent = '💻 CLI / PowerShell Reference';
            const pre = document.createElement('pre');
            pre.textContent = 'CLI:\n' + cliReferences[id].cli + '\n\nPowerShell:\n' + cliReferences[id].ps;
            // Add copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'cli-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = function(e){
              e.preventDefault();
              e.stopPropagation();
              try {
                navigator.clipboard.writeText(pre.textContent).then(() => {
                  copyBtn.textContent = 'Copied!';
                  copyBtn.classList.add('copied');
                  setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                    copyBtn.classList.remove('copied');
                  }, 2000);
                }).catch(() => {
                  copyBtn.textContent = 'Failed';
                  setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                });
              } catch(err) {
                copyBtn.textContent = 'Not supported';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
              }
            };
            pre.appendChild(copyBtn);
            details.appendChild(summary); details.appendChild(pre);
            area.appendChild(details);
          });
        }

        function buildRelatedLinks(){
          Object.entries(domainMap).forEach(([cardId, meta]) => {
            const card = document.getElementById(cardId);
            if(!card) return;
            const flashList = card.querySelector('ul.review-item-list');
            if(!flashList) return;
            // Insert before the Lab Tracker header (find the first h3 following flashcards list that contains 'Lab Tracker')
            const labHeader = Array.from(card.querySelectorAll('h3')).find(h => /Lab Tracker/i.test(h.textContent));
            if(!labHeader || labHeader.previousElementSibling?.classList.contains('related-links-block')) return;
            const wrapper = document.createElement('details');
            wrapper.className = 'related-links-block';
            const summary = document.createElement('summary');
            summary.textContent = '🧩 Related Flashcards (' + meta.name + ')';
            const ul = document.createElement('ul'); ul.className='related-links-list';
            meta.related.forEach(refId => {
              const li = document.createElement('li');
              const a = document.createElement('a');
              // Anchor to the actual list item element (e.g., #compute-flash-1-li) so the whole card row is visible
              a.href = '#' + refId + '-li';
              // Resolve actual flashcard title from the referenced item's .item-text
              const refItem = document.querySelector('#' + refId + '-li .item-text');
              a.textContent = refItem ? refItem.textContent.trim() : refId.replace(/-.+?-flash-?/,'').replace(/-/g,' ').trim();
              // Add a click enhancer: briefly highlight the destination list item
              a.addEventListener('click', (e) => {
                const targetId = refId + '-li';
                // Delay to allow default hash navigation to complete
                setTimeout(() => {
                  const dest = document.getElementById(targetId);
                  if(dest){
                    dest.classList.add('related-flashcard-highlight');
                    dest.scrollIntoView({behavior:'smooth', block:'center'});
                    setTimeout(()=>dest.classList.remove('related-flashcard-highlight'), 1600);
                  }
                }, 50);
              });
              li.appendChild(a); ul.appendChild(li);
            });
            wrapper.appendChild(summary); wrapper.appendChild(ul);
            labHeader.parentNode.insertBefore(wrapper, labHeader);
          });
        }

        function injectScenarios(){
          // Global block after snapshot card (insert at top of card-container after first card)
          const container = document.querySelector('.card-container');
            const firstCard = container?.querySelector('.card');
          if(container && firstCard && !document.getElementById('global-scenarios-block')){
            const globalCard = document.createElement('details');
            globalCard.className='scenario-block';
            globalCard.id='global-scenarios-block';
            const summary=document.createElement('summary'); summary.textContent='🧪 Scenario Drill Mode (Global)';
            globalCard.appendChild(summary);
            scenarioData.global.forEach(sc => {
              const div=document.createElement('div'); div.className='scenario-entry';
              const h5=document.createElement('h5'); h5.textContent=sc.title; div.appendChild(h5);
              const ol=document.createElement('ol'); ol.className='scenario-steps';
              sc.steps.forEach(s => { const li=document.createElement('li'); li.textContent=s; ol.appendChild(li); });
              div.appendChild(ol); globalCard.appendChild(div);
            });
            // Make the global scenarios block open by default so changes are visible immediately
            try { globalCard.open = true; } catch(e) {}
            container.insertBefore(globalCard, firstCard.nextSibling);
          }
          // Per-domain blocks
          Object.keys(domainMap).forEach(cardId => {
            const card = document.getElementById(cardId);
            if(!card) return;
            if(card.querySelector('details.scenario-block')) return;
            const tracker = card.querySelector('.next-steps-tracker');
            const scenarios = scenarioData[cardId];
            if(!tracker || !scenarios) return;
            const details=document.createElement('details'); details.className='scenario-block';
            const summary=document.createElement('summary'); summary.textContent='🧪 Scenario Drill Mode (' + domainMap[cardId].name + ')';
            details.appendChild(summary);
            scenarios.forEach(sc => {
              const div=document.createElement('div'); div.className='scenario-entry';
              const h5=document.createElement('h5'); h5.textContent=sc.title; div.appendChild(h5);
              const ol=document.createElement('ol'); ol.className='scenario-steps';
              sc.steps.forEach(s => { const li=document.createElement('li'); li.textContent=s; ol.appendChild(li); });
              div.appendChild(ol); details.appendChild(div);
            });
            tracker.insertAdjacentElement('afterend', details);
          });
        }

        function buildConceptInterlinks(){
          // Map concept slugs to flashcard checkbox IDs (without -li suffix)
          const conceptMap = {
            'rbac-vs-entra-ds': ['idgov-flash-1','idgov-flash-3','storage-flash-1','storage-flash-5'],
            'rbac-vs-ntfs': ['storage-flash-1','storage-flash-5','idgov-flash-1'],
            'load-balancer-skus': ['net-flash-1','net-flash-3','compute-flash-4'],
            'app-service-scaling': ['compute-flash-4','compute-flash-2','monitoring-flash-1'],
            'private-vs-service-endpoints': ['storage-flash-5','net-flash-2','storage-flash-2']
          };
          // Human-readable titles for concept headings
          const conceptTitles = {
            'rbac-vs-entra-ds': 'RBAC vs Entra DS / Directory Permissions',
            'rbac-vs-ntfs': 'RBAC vs NTFS Alignment (Azure Files)',
            'load-balancer-skus': 'Load Balancer SKU Differences',
            'app-service-scaling': 'App Service Scaling & Runtime Patterns',
            'private-vs-service-endpoints': 'Private Endpoints vs Service Endpoints'
          };
          // Reverse index: which concepts each flashcard participates in
          const reverseIndex = {};
          Object.entries(conceptMap).forEach(([slug, ids]) => {
            ids.forEach(id => {
              reverseIndex[id] = reverseIndex[id] || [];
              reverseIndex[id].push(slug);
            });
          });
          // Tag flashcards with concept slugs (data attributes, plus a small badge)
          Object.entries(reverseIndex).forEach(([flashId, slugs]) => {
            const li = document.getElementById(flashId + '-li');
            if(!li) return;
            li.dataset.concepts = slugs.join(',');
            // Append inline concept tags inside content area header if available
            const contentArea = li.querySelector('.flashcard-content-area h4');
            if(contentArea){
              slugs.forEach((slug, idx) => {
                const span = document.createElement('span');
                span.className='concept-tag';
                span.textContent = conceptTitles[slug] ? conceptTitles[slug].split(/\s+/).slice(0,3).join(' ') + (conceptTitles[slug].length>25?'…':'') : slug;
                span.title = conceptTitles[slug] || slug;
                contentArea.appendChild(span);
              });
            }
          });
          // Inject a Concept Interlinks block into each domain card before Lab Tracker header
          Object.keys(domainMap).forEach(cardId => {
            const card = document.getElementById(cardId);
            if(!card) return;
            if(card.querySelector('details.concept-interlinks-block')) return;
            const labHeader = Array.from(card.querySelectorAll('h3')).find(h => /Lab Tracker/i.test(h.textContent));
            if(!labHeader) return;
            // Collect all flashcards in this card and aggregate their concept slugs
            const flashItems = Array.from(card.querySelectorAll('li.flashcard-item'));
            const conceptUsage = {};
            flashItems.forEach(li => {
              const c = li.dataset.concepts?.split(',').filter(Boolean) || [];
              c.forEach(slug => { conceptUsage[slug] = conceptUsage[slug] || new Set(); conceptUsage[slug].add(li.id.replace(/-li$/,'')); });
            });
            if(Object.keys(conceptUsage).length === 0) return; // nothing relevant
            const details = document.createElement('details'); details.className='concept-interlinks-block';
            const summary = document.createElement('summary'); summary.textContent='🔗 Concept Interlinks (' + domainMap[cardId].name + ')';
            details.appendChild(summary);
            const list = document.createElement('ul'); list.style.listStyle='none'; list.style.margin='6px 0 0'; list.style.padding='0';
            Object.entries(conceptUsage).forEach(([slug, idSet]) => {
              const li = document.createElement('li'); li.style.margin='4px 0';
              const dot = document.createElement('span'); dot.className='concept-dot'; li.appendChild(dot);
              const title = document.createElement('strong'); title.textContent = conceptTitles[slug] || slug; li.appendChild(title);
              // Links row
              const linksSpan = document.createElement('span'); linksSpan.style.marginLeft='8px';
              Array.from(idSet).forEach(fid => {
                const a = document.createElement('a');
                a.href = '#' + fid + '-li';
                a.style.marginRight='6px'; a.style.fontSize='0.75em';
                const refItem = document.querySelector('#' + fid + '-li .item-text');
                a.textContent = refItem ? refItem.textContent.trim() : fid;
                a.addEventListener('click', (e) => {
                  setTimeout(()=>{
                    const dest = document.getElementById(fid + '-li');
                    if(dest){
                      dest.classList.add('related-flashcard-highlight');
                      dest.scrollIntoView({behavior:'smooth', block:'center'});
                      setTimeout(()=>dest.classList.remove('related-flashcard-highlight'),1600);
                    }
                  },50);
                });
                linksSpan.appendChild(a);
              });
              li.appendChild(linksSpan); list.appendChild(li);
            });
            details.appendChild(list);
            labHeader.parentNode.insertBefore(details, labHeader);
          });
        }

        function initReinforcement(){
          try{ injectCliRefs(); }catch(e){}
          try{ buildRelatedLinks(); }catch(e){}
          try{ injectScenarios(); }catch(e){}
          try{ buildConceptInterlinks(); }catch(e){}
        }

        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', initReinforcement);
        } else { initReinforcement(); }
      })();
    </script>
  </body>
</html>
